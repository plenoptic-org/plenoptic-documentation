

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>plenoptic.tools.display &mdash; plenoptic 1.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/plot_directive.css" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=292eb321"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

<div style="background-color: rgb(248, 215, 218); color: rgb(114, 28, 36); text-align: center;">
  <div>
    <div>This is documentation for <strong>an old version</strong>.
      <a href="https://docs.plenoptic.org/" style="background-color: rgb(220, 53, 69); color: rgb(255, 255, 255); margin: 1rem; padding: 0.375rem 0.75rem; border-radius: 4px; display: inline-block; text-align: center;">Switch to stable version</a>
    </div>
  </div>
</div>
 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            plenoptic
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Basic concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../conceptual_intro.html">Conceptual Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../models.html">Model requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/00_quickstart.html">Quickstart</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Synthesis method introductions</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/intro/02_Eigendistortions.html">Eigendistortions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/intro/05_Geodesics.html">Representational Geodesic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/intro/06_Metamer.html">Metamers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/intro/07_Simple_MAD.html">MAD Competition Conceptual Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/intro/08_MAD_Competition.html">MAD Competition Usage</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Models and metrics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/models/03_Steerable_Pyramid.html">Steerable Pyramid</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/models/04_Perceptual_distance.html">Perceptual distance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/models/Metamer-Portilla-Simoncelli.html">Portilla-Simoncelli Texture Metamer</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Synthesis method examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/applications/09_Original_MAD.html">Reproducing Wang and Simoncelli, 2008 (MAD Competition)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/applications/Demo_Eigendistortion.html">Reproducing Berardino et al., 2017 (Eigendistortions)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Advanced usage</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../synthesis.html">Synthesis object design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tips.html">Tips and Tricks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reproducibility.html">Reproducibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/modules.html">Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/advanced/Display.html">Display and animate functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/advanced/Synthesis_extensions.html">Extending existing synthesis objects</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">plenoptic</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">plenoptic.tools.display</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for plenoptic.tools.display</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;various helpful utilities for plotting or displaying information</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pyrtools</span> <span class="k">as</span> <span class="nn">pt</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">.data</span> <span class="kn">import</span> <span class="n">to_numpy</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">HTML</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Unable to import IPython.display.HTML&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="imshow">
<a class="viewcode-back" href="../../../api/plenoptic.tools.html#plenoptic.tools.display.imshow">[docs]</a>
<span class="k">def</span> <span class="nf">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">vrange</span><span class="o">=</span><span class="s1">&#39;indep1&#39;</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">col_wrap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
           <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_complex</span><span class="o">=</span><span class="s1">&#39;rectangular&#39;</span><span class="p">,</span> <span class="n">batch_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
           <span class="n">channel_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">as_rgb</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Show image(s) correctly.</span>

<span class="sd">    This function shows images correctly, making sure that each element in the</span>
<span class="sd">    tensor corresponds to a pixel or an integer number of pixels, to avoid</span>
<span class="sd">    aliasing (NOTE: this guarantee only holds for the saved image; it should</span>
<span class="sd">    generally hold in notebooks as well, but will fail if, e.g., you plot an</span>
<span class="sd">    image that&#39;s 2000 pixels wide on an monitor 1000 pixels wide; the notebook</span>
<span class="sd">    handles the rescaling in a way we can&#39;t control).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image : torch.Tensor or list</span>
<span class="sd">        The images to display. Tensors should be 4d (batch, channel, height,</span>
<span class="sd">        width). List of tensors should be used for tensors of different height</span>
<span class="sd">        and width: all images will automatically be rescaled so they&#39;re</span>
<span class="sd">        displayed at the same height and width, thus, their heights and widths</span>
<span class="sd">        must be scalar multiples of each other.</span>
<span class="sd">    vrange : `tuple` or `str`</span>
<span class="sd">        If a 2-tuple, specifies the image values vmin/vmax that are mapped to</span>
<span class="sd">        the minimum and maximum value of the colormap, respectively. If a</span>
<span class="sd">        string:</span>

<span class="sd">        * `&#39;auto0&#39;`: all images have same vmin/vmax, which have the same absolute</span>
<span class="sd">                     value, and come from the minimum or maximum across all</span>
<span class="sd">                     images, whichever has the larger absolute value</span>
<span class="sd">        * `&#39;auto/auto1&#39;`: all images have same vmin/vmax, which are the</span>
<span class="sd">                          minimum/maximum values across all images</span>
<span class="sd">        * `&#39;auto2&#39;`: all images have same vmin/vmax, which are the mean (across</span>
<span class="sd">                     all images) minus/ plus 2 std dev (across all images)</span>
<span class="sd">        * `&#39;auto3&#39;`: all images have same vmin/vmax, chosen so as to map the</span>
<span class="sd">                     10th/90th percentile values to the 10th/90th percentile of</span>
<span class="sd">                     the display intensity range. For example: vmin is the 10th</span>
<span class="sd">                     percentile image value minus 1/8 times the difference</span>
<span class="sd">                     between the 90th and 10th percentile</span>
<span class="sd">        * `&#39;indep0&#39;`: each image has an independent vmin/vmax, which have the</span>
<span class="sd">                      same absolute value, which comes from either their</span>
<span class="sd">                      minimum or maximum value, whichever has the larger</span>
<span class="sd">                      absolute value.</span>
<span class="sd">        * `&#39;indep1&#39;`: each image has an independent vmin/vmax, which are their</span>
<span class="sd">                      minimum/maximum values</span>
<span class="sd">        * `&#39;indep2&#39;`: each image has an independent vmin/vmax, which is their</span>
<span class="sd">                      mean minus/plus 2 std dev</span>
<span class="sd">        * `&#39;indep3&#39;`: each image has an independent vmin/vmax, chosen so that</span>
<span class="sd">                      the 10th/90th percentile values map to the 10th/90th</span>
<span class="sd">                      percentile intensities.</span>
<span class="sd">    zoom : `float` or `None`</span>
<span class="sd">        ratio of display pixels to image pixels. if &gt;1, must be an integer. If</span>
<span class="sd">        &lt;1, must be 1/d where d is a a divisor of the size of the largest</span>
<span class="sd">        image. If None, we try to determine the best zoom.</span>
<span class="sd">    title : `str`, `list`, or None, optional</span>
<span class="sd">        Title for the plot. In addition to the specified title, we add a</span>
<span class="sd">        subtitle giving the plotted range and dimensionality (with zoom)</span>
<span class="sd">        * if `str`, will put the same title on every plot.</span>
<span class="sd">        * if `list`, all values must be `str`, must be the same length as img,</span>
<span class="sd">          assigning each title to corresponding image.</span>
<span class="sd">        * if None, no title will be printed (and subtitle will be removed).</span>
<span class="sd">    col_wrap : `int` or None, optional</span>
<span class="sd">        number of axes to have in each row. If None, will fit all axes in a</span>
<span class="sd">        single row.</span>
<span class="sd">    ax : `matplotlib.pyplot.axis` or None, optional</span>
<span class="sd">        if None, we make the appropriate figure. otherwise, we resize the axes</span>
<span class="sd">        so that it&#39;s the appropriate number of pixels (done by shrinking the</span>
<span class="sd">        bbox - if the bbox is already too small, this will throw an Exception!,</span>
<span class="sd">        so first define a large enough figure using either make_figure or</span>
<span class="sd">        plt.figure)</span>
<span class="sd">    cmap : matplotlib colormap, optional</span>
<span class="sd">        colormap to use when showing these images</span>
<span class="sd">    plot_complex : {&#39;rectangular&#39;, &#39;polar&#39;, &#39;logpolar&#39;}</span>
<span class="sd">        specifies handling of complex values.</span>

<span class="sd">        * `&#39;rectangular&#39;`: plot real and imaginary components as separate images</span>
<span class="sd">        * `&#39;polar&#39;`: plot amplitude and phase as separate images</span>
<span class="sd">        * `&#39;logpolar&#39;`: plot log_2 amplitude and phase as separate images</span>
<span class="sd">        for any other value, we raise a warning and default to rectangular.</span>
<span class="sd">    batch_idx : int or None, optional</span>
<span class="sd">        Which element from the batch dimension to plot. If None, we plot all.</span>
<span class="sd">    channel_idx : int or None, optional</span>
<span class="sd">        Which element from the channel dimension to plot. If None, we plot all.</span>
<span class="sd">        Note if this is an int, then `as_rgb=True` will fail, because we</span>
<span class="sd">        restrict the channels.</span>
<span class="sd">    as_rgb : bool, optional</span>
<span class="sd">        Whether to consider the channels as encoding RGB(A) values. If True, we</span>
<span class="sd">        attempt to plot the image in color, so your tensor must have 3 (or 4 if</span>
<span class="sd">        you want the alpha channel) elements in the channel dimension, or this</span>
<span class="sd">        will raise an Exception. If False, we plot each channel as a separate</span>
<span class="sd">        grayscale image.</span>
<span class="sd">    kwargs :</span>
<span class="sd">        Passed to `ax.imshow`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig : `PyrFigure`</span>
<span class="sd">        figure containing the plotted images</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">image</span> <span class="o">=</span> <span class="p">[</span><span class="n">image</span><span class="p">]</span>
    <span class="n">images_to_plot</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">heights</span><span class="p">,</span> <span class="n">widths</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">image</span><span class="p">:</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">to_numpy</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">batch_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># this preserves the number of dimensions</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">batch_idx</span><span class="p">:</span><span class="n">batch_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">channel_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># this preserves the number of dimensions</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="p">[:,</span> <span class="n">channel_idx</span><span class="p">:</span><span class="n">channel_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># allow RGB and RGBA</span>
        <span class="k">if</span> <span class="n">as_rgb</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;If as_rgb is True, then channel must have 3 &quot;</span>
                                <span class="s2">&quot;or 4 elements!&quot;</span><span class="p">)</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="c1"># want to insert a fake &quot;channel&quot; dimension here, so our putting it</span>
            <span class="c1"># into a list below works as expected</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
        <span class="k">elif</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Don&#39;t know how to plot images with more than one channel and batch!&quot;</span>
                            <span class="s2">&quot; Use batch_idx / channel_idx to choose a subset for plotting&quot;</span><span class="p">)</span>
        <span class="c1"># by iterating through it twice, we make sure to peel apart the batch</span>
        <span class="c1"># and channel dimensions so that they each show up as a separate image.</span>
        <span class="c1"># because of how we&#39;ve handled everything above, we know that im will</span>
        <span class="c1"># be (b,c,h,w) or (b,c,h,w,r) where r is the RGB(A) values</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">im</span><span class="p">:</span>
            <span class="c1"># at this point, i_ are all shape (h,w) or (h,w,r) and so we don&#39;t</span>
            <span class="c1"># squeeze, which could accidentally drop a dimension if h or w is a</span>
            <span class="c1"># singleton dimension</span>
            <span class="n">images_to_plot</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">i_</span> <span class="k">for</span> <span class="n">i_</span> <span class="ow">in</span> <span class="n">i</span><span class="p">])</span>
            <span class="n">heights</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">i_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i_</span> <span class="ow">in</span> <span class="n">i</span><span class="p">])</span>
            <span class="n">widths</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">i_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i_</span> <span class="ow">in</span> <span class="n">i</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">find_zoom</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find zoom that works. This is only for limit &lt; x.&quot;&quot;&quot;</span>
        <span class="c1"># find all non-trivial divisors of x</span>
        <span class="n">divisors</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span> <span class="o">%</span> <span class="n">i</span><span class="p">]</span>
        <span class="c1"># find the largest zoom (equivalently, smallest divisor) such that the</span>
        <span class="c1"># zoomed in image is smaller than the limit</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="nb">min</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">divisors</span> <span class="k">if</span> <span class="n">x</span><span class="o">/</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="n">limit</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">zoom</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ax</span><span class="o">.</span><span class="n">bbox</span><span class="o">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="nb">max</span><span class="p">(</span><span class="n">heights</span><span class="p">):</span>
            <span class="n">zoom</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">bbox</span><span class="o">.</span><span class="n">height</span> <span class="o">//</span> <span class="nb">max</span><span class="p">(</span><span class="n">heights</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">zoom</span> <span class="o">=</span> <span class="n">find_zoom</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">heights</span><span class="p">),</span> <span class="n">ax</span><span class="o">.</span><span class="n">bbox</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ax</span><span class="o">.</span><span class="n">bbox</span><span class="o">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="nb">max</span><span class="p">(</span><span class="n">widths</span><span class="p">):</span>
            <span class="n">zoom</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">zoom</span><span class="p">,</span> <span class="n">ax</span><span class="o">.</span><span class="n">bbox</span><span class="o">.</span><span class="n">width</span> <span class="o">//</span> <span class="nb">max</span><span class="p">(</span><span class="n">widths</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">zoom</span> <span class="o">=</span> <span class="n">find_zoom</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">widths</span><span class="p">),</span> <span class="n">ax</span><span class="o">.</span><span class="n">bbox</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">zoom</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">zoom</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">pt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">images_to_plot</span><span class="p">,</span> <span class="n">vrange</span><span class="o">=</span><span class="n">vrange</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="n">zoom</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
                     <span class="n">col_wrap</span><span class="o">=</span><span class="n">col_wrap</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">plot_complex</span><span class="o">=</span><span class="n">plot_complex</span><span class="p">,</span>
                     <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>



<div class="viewcode-block" id="animshow">
<a class="viewcode-back" href="../../../api/plenoptic.tools.html#plenoptic.tools.display.animshow">[docs]</a>
<span class="k">def</span> <span class="nf">animshow</span><span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="n">framerate</span><span class="o">=</span><span class="mf">2.</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">vrange</span><span class="o">=</span><span class="s1">&#39;indep1&#39;</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
             <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">col_wrap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">plot_complex</span><span class="o">=</span><span class="s1">&#39;rectangular&#39;</span><span class="p">,</span> <span class="n">batch_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">channel_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">as_rgb</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Animate video(s) correctly.</span>

<span class="sd">    This function animates videos correctly, making sure that each element in</span>
<span class="sd">    the tensor corresponds to a pixel or an integer number of pixels, to avoid</span>
<span class="sd">    aliasing (NOTE: this guarantee only holds for the saved animation (assuming</span>
<span class="sd">    video compression doesn&#39;t interfere); it should generally hold in notebooks</span>
<span class="sd">    as well, but will fail if, e.g., your video is 2000 pixels wide on an</span>
<span class="sd">    monitor 1000 pixels wide; the notebook handles the rescaling in a way we</span>
<span class="sd">    can&#39;t control).</span>

<span class="sd">    This functions returns the matplotlib FuncAnimation object. In order to</span>
<span class="sd">    view it in a Jupyter notebook, use the</span>
<span class="sd">    ``plenoptic.convert_anim_to_html(anim)`` function. In order to save, use</span>
<span class="sd">    ``anim.save(filename)`` (note for this that you&#39;ll need the appropriate</span>
<span class="sd">    writer installed and on your path, e.g., ffmpeg, imagemagick, etc).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    video : torch.Tensor or list</span>
<span class="sd">        The videos to display. Tensors should be 5d (batch, channel, time,</span>
<span class="sd">        height, width). List of tensors should be used for tensors of different</span>
<span class="sd">        height and width: all videos will automatically be rescaled so they&#39;re</span>
<span class="sd">        displayed at the same height and width, thus, their heights and widths</span>
<span class="sd">        must be scalar multiples of each other. Videos must all have the same</span>
<span class="sd">        number of frames as well.</span>
<span class="sd">    framerate : `float`</span>
<span class="sd">        Temporal resolution of the video, in Hz (frames per second).</span>
<span class="sd">    repeat : `bool`</span>
<span class="sd">        whether to loop the animation or just play it once</span>
<span class="sd">    vrange : `tuple` or `str`</span>
<span class="sd">        If a 2-tuple, specifies the image values vmin/vmax that are mapped to</span>
<span class="sd">        the minimum and maximum value of the colormap, respectively. If a</span>
<span class="sd">        string:</span>

<span class="sd">        * `&#39;auto0&#39;`: all images have same vmin/vmax, which have the same absolute</span>
<span class="sd">                     value, and come from the minimum or maximum across all</span>
<span class="sd">                     images, whichever has the larger absolute value</span>
<span class="sd">        * `&#39;auto/auto1&#39;`: all images have same vmin/vmax, which are the</span>
<span class="sd">                          minimum/maximum values across all images</span>
<span class="sd">        * `&#39;auto2&#39;`: all images have same vmin/vmax, which are the mean (across</span>
<span class="sd">                     all images) minus/ plus 2 std dev (across all images)</span>
<span class="sd">        * `&#39;auto3&#39;`: all images have same vmin/vmax, chosen so as to map the</span>
<span class="sd">                     10th/90th percentile values to the 10th/90th percentile of</span>
<span class="sd">                     the display intensity range. For example: vmin is the 10th</span>
<span class="sd">                     percentile image value minus 1/8 times the difference</span>
<span class="sd">                     between the 90th and 10th percentile</span>
<span class="sd">        * `&#39;indep0&#39;`: each image has an independent vmin/vmax, which have the</span>
<span class="sd">                      same absolute value, which comes from either their</span>
<span class="sd">                      minimum or maximum value, whichever has the larger</span>
<span class="sd">                      absolute value.</span>
<span class="sd">        * `&#39;indep1&#39;`: each image has an independent vmin/vmax, which are their</span>
<span class="sd">                      minimum/maximum values</span>
<span class="sd">        * `&#39;indep2&#39;`: each image has an independent vmin/vmax, which is their</span>
<span class="sd">                      mean minus/plus 2 std dev</span>
<span class="sd">        * `&#39;indep3&#39;`: each image has an independent vmin/vmax, chosen so that</span>
<span class="sd">                      the 10th/90th percentile values map to the 10th/90th</span>
<span class="sd">                      percentile intensities.</span>
<span class="sd">    zoom : `float`</span>
<span class="sd">        ratio of display pixels to image pixels. if &gt;1, must be an integer. If</span>
<span class="sd">        &lt;1, must be 1/d where d is a a divisor of the size of the largest</span>
<span class="sd">        image.</span>
<span class="sd">    title : `str`, `list`, or None, optional</span>
<span class="sd">        Title for the plot. In addition to the specified title, we add a</span>
<span class="sd">        subtitle giving the plotted range and dimensionality (with zoom)</span>
<span class="sd">        * if `str`, will put the same title on every plot.</span>
<span class="sd">        * if `list`, all values must be `str`, must be the same length as img,</span>
<span class="sd">          assigning each title to corresponding image.</span>
<span class="sd">        * if None, no title will be printed (and subtitle will be removed).</span>
<span class="sd">    col_wrap : `int` or None, optional</span>
<span class="sd">        number of axes to have in each row. If None, will fit all axes in a</span>
<span class="sd">        single row.</span>
<span class="sd">    ax : `matplotlib.pyplot.axis` or None, optional</span>
<span class="sd">        if None, we make the appropriate figure. otherwise, we resize the axes</span>
<span class="sd">        so that it&#39;s the appropriate number of pixels (done by shrinking the</span>
<span class="sd">        bbox - if the bbox is already too small, this will throw an Exception!,</span>
<span class="sd">        so first define a large enough figure using either</span>
<span class="sd">        pyrtools.make_figure or plt.figure)</span>
<span class="sd">    cmap : matplotlib colormap, optional</span>
<span class="sd">        colormap to use when showing these images</span>
<span class="sd">    plot_complex : {&#39;rectangular&#39;, &#39;polar&#39;, &#39;logpolar&#39;}</span>
<span class="sd">        specifies handling of complex values.</span>

<span class="sd">        * `&#39;rectangular&#39;`: plot real and imaginary components as separate images</span>
<span class="sd">        * `&#39;polar&#39;`: plot amplitude and phase as separate images</span>
<span class="sd">        * `&#39;logpolar&#39;`: plot log_2 amplitude and phase as separate images</span>
<span class="sd">        for any other value, we raise a warning and default to rectangular.</span>
<span class="sd">    batch_idx : int or None, optional</span>
<span class="sd">        Which element from the batch dimension to plot. If None, we plot all.</span>
<span class="sd">    channel_idx : int or None, optional</span>
<span class="sd">        Which element from the channel dimension to plot. If None, we plot all.</span>
<span class="sd">        Note if this is an int, then `as_rgb=True` will fail, because we</span>
<span class="sd">        restrict the channels.</span>
<span class="sd">    as_rgb : bool, optional</span>
<span class="sd">        Whether to consider the channels as encoding RGB(A) values. If True, we</span>
<span class="sd">        attempt to plot the image in color, so your tensor must have 3 (or 4 if</span>
<span class="sd">        you want the alpha channel) elements in the channel dimension, or this</span>
<span class="sd">        will raise an Exception. If False, we plot each channel as a separate</span>
<span class="sd">        grayscale image.</span>
<span class="sd">    kwargs :</span>
<span class="sd">        Passed to `ax.imshow`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    anim : matplotlib.animation.FuncAnimation</span>
<span class="sd">        The animation object. In order to view, must convert to HTML</span>
<span class="sd">        or save.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    By default, we use the ffmpeg backend, which requires that you have</span>
<span class="sd">    ffmpeg installed and on your path (https://ffmpeg.org/download.html).</span>
<span class="sd">    To use a different, use the matplotlib rcParams:</span>
<span class="sd">    `matplotlib.rcParams[&#39;animation.writer&#39;] = writer`, see</span>
<span class="sd">    https://matplotlib.org/stable/api/animation_api.html#writer-classes for</span>
<span class="sd">    more details.</span>

<span class="sd">    For displaying in a jupyter notebook, ffmpeg appears to be required.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">video</span> <span class="o">=</span> <span class="p">[</span><span class="n">video</span><span class="p">]</span>
    <span class="n">videos_to_show</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">vid</span> <span class="ow">in</span> <span class="n">video</span><span class="p">:</span>
        <span class="n">vid</span> <span class="o">=</span> <span class="n">to_numpy</span><span class="p">(</span><span class="n">vid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">batch_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># this preserves the number of dimensions</span>
            <span class="n">vid</span> <span class="o">=</span> <span class="n">vid</span><span class="p">[</span><span class="n">batch_idx</span><span class="p">:</span><span class="n">batch_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">channel_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># this preserves the number of dimensions</span>
            <span class="n">vid</span> <span class="o">=</span> <span class="n">vid</span><span class="p">[:,</span> <span class="n">channel_idx</span><span class="p">:</span><span class="n">channel_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># allow RGB and RGBA</span>
        <span class="k">if</span> <span class="n">as_rgb</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;If as_rgb is True, then channel must have 3 &quot;</span>
                                <span class="s2">&quot;or 4 elements!&quot;</span><span class="p">)</span>
            <span class="n">vid</span> <span class="o">=</span> <span class="n">vid</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="c1"># want to insert a fake &quot;channel&quot; dimension here, so our putting it</span>
            <span class="c1"># into a list below works as expected</span>
            <span class="n">vid</span> <span class="o">=</span> <span class="n">vid</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">vid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">vid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
        <span class="k">elif</span> <span class="n">vid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">vid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Don&#39;t know how to plot images with more than one channel and batch!&quot;</span>
                            <span class="s2">&quot; Use batch_idx / channel_idx to choose a subset for plotting&quot;</span><span class="p">)</span>
        <span class="c1"># by iterating through it twice, we make sure to peel apart the batch</span>
        <span class="c1"># and channel dimensions so that they each show up as a separate video.</span>
        <span class="c1"># because of how we&#39;ve handled everything above, we know that vid will</span>
        <span class="c1"># be (b,c,t,h,w) or (b,c,t,h,w,r) where r is the RGB(A) values</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vid</span><span class="p">:</span>
            <span class="n">videos_to_show</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">v_</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="k">for</span> <span class="n">v_</span> <span class="ow">in</span> <span class="n">v</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">pt</span><span class="o">.</span><span class="n">animshow</span><span class="p">(</span><span class="n">videos_to_show</span><span class="p">,</span> <span class="n">framerate</span><span class="o">=</span><span class="n">framerate</span><span class="p">,</span> <span class="n">as_html5</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">repeat</span><span class="o">=</span><span class="n">repeat</span><span class="p">,</span> <span class="n">vrange</span><span class="o">=</span><span class="n">vrange</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="n">zoom</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
                       <span class="n">col_wrap</span><span class="o">=</span><span class="n">col_wrap</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
                       <span class="n">plot_complex</span><span class="o">=</span><span class="n">plot_complex</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>



<div class="viewcode-block" id="pyrshow">
<a class="viewcode-back" href="../../../api/plenoptic.tools.html#plenoptic.tools.display.pyrshow">[docs]</a>
<span class="k">def</span> <span class="nf">pyrshow</span><span class="p">(</span><span class="n">pyr_coeffs</span><span class="p">,</span> <span class="n">vrange</span><span class="o">=</span><span class="s1">&#39;indep1&#39;</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">show_residuals</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_complex</span><span class="o">=</span><span class="s1">&#39;rectangular&#39;</span><span class="p">,</span> <span class="n">batch_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">channel_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Display steerable pyramid coefficients in orderly fashion.</span>

<span class="sd">    This function uses ``imshow`` to show the coefficients of the steeable</span>
<span class="sd">    pyramid, such that each scale shows up on a single row, with each scale in</span>
<span class="sd">    a given column.</span>

<span class="sd">    Note that unlike imshow, we can only show one batch or channel at a time</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pyr_coeffs : `dict`</span>
<span class="sd">        pyramid coefficients in the standard dictionary format as returned by</span>
<span class="sd">        ``SteerablePyramidFreq.forward()``</span>
<span class="sd">    vrange : `tuple` or `str`</span>
<span class="sd">        If a 2-tuple, specifies the image values vmin/vmax that are mapped to</span>
<span class="sd">        the minimum and maximum value of the colormap, respectively. If a</span>
<span class="sd">        string:</span>

<span class="sd">        * `&#39;auto0&#39;`: all images have same vmin/vmax, which have the same absolute</span>
<span class="sd">                     value, and come from the minimum or maximum across all</span>
<span class="sd">                     images, whichever has the larger absolute value</span>
<span class="sd">        * `&#39;auto/auto1&#39;`: all images have same vmin/vmax, which are the</span>
<span class="sd">                          minimum/maximum values across all images</span>
<span class="sd">        * `&#39;auto2&#39;`: all images have same vmin/vmax, which are the mean (across</span>
<span class="sd">                     all images) minus/ plus 2 std dev (across all images)</span>
<span class="sd">        * `&#39;auto3&#39;`: all images have same vmin/vmax, chosen so as to map the</span>
<span class="sd">                     10th/90th percentile values to the 10th/90th percentile of</span>
<span class="sd">                     the display intensity range. For example: vmin is the 10th</span>
<span class="sd">                     percentile image value minus 1/8 times the difference</span>
<span class="sd">                     between the 90th and 10th percentile</span>
<span class="sd">        * `&#39;indep0&#39;`: each image has an independent vmin/vmax, which have the</span>
<span class="sd">                      same absolute value, which comes from either their</span>
<span class="sd">                      minimum or maximum value, whichever has the larger</span>
<span class="sd">                      absolute value.</span>
<span class="sd">        * `&#39;indep1&#39;`: each image has an independent vmin/vmax, which are their</span>
<span class="sd">                      minimum/maximum values</span>
<span class="sd">        * `&#39;indep2&#39;`: each image has an independent vmin/vmax, which is their</span>
<span class="sd">                      mean minus/plus 2 std dev</span>
<span class="sd">        * `&#39;indep3&#39;`: each image has an independent vmin/vmax, chosen so that</span>
<span class="sd">                      the 10th/90th percentile values map to the 10th/90th</span>
<span class="sd">                      percentile intensities.</span>
<span class="sd">    zoom : `float`</span>
<span class="sd">        ratio of display pixels to image pixels. if &gt;1, must be an integer. If</span>
<span class="sd">        &lt;1, must be 1/d where d is a a divisor of the size of the largest</span>
<span class="sd">        image.</span>
<span class="sd">    show_residuals : `bool`</span>
<span class="sd">        whether to display the residual bands (lowpass, highpass depending on the pyramid type)</span>
<span class="sd">    cmap : matplotlib colormap, optional</span>
<span class="sd">        colormap to use when showing these images</span>
<span class="sd">    plot_complex : {&#39;rectangular&#39;, &#39;polar&#39;, &#39;logpolar&#39;}</span>
<span class="sd">        specifies handling of complex values.</span>

<span class="sd">        * `&#39;rectangular&#39;`: plot real and imaginary components as separate images</span>
<span class="sd">        * `&#39;polar&#39;`: plot amplitude and phase as separate images</span>
<span class="sd">        * `&#39;logpolar&#39;`: plot log_2 amplitude and phase as separate images</span>
<span class="sd">        for any other value, we raise a warning and default to rectangular.</span>
<span class="sd">    batch_idx : int, optional</span>
<span class="sd">        Which element from the batch dimension to plot.</span>
<span class="sd">    channel_idx : int, optional</span>
<span class="sd">        Which element from the channel dimension to plot.</span>
<span class="sd">    kwargs :</span>
<span class="sd">        Passed on to ``pyrtools.pyrshow``</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig: `PyrFigure`</span>
<span class="sd">        the figure displaying the coefficients.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pyr_coeffvis</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">is_complex</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pyr_coeffs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">to_numpy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">iscomplex</span><span class="p">(</span><span class="n">im</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">is_complex</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># this removes only the first (batch) dimension</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">batch_idx</span><span class="p">:</span><span class="n">batch_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># this removes only the first (now channel) dimension</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">channel_idx</span><span class="p">:</span><span class="n">channel_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># because of how we&#39;ve handled everything above, we know that im will</span>
        <span class="c1"># be (h,w).</span>
        <span class="n">pyr_coeffvis</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span>

    <span class="k">return</span> <span class="n">pt</span><span class="o">.</span><span class="n">pyrshow</span><span class="p">(</span><span class="n">pyr_coeffvis</span><span class="p">,</span> <span class="n">is_complex</span><span class="o">=</span><span class="n">is_complex</span><span class="p">,</span> <span class="n">vrange</span><span class="o">=</span><span class="n">vrange</span><span class="p">,</span>
                      <span class="n">zoom</span><span class="o">=</span><span class="n">zoom</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">plot_complex</span><span class="o">=</span><span class="n">plot_complex</span><span class="p">,</span>
                      <span class="n">show_residuals</span><span class="o">=</span><span class="n">show_residuals</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>



<div class="viewcode-block" id="clean_up_axes">
<a class="viewcode-back" href="../../../api/plenoptic.tools.html#plenoptic.tools.display.clean_up_axes">[docs]</a>
<span class="k">def</span> <span class="nf">clean_up_axes</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spines_to_remove</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;bottom&#39;</span><span class="p">],</span>
                  <span class="n">axes_to_remove</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Clean up an axis, as desired when making a stem plot of the representation</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ax : `matplotlib.pyplot.axis`</span>
<span class="sd">        The axis to clean up.</span>
<span class="sd">    ylim : `tuple`, False, or None</span>
<span class="sd">        If a tuple, the y-limits to use for this plot. If None, we use the</span>
<span class="sd">        default, slightly adjusted so that the minimum is 0. If False,</span>
<span class="sd">        we do nothing.</span>
<span class="sd">    spines_to_remove : `list`</span>
<span class="sd">        Some combination of &#39;top&#39;, &#39;right&#39;, &#39;bottom&#39;, and &#39;left&#39;. The spines we</span>
<span class="sd">        remove from the axis.</span>
<span class="sd">    axes_to_remove : `list`</span>
<span class="sd">        Some combination of &#39;x&#39;, &#39;y&#39;. The axes to set as invisible.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ax : matplotlib.pyplot.axis</span>
<span class="sd">        The cleaned-up axis</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">spines_to_remove</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">spines_to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;bottom&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">axes_to_remove</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axes_to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">ylim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ylim</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="n">axes_to_remove</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="n">axes_to_remove</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">spines_to_remove</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ax</span></div>



<div class="viewcode-block" id="update_stem">
<a class="viewcode-back" href="../../../api/plenoptic.tools.html#plenoptic.tools.display.update_stem">[docs]</a>
<span class="k">def</span> <span class="nf">update_stem</span><span class="p">(</span><span class="n">stem_container</span><span class="p">,</span> <span class="n">ydata</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Update the information in a stem plot</span>

<span class="sd">    We update the information in a single stem plot to match that given</span>
<span class="sd">    by ``ydata``. We update the position of the markers and and the</span>
<span class="sd">    lines connecting them to the baseline, but we don&#39;t change the</span>
<span class="sd">    baseline at all and assume that the xdata shouldn&#39;t change at all.</span>

<span class="sd">    This requires that the initial ``plt.stem`` be called with the</span>
<span class="sd">    argument ``use_line_collection=True``, as will be the default in</span>
<span class="sd">    matplotlib 3.3 (this improves efficiency, so you should do it</span>
<span class="sd">    anyway)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    stem_container : `matplotlib.container.StemContainer`</span>
<span class="sd">        Single container for the artists created in a ``plt.stem``</span>
<span class="sd">        plot. It can be treated like a namedtuple ``(markerline,</span>
<span class="sd">        stemlines, baseline)``. In order to get this from an axis</span>
<span class="sd">        ``ax``, try ``ax.containers[0]`` (obviously if you have more</span>
<span class="sd">        than one container in that axis, it may not be the first one).</span>
<span class="sd">    ydata : array_like</span>
<span class="sd">        The new y-data to show on the plot. Importantly, must be the</span>
<span class="sd">        same length as the existing y-data.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    stem_container : `matplotlib.container.StemContainer`</span>
<span class="sd">        The StemContainer containing the updated artists.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stem_container</span><span class="o">.</span><span class="n">markerline</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">ydata</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">segments</span> <span class="o">=</span> <span class="n">stem_container</span><span class="o">.</span><span class="n">stemlines</span><span class="o">.</span><span class="n">get_segments</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;We require that the initial stem plot be called with &quot;</span>
                        <span class="s2">&quot;use_line_collection=True in order to correctly update &quot;</span>
                        <span class="s2">&quot;it. This will significantly improve performance as &quot;</span>
                        <span class="s2">&quot;well.&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">segments</span><span class="p">,</span> <span class="n">ydata</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="c1"># this happens when our segment array is 1x2 instead of 2x2,</span>
            <span class="c1"># which is the case when the data there is nan</span>
            <span class="k">continue</span>
    <span class="n">stem_container</span><span class="o">.</span><span class="n">stemlines</span><span class="o">.</span><span class="n">set_segments</span><span class="p">(</span><span class="n">segments</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">stem_container</span></div>



<div class="viewcode-block" id="rescale_ylim">
<a class="viewcode-back" href="../../../api/plenoptic.tools.html#plenoptic.tools.display.rescale_ylim">[docs]</a>
<span class="k">def</span> <span class="nf">rescale_ylim</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;rescale y-limits nicely</span>

<span class="sd">    We take the axes and set their limits to be ``(-y_max, y_max)``,</span>
<span class="sd">    where ``y_max=np.abs(data).max()``</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    axes : `list`</span>
<span class="sd">        A list of matplotlib axes to rescale</span>
<span class="sd">    data : array_like or dict</span>
<span class="sd">        The data to use when rescaling (or a dictiontary of those</span>
<span class="sd">        values)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">find_ymax</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="c1"># then we need to call to_numpy on it because it needs to be</span>
            <span class="c1"># detached and converted to an array</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">data</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">y_max</span> <span class="o">=</span> <span class="n">find_ymax</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="c1"># then this is a dictionary</span>
        <span class="n">y_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">find_ymax</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="o">-</span><span class="n">y_max</span><span class="p">,</span> <span class="n">y_max</span><span class="p">))</span></div>



<div class="viewcode-block" id="convert_anim_to_html">
<a class="viewcode-back" href="../../../api/plenoptic.tools.html#plenoptic.tools.display.convert_anim_to_html">[docs]</a>
<span class="k">def</span> <span class="nf">convert_anim_to_html</span><span class="p">(</span><span class="n">anim</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;convert a matplotlib animation object to HTML (for display)</span>

<span class="sd">    This is a simple little wrapper function that allows the animation</span>
<span class="sd">    to be displayed in a Jupyter notebook</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    anim : `matplotlib.animation.FuncAnimation`</span>
<span class="sd">        The animation object to convert to HTML</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># to_html5_video will call savefig with a dpi kwarg, so our</span>
    <span class="c1"># custom figure class will raise a warning. we don&#39;t want to</span>
    <span class="c1"># worry people, so we go ahead and suppress it</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">HTML</span><span class="p">(</span><span class="n">anim</span><span class="o">.</span><span class="n">to_html5_video</span><span class="p">())</span></div>



<div class="viewcode-block" id="clean_stem_plot">
<a class="viewcode-back" href="../../../api/plenoptic.tools.html#plenoptic.tools.display.clean_stem_plot">[docs]</a>
<span class="k">def</span> <span class="nf">clean_stem_plot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xvals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;convenience wrapper for plotting stem plots</span>

<span class="sd">    This plots the data, baseline, cleans up the axis, and sets the</span>
<span class="sd">    title</span>

<span class="sd">    Should not be called by users directly, but is a helper function for</span>
<span class="sd">    the various plot_representation() functions</span>

<span class="sd">    By default, stem plot would have a baseline that covers the entire</span>
<span class="sd">    range of the data. We want to be able to break that up visually (so</span>
<span class="sd">    there&#39;s a line from 0 to 9, from 10 to 19, etc), and passing xvals</span>
<span class="sd">    separately allows us to do that. If you want the default stem plot</span>
<span class="sd">    behavior, leave xvals as None.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : `np.ndarray`</span>
<span class="sd">        The data to plot (as a stem plot)</span>
<span class="sd">    ax : `matplotlib.pyplot.axis` or `None`, optional</span>
<span class="sd">        The axis to plot the data on. If None, we plot on the current</span>
<span class="sd">        axis</span>
<span class="sd">    title : str or None, optional</span>
<span class="sd">        The title to put on the axis if not None. If None, we don&#39;t call</span>
<span class="sd">        ``ax.set_title`` (useful if you want to avoid changing the title</span>
<span class="sd">        on an existing plot)</span>
<span class="sd">    ylim : tuple or None, optional</span>
<span class="sd">        If not None, the y-limits to use for this plot. If None, we</span>
<span class="sd">        use the default, slightly adjusted so that the minimum is 0</span>
<span class="sd">    xvals : `tuple` or `None`, optional</span>
<span class="sd">        A 2-tuple of lists, containing the start (``xvals[0]``) and stop</span>
<span class="sd">        (``xvals[1]``) x values for plotting. If None, we use the</span>
<span class="sd">        default stem plot behavior.</span>
<span class="sd">    kwargs :</span>
<span class="sd">        passed to ax.stem</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ax : `matplotlib.pyplot.axis`</span>
<span class="sd">        The axis with the plot</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    We allow for breaks in the baseline value if we want to visually</span>
<span class="sd">    break up the plot, as we see below.</span>

<span class="sd">    ..plot::</span>
<span class="sd">      :include-source:</span>

<span class="sd">      import plenoptic as po</span>
<span class="sd">      import numpy as np</span>
<span class="sd">      import matplotlib.pyplot as plt</span>
<span class="sd">      # if ylim=None, as in this example, the minimum y-valuewill get</span>
<span class="sd">      # set to 0, so we want to make sure our values are all positive</span>
<span class="sd">      y = np.abs(np.random.randn(55))</span>
<span class="sd">      y[15:20] = np.nan</span>
<span class="sd">      y[35:40] = np.nan</span>
<span class="sd">      # we want to draw the baseline from 0 to 14, 20 to 34, and 40 to</span>
<span class="sd">      # 54, everywhere that we have non-NaN values for y</span>
<span class="sd">      xvals = ([0, 20, 40], [14, 34, 54])</span>
<span class="sd">      po.tools.display.clean_stem_plot(y,  xvals=xvals)</span>
<span class="sd">      plt.show()</span>

<span class="sd">    If we don&#39;t care about breaking up the x-axis, you can simply use</span>
<span class="sd">    the default xvals (``None``). In this case, this function will just</span>
<span class="sd">    clean up the plot a little bit</span>

<span class="sd">    ..plot::</span>
<span class="sd">      :include-source:</span>

<span class="sd">      import plenoptic as po</span>
<span class="sd">      import numpy as np</span>
<span class="sd">      import matplotlib.pyplot as plt</span>
<span class="sd">      # if ylim=None, as in this example, the minimum y-valuewill get</span>
<span class="sd">      # set to 0, so we want to make sure our values are all positive</span>
<span class="sd">      y = np.abs(np.random.randn(55))</span>
<span class="sd">      po.tools.display.clean_stem_plot(y)</span>
<span class="sd">      plt.show()</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">xvals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">basefmt</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xvals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xvals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xvals</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;C3&#39;</span><span class="p">,</span>
                  <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># this is the default basefmt value</span>
        <span class="n">basefmt</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">stem</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">basefmt</span><span class="o">=</span><span class="n">basefmt</span><span class="p">,</span> <span class="n">use_line_collection</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">clean_up_axes</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ylim</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;bottom&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ax</span></div>



<span class="k">def</span> <span class="nf">_get_artists_from_axes</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Grab artists from axes.</span>

<span class="sd">    For now, we only grab containers (stem plots), images, or lines</span>

<span class="sd">    See the docstring of :meth:`update_plot()` for details on how `axes` and</span>
<span class="sd">    `data` should be structured</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    axes : list or matplotlib.axes.Axes</span>
<span class="sd">        The axis/axes to update.</span>
<span class="sd">    data : torch.Tensor or dict</span>
<span class="sd">        The new data to plot.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    artists : dict</span>
<span class="sd">        dictionary of artists for updating plots. values are the artists to</span>
<span class="sd">        use, keys are the corresponding keys for data</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">):</span>
        <span class="c1"># then we only have one axis, so we may be able to update more than one</span>
        <span class="c1"># data element.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">containers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">data_check</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">artists</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">containers</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">images</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># images are weird, so don&#39;t check them like this</span>
            <span class="n">data_check</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">artists</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">images</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">lines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">data_check</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">artists</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">lines</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">collections</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">data_check</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">artists</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">collections</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">artists</span> <span class="o">=</span> <span class="p">{</span><span class="n">ax</span><span class="o">.</span><span class="n">get_label</span><span class="p">():</span> <span class="n">ax</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">artists</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data_check</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">artists</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;data has </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> things to plot, but &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;your axis contains </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">artists</span><span class="p">)</span><span class="si">}</span><span class="s2"> plotting artists, &quot;</span>
                                <span class="s2">&quot;so unsure how to continue! Pass data as a dictionary&quot;</span>
                                <span class="s2">&quot; with keys corresponding to the labels of the artists&quot;</span>
                                <span class="s2">&quot; to update to resolve this.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">data_check</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">artists</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;data has </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2"> things to plot, but &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;your axis contains </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">artists</span><span class="p">)</span><span class="si">}</span><span class="s2"> plotting artists, &quot;</span>
                                <span class="s2">&quot;so unsure how to continue! Pass data as a dictionary&quot;</span>
                                <span class="s2">&quot; with keys corresponding to the labels of the artists&quot;</span>
                                <span class="s2">&quot; to update to resolve this.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># then we have multiple axes, so we are only updating one data element</span>
        <span class="c1"># per plot</span>
        <span class="n">artists</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">containers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">data_check</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">artists</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">containers</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">images</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># images are weird, so don&#39;t check them like this</span>
                <span class="n">data_check</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">artists</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">images</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">lines</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">artists</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">lines</span><span class="p">)</span>
                <span class="n">data_check</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">collections</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">artists</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">collections</span><span class="p">)</span>
                <span class="n">data_check</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">artists</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;data has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2"> things to plot, but &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;you passed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span><span class="si">}</span><span class="s2"> axes , so unsure how &quot;</span>
                                <span class="s2">&quot;to continue!&quot;</span><span class="p">)</span>
            <span class="n">artists</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">a</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">artists</span><span class="p">)}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data_check</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">artists</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;data has </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> things to plot, but &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;you passed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span><span class="si">}</span><span class="s2"> axes , so unsure how &quot;</span>
                                <span class="s2">&quot;to continue!&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data_check</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">artists</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;data has </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2"> things to plot, but &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;you passed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span><span class="si">}</span><span class="s2"> axes , so unsure how &quot;</span>
                                <span class="s2">&quot;to continue!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">artists</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">artists</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">a</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">artists</span><span class="p">)}</span>
    <span class="k">return</span> <span class="n">artists</span>


<div class="viewcode-block" id="update_plot">
<a class="viewcode-back" href="../../../api/plenoptic.tools.html#plenoptic.tools.display.update_plot">[docs]</a>
<span class="k">def</span> <span class="nf">update_plot</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Update the information in some axes.</span>

<span class="sd">    This is used for creating an animation over time. In order to create</span>
<span class="sd">    the animation, we need to know how to update the matplotlib Artists,</span>
<span class="sd">    and this provides a simple way of doing that. It assumes the plot</span>
<span class="sd">    has been created by something like ``plot_representation``, which</span>
<span class="sd">    initializes all the artists.</span>

<span class="sd">    We can update stem plots, lines (as returned by ``plt.plot``), scatter</span>
<span class="sd">    plots, or images (RGB, RGBA, or grayscale).</span>

<span class="sd">    There are two modes for this:</span>

<span class="sd">    - single axis: axes is a single axis, which may contain multiple artists</span>
<span class="sd">      (all of the same type) to update. data should be a Tensor with multiple</span>
<span class="sd">      channels (one per artist in the same order) or be a dictionary whose keys</span>
<span class="sd">      give the label(s) of the corresponding artist(s) and whose values are</span>
<span class="sd">      Tensors.</span>

<span class="sd">    - multiple axes: axes is a list of axes, each of which contains a single</span>
<span class="sd">      artist to update (artists can be different types). data should be a</span>
<span class="sd">      Tensor with multiple channels (one per axis in the same order) or a</span>
<span class="sd">      dictionary with the same number of keys as axes, which we can iterate</span>
<span class="sd">      through in order, and whose values are Tensors.</span>

<span class="sd">    In all cases, data Tensors should be 3d (if the plot we&#39;re updating is a</span>
<span class="sd">    line or stem plot) or 4d (if it&#39;s an image or scatter plot).</span>

<span class="sd">    RGB(A) images are special, since we store that info along the channel</span>
<span class="sd">    dimension, so they only work with single-axis mode (which will only have a</span>
<span class="sd">    single artist, because that&#39;s how imshow works).</span>

<span class="sd">    If you have multiple axes, each with multiple artists you want to update,</span>
<span class="sd">    that&#39;s too complicated for us, and so you should write a</span>
<span class="sd">    ``model.update_plot()`` function which handles that.</span>

<span class="sd">    If ``model`` is set, we try to call ``model.update_plot()`` (which</span>
<span class="sd">    must also return artists). If model doesn&#39;t have an ``update_plot``</span>
<span class="sd">    method, then we try to figure out how to update the axes ourselves,</span>
<span class="sd">    based on the shape of the data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    axes : `list` or `matplotlib.pyplot.axis`</span>
<span class="sd">        The axis or list of axes to update. We assume that these are the axes</span>
<span class="sd">        created by ``plot_representation`` and so contain stem plots in the</span>
<span class="sd">        correct order.</span>
<span class="sd">    data : `torch.Tensor` or `dict`</span>
<span class="sd">        The new data to plot.</span>
<span class="sd">    model : `torch.nn.Module` or `None`, optional</span>
<span class="sd">        A differentiable model that tells us how to plot ``data``. See</span>
<span class="sd">        above for behavior if ``None``.</span>
<span class="sd">    batch_idx : int, optional</span>
<span class="sd">        Which index to take from the batch dimension</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    artists : `list`</span>
<span class="sd">        A list of the artists used to update the information on the</span>
<span class="sd">        plots</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;update_plot expects 3 or 4 dimensional data&quot;</span>
                                 <span class="s2">&quot;; unexpected behavior will result otherwise!&quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot; Got data of shape </span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;update_plot expects 3 or 4 dimensional data&quot;</span>
                             <span class="s2">&quot;; unexpected behavior will result otherwise!&quot;</span>
                             <span class="sa">f</span><span class="s2">&quot; Got data of shape </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">artists</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">update_plot</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span> <span class="n">batch_idx</span><span class="o">=</span><span class="n">batch_idx</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">ax_artists</span> <span class="o">=</span> <span class="n">_get_artists_from_axes</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">artists</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># check for RGBA images</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ax_artists</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># can&#39;t index into dict.values(), so use this work around</span>
                <span class="c1"># instead, as suggested</span>
                <span class="c1"># https://stackoverflow.com/questions/43629270/how-to-get-single-value-from-dict-with-single-entry</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">ax_artists</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">get_array</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># then this is an RGBA image</span>
                        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;00&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">}</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Thought this was an RGB(A) image based on the number of &quot;</span>
                                    <span class="s2">&quot;artists and data shape, but something is off! &quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot;Original exception: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">unbind</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
                    <span class="c1"># need to keep the shape the same because of how we</span>
                    <span class="c1"># check for shape below (unbinding removes a dimension,</span>
                    <span class="c1"># so we add it back)</span>
                    <span class="n">data_dict</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s1">02d</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data_dict</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">art</span> <span class="o">=</span> <span class="n">ax_artists</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="c1"># If the we&#39;re grabbing these labels from the line labels and</span>
                <span class="c1"># they were originally ints, they will get converted to</span>
                <span class="c1"># strings. this catches that</span>
                <span class="n">art</span> <span class="o">=</span> <span class="n">ax_artists</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">to_numpy</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">batch_idx</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># then it&#39;s a line</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">art</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
                    <span class="n">art</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
                    <span class="n">artists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">art</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="c1"># then it&#39;s a stemplot</span>
                    <span class="n">sc</span> <span class="o">=</span> <span class="n">update_stem</span><span class="p">(</span><span class="n">art</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
                    <span class="n">artists</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">sc</span><span class="o">.</span><span class="n">markerline</span><span class="p">,</span> <span class="n">sc</span><span class="o">.</span><span class="n">stemlines</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">d</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># then it&#39;s a grayscale image</span>
                    <span class="n">art</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                    <span class="n">artists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">art</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="c1"># then it&#39;s a scatterplot</span>
                    <span class="n">art</span><span class="o">.</span><span class="n">set_offsets</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                    <span class="n">artists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">art</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># then it&#39;s an RGB(A) image. for tensors, we put that dimension</span>
                <span class="c1"># in channel, but for images, it should be at the end</span>
                <span class="n">art</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">artists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">art</span><span class="p">)</span>
    <span class="c1"># make sure to always return a list</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">artists</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">artists</span> <span class="o">=</span> <span class="p">[</span><span class="n">artists</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">artists</span></div>



<div class="viewcode-block" id="plot_representation">
<a class="viewcode-back" href="../../../api/plenoptic.tools.html#plenoptic.tools.display.plot_representation">[docs]</a>
<span class="k">def</span> <span class="nf">plot_representation</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
                        <span class="n">ylim</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">batch_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">as_rgb</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Helper function for plotting model representation</span>

<span class="sd">    We are trying to plot ``data`` on ``ax``, using</span>
<span class="sd">    ``model.plot_representation`` method, if it has it, and otherwise</span>
<span class="sd">    default to a function that makes sense based on the shape of ``data``.</span>

<span class="sd">    All of these arguments are optional, but at least some of them need</span>
<span class="sd">    to be set:</span>

<span class="sd">    - If ``model`` is ``None``, we fall-back to a type of plot based on the</span>
<span class="sd">      shape of ``data``. If it looks image-like, we&#39;ll use ``plenoptic.imshow``</span>
<span class="sd">      and if it looks vector-like, we&#39;ll use ``plenoptic.clean_stem_plot``. If</span>
<span class="sd">      it&#39;s a dictionary, we&#39;ll assume each key, value pair gives the title and</span>
<span class="sd">      data to plot on a separate sub-plot.</span>

<span class="sd">    - If ``data`` is ``None``, we can only do something if</span>
<span class="sd">      ``model.plot_representation`` has some default behavior when</span>
<span class="sd">      ``data=None``; this is probably to plot its own ``representation``</span>
<span class="sd">      attribute. Thus, this will raise an Exception if both ``model`` and</span>
<span class="sd">      ``data`` are ``None``, because we have no idea what to plot then.</span>

<span class="sd">    - If ``ax`` is ``None``, we create a one-subplot figure using ``figsize``.</span>
<span class="sd">      If ``ax`` is not ``None``, we therefore ignore ``figsize``.</span>

<span class="sd">    - If ``ylim`` is ``None``, we call ``rescale_ylim``, which sets the axes&#39;</span>
<span class="sd">      y-limits to be ``(-y_max, y_max)``, where ``y_max=np.abs(data).max()``.</span>
<span class="sd">      If it&#39;s ``False``, we do nothing.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model : `torch.nn.Module` or None, optional</span>
<span class="sd">        A differentiable model that tells us how to plot ``data``. See</span>
<span class="sd">        above for behavior if ``None``.</span>
<span class="sd">    data : `array_like`, `dict`, or `None`, optional</span>
<span class="sd">        The data to plot. See above for behavior if ``None``.</span>
<span class="sd">    ax : matplotlib.pyplot.axis or None, optional</span>
<span class="sd">        The axis to plot on. See above for behavior if ``None``.</span>
<span class="sd">    figsize : `tuple`, optional</span>
<span class="sd">        The size of the figure to create. Ignored if ``ax`` is not</span>
<span class="sd">        ``None``.</span>
<span class="sd">    ylim : `tuple`, `None`, or `False`, optional</span>
<span class="sd">        If not None, the y-limits to use for this plot. See above for</span>
<span class="sd">        behavior if ``None``. If False, we do nothing.</span>
<span class="sd">    batch_idx : `int`, optional</span>
<span class="sd">        Which index to take from the batch dimension</span>
<span class="sd">    title : `str`, optional</span>
<span class="sd">        The title to put above this axis. If you want no title, pass</span>
<span class="sd">        the empty string (``&#39;&#39;``)</span>
<span class="sd">    as_rgb : bool, optional</span>
<span class="sd">        The representation can be image-like with multiple channels, and we</span>
<span class="sd">        have no way to determine whether it should be represented as an RGB</span>
<span class="sd">        image or not, so the user must set this flag to tell us. It will be</span>
<span class="sd">        ignored if the representation doesn&#39;t look image-like or if the</span>
<span class="sd">        model has its own plot_representation_error() method. Else, it will</span>
<span class="sd">        be passed to `po.imshow()`, see that methods docstring for details.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    axes : list</span>
<span class="sd">        List of created axes.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;ax is not None, so we&#39;re ignoring figsize...&quot;</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># no point in passing figsize, because we&#39;ve already created</span>
        <span class="c1"># and are passing an axis or are passing the user-specified one</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">plot_representation</span><span class="p">(</span><span class="n">ylim</span><span class="o">=</span><span class="n">ylim</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
                                              <span class="n">batch_idx</span><span class="o">=</span><span class="n">batch_idx</span><span class="p">,</span>
                                              <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">representation</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Representation&#39;</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">as_rgb</span><span class="p">:</span>
                <span class="c1"># then we peel apart the channels</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">unbind</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
                    <span class="c1"># need to keep the shape the same because of how we</span>
                    <span class="c1"># check for shape below (unbinding removes a dimension,</span>
                    <span class="c1"># so we add it back)</span>
                    <span class="n">data_dict</span><span class="p">[</span><span class="n">title</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data_dict</span><span class="p">[</span><span class="n">title</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data_dict</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;data has keys, so we&#39;re ignoring title!&quot;</span><span class="p">)</span>
        <span class="c1"># want to make sure the axis we&#39;re taking over is basically invisible.</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">clean_up_axes</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span>
                           <span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">])</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># then this is &#39;vector-like&#39;</span>
            <span class="n">gs</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_subplotspec</span><span class="p">()</span><span class="o">.</span><span class="n">subgridspec</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span>
                                                  <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="mi">4</span><span class="p">,</span> <span class="n">i</span> <span class="o">//</span> <span class="mi">4</span><span class="p">])</span>
                <span class="c1"># only plot the specified batch, but plot each channel</span>
                <span class="c1"># in a separate call. there should probably only be one,</span>
                <span class="c1"># and if there&#39;s not you probably want to do things</span>
                <span class="c1"># differently</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">v</span><span class="p">[</span><span class="n">batch_idx</span><span class="p">]:</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="n">clean_stem_plot</span><span class="p">(</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="n">ax</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ylim</span><span class="p">)</span>
                <span class="n">axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="c1"># then this is &#39;image-like&#39;</span>
            <span class="n">gs</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_subplotspec</span><span class="p">()</span><span class="o">.</span><span class="n">subgridspec</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)),</span>
                                                  <span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">i</span> <span class="o">//</span> <span class="mi">4</span><span class="p">,</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">4</span><span class="p">])</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">clean_up_axes</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span>
                                   <span class="kc">False</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">],</span>
                                   <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">])</span>
                <span class="c1"># only plot the specified batch</span>
                <span class="n">imshow</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">batch_idx</span><span class="o">=</span><span class="n">batch_idx</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                       <span class="n">vrange</span><span class="o">=</span><span class="s1">&#39;indep0&#39;</span><span class="p">,</span> <span class="n">as_rgb</span><span class="o">=</span><span class="n">as_rgb</span><span class="p">)</span>
                <span class="n">axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
            <span class="c1"># because we&#39;re plotting image data, don&#39;t want to change</span>
            <span class="c1"># ylim at all</span>
            <span class="n">ylim</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Don&#39;t know what to do with data of shape&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ylim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">rescale_ylim</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">axes</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, Lab for Computational Vision.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>