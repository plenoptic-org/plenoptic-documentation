

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Perceptual distance &mdash; plenoptic 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css?v=2aa19091" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Portilla-Simoncelli Texture Metamer" href="Metamer-Portilla-Simoncelli.html" />
    <link rel="prev" title="Steerable Pyramid" href="03_Steerable_Pyramid.html" /> 
</head>

<body class="wy-body-for-nav">

<div style="background-color: rgb(248, 215, 218); color: rgb(114, 28, 36); text-align: center;">
  <div>
    <div>This is documentation for <strong>an old version</strong>.
      <a href="https://docs.plenoptic.org/" style="background-color: rgb(220, 53, 69); color: rgb(255, 255, 255); margin: 1rem; padding: 0.375rem 0.75rem; border-radius: 4px; display: inline-block; text-align: center;">Switch to stable version</a>
    </div>
  </div>
</div>
 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            plenoptic
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Basic concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../conceptual_intro.html">Conceptual Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../models.html">Model requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_quickstart.html">Quickstart</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Synthesis method introductions</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../intro/02_Eigendistortions.html">Eigendistortions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/05_Geodesics.html">Representational Geodesic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/06_Metamer.html">Metamers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/07_Simple_MAD.html">MAD Competition Conceptual Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/08_MAD_Competition.html">MAD Competition Usage</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Models and metrics</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="03_Steerable_Pyramid.html">Steerable Pyramid</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Perceptual distance</a></li>
<li class="toctree-l1"><a class="reference internal" href="Metamer-Portilla-Simoncelli.html">Portilla-Simoncelli Texture Metamer</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Synthesis method examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../applications/09_Original_MAD.html">Reproducing Wang and Simoncelli, 2008 (MAD Competition)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../applications/Demo_Eigendistortion.html">Reproducing Berardino et al., 2017 (Eigendistortions)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Advanced usage</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../synthesis.html">Synthesis object design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tips.html">Tips and Tricks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reproducibility.html">Reproducibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/modules.html">Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/Display.html">Display and animate functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/Synthesis_extensions.html">Extending existing synthesis objects</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">plenoptic</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Perceptual distance</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/tutorials/models/04_Perceptual_distance.nblink.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Perceptual-distance">
<h1>Perceptual distance<a class="headerlink" href="#Perceptual-distance" title="Link to this heading"></a></h1>
<p><strong>Run notebook online with Binder:</strong> <a class="reference external" href="https://mybinder.org/v2/gh/LabForComputationalVision/plenoptic/1.0.0?filepath=examples/04_Perceptual_distance.ipynb"><img alt="Binder" src="http://mybinder.org/badge_logo.svg" /></a></p>
<p>The easiest way to measure the difference between two images is by computing the mean square error (MSE), but it does not match the perceptual distance judged by humans. Several perceptual distance functions have been developed to better match human perception. This tutorial introduces three perceptual distance functions available in <code class="docutils literal notranslate"><span class="pre">plenoptic</span></code> package: SSIM (structural similarity), MS-SSIM (multiscale structural similarity) and NLPD (normalized Laplacian pyramid distance).</p>
<section id="References">
<h2>References<a class="headerlink" href="#References" title="Link to this heading"></a></h2>
<p><strong>SSIM</strong>: Wang, Z., Bovik, A. C., Sheikh, H. R., &amp; Simoncelli, E. P. (2004). Image quality assessment: from error visibility to structural similarity. <em>IEEE transactions on image processing</em>, 13(4), 600-612.</p>
<p><strong>MS-SSIM</strong>: Wang, Z., Simoncelli, E. P., &amp; Bovik, A. C. (2003, November). Multiscale structural similarity for image quality assessment. In <em>The Thrity-Seventh Asilomar Conference on Signals, Systems &amp; Computers</em>, 2003 (Vol. 2, pp. 1398-1402). IEEE.</p>
<p><strong>NLPD</strong>: Laparra, V., Ballé, J., Berardino, A., &amp; Simoncelli, E. P. (2016). Perceptual image quality assessment using a normalized Laplacian pyramid. <em>Electronic Imaging</em>, 2016(16), 1-6.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">imageio</span>
<span class="kn">import</span> <span class="nn">plenoptic</span> <span class="k">as</span> <span class="nn">po</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">gaussian_filter</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">pearsonr</span><span class="p">,</span> <span class="n">spearmanr</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/zxy/miniconda3/envs/plenoptic/lib/python3.8/site-packages/tqdm/auto.py:22: TqdmWarning: IProgress not found. Please update jupyter and ipywidgets. See https://ipywidgets.readthedocs.io/en/stable/user_install.html
  from .autonotebook import tqdm as notebook_tqdm
</pre></div></div>
</div>
<section id="SSIM-(structural-similarity)">
<h3>SSIM (structural similarity)<a class="headerlink" href="#SSIM-(structural-similarity)" title="Link to this heading"></a></h3>
<p>The idea of SSIM index is to decompose the difference between two images into three components: luminance, contrast and structure. For two small image patches <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> and <span class="math notranslate nohighlight">\(\mathbf{y}\)</span>, these three components of difference are defined as:</p>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}   l(\mathbf{x}, \mathbf{y}) = \frac{2 \mu_x \mu_y + C_1}{\mu_x^2 + \mu_y^2 + C_1}, \qquad
  c(\mathbf{x}, \mathbf{y}) = \frac{2 \sigma_x \sigma_y + C_2}{\sigma_x^2 + \sigma_y^2 + C_2}, \qquad
  s(\mathbf{x}, \mathbf{y}) = \frac{\sigma_{xy} + C_3}{\sigma_x \sigma_y + C_3}\\where :math:`\mu_x` and :math:`\mu_y` are the mean of :math:`\mathbf{x}` and :math:`\mathbf{y}`, :math:`\sigma_x` and :math:`\sigma_y` are the standard deviation of :math:`\mathbf{x}` and :math:`\mathbf{y}`, and :math:`\sigma_{xy}` is the covariance between :math:`\mathbf{x}` and :math:`\mathbf{y}`. And :math:`C_1, C_2, C_3` are small constants. If we ignore the small constants, we can see that the luminance term :math:`l(\mathbf{x}, \mathbf{y})` is a scale-invariant similarity measurement\end{aligned}\end{align} \]</div>
<p>between <span class="math notranslate nohighlight">\(\mu_x\)</span> and <span class="math notranslate nohighlight">\(\mu_y\)</span>, and the contrast term <span class="math notranslate nohighlight">\(c(\mathbf{x}, \mathbf{y})\)</span> is such a measurement between <span class="math notranslate nohighlight">\(\sigma_x\)</span> and <span class="math notranslate nohighlight">\(\sigma_y\)</span>. The structural term <span class="math notranslate nohighlight">\(s(\mathbf{x}, \mathbf{y})\)</span> is the correlation coefficient between <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> and <span class="math notranslate nohighlight">\(\mathbf{y}\)</span>, which is invariant to addition and multiplication of constants on <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> or <span class="math notranslate nohighlight">\(\mathbf{y}\)</span>.</p>
<p>Local SSIM between two small image patches <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> and <span class="math notranslate nohighlight">\(\mathbf{y}\)</span> is defined as (let <span class="math notranslate nohighlight">\(C_3 = C_2 / 2\)</span>):</p>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}d(\mathbf{x}, \mathbf{y}) = l(\mathbf{x}, \mathbf{y}) c(\mathbf{x}, \mathbf{y}) s(\mathbf{x}, \mathbf{y}) = \frac{\left( 2 \mu_x \mu_y + C_1 \right) \left( 2\sigma_{xy} + C_2 \right)} {\left( \mu_x^2 + \mu_y^2 + C_1 \right) \left( \sigma_x^2 + \sigma_y^2 + C_2 \right)}\\The local SSIM value :math:`d(\mathbf{x}, \mathbf{y}) = 1` means the two patches are identical and :math:`d(\mathbf{x}, \mathbf{y}) = 0` means they're very different. When the two patches are negatively correlated, :math:`d(\mathbf{x}, \mathbf{y})` can be negative. The local SSIM value is bounded between -1 and 1.\end{aligned}\end{align} \]</div>
<p>For two full images <span class="math notranslate nohighlight">\(\mathbf{X}, \mathbf{Y}\)</span>, an SSIM map is obtained by computing the local SSIM value <span class="math notranslate nohighlight">\(d\)</span> across the whole image. For each position on the images, instead of using a square patch centered on it, a circular-symmeric Gaussian kernel is used to compute the local mean, standard deviation and covariance terms <span class="math notranslate nohighlight">\(\mu_{X,i}, \mu_{Y,i}, \sigma_{X,i}, \sigma_{Y,i}, \sigma_{XY,i}\)</span>, where <span class="math notranslate nohighlight">\(i\)</span> is the pixel index. In this way we can obtain an SSIM map
<span class="math notranslate nohighlight">\(d_i(\mathbf{X}, \mathbf{Y})\)</span>. The values in the SSIM map are averaged to generate a single number, which is the SSIM index:</p>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}\text{SSIM}(\mathbf{X}, \mathbf{Y}) = \frac{1}{N} \sum_{i=1}^N d_i(\mathbf{X}, \mathbf{Y}) = \frac{1}{N} \sum_{i=1}^N l_i(\mathbf{X}, \mathbf{Y}) c_i(\mathbf{X}, \mathbf{Y}) s_i(\mathbf{X}, \mathbf{Y}) = \frac{1}{N} \sum_{i=1}^N \frac{\left( 2 \mu_{X,i} \mu_{Y,i} + C_1 \right) \left( 2\sigma_{XY,i} + C_2 \right)} {\left( {\mu_{X,i}}^2 + {\mu_{Y,i}}^2 + C_1 \right) \left( {\sigma_{X,i}}^2 + {\sigma_{Y,i}}^2 + C_2 \right)}\\where :math:`N` is the number of pixels of the image. The SSIM index is also bounded between -1 and 1. In ``plenoptic``, the SSIM map is computed by the function ``po.metric.ssim_map``, and the SSIM index itself is computed by the function ``po.metric.ssim``. For more information, see the original paper:\end{aligned}\end{align} \]</div>
<p>Wang, Z., Bovik, A. C., Sheikh, H. R., &amp; Simoncelli, E. P. (2004). Image quality assessment: from error visibility to structural similarity. <em>IEEE transactions on image processing</em>, 13(4), 600-612.</p>
</section>
</section>
<section id="Understanding-SSIM">
<h2>Understanding SSIM<a class="headerlink" href="#Understanding-SSIM" title="Link to this heading"></a></h2>
<p>We demonstrate the effectiveness of SSIM by generating five different types of distortions (contrast stretching, mean shifting, JPEG compression, blurring, and salt-pepper noise) with the same MSE, and computing their SSIM values.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add_jpeg_artifact</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">quality</span><span class="p">):</span>
    <span class="n">img</span> <span class="o">=</span> <span class="p">(</span><span class="n">img</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="n">buffer</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
    <span class="n">imageio</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;jpg&quot;</span><span class="p">,</span> <span class="n">quality</span><span class="o">=</span><span class="n">quality</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">imageio</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">buffer</span><span class="o">.</span><span class="n">getbuffer</span><span class="p">(),</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;jpg&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">/</span> <span class="mi">255</span>

<span class="k">def</span> <span class="nf">add_saltpepper_noise</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">threshold</span><span class="p">):</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">img_saltpepper</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span>
                <span class="n">img_saltpepper</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">threshold</span><span class="p">:</span>
                <span class="n">img_saltpepper</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">img_saltpepper</span>

<span class="k">def</span> <span class="nf">get_distorted_images</span><span class="p">():</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s2">&quot;../data/256/einstein.pgm&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">/</span> <span class="mi">255</span>  <span class="c1"># Image range has to be [0, 1]</span>
    <span class="n">img_contrast</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">img</span> <span class="o">+</span> <span class="mf">0.20515</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">img</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">a_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">a_max</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">img_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">img</span> <span class="o">+</span> <span class="mf">0.05983</span><span class="p">,</span> <span class="n">a_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">a_max</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">img_jpeg</span> <span class="o">=</span> <span class="n">add_jpeg_artifact</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">quality</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">img_blur</span> <span class="o">=</span> <span class="n">gaussian_filter</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">1.983</span><span class="p">)</span>
    <span class="n">img_saltpepper</span> <span class="o">=</span> <span class="n">add_saltpepper_noise</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.00651</span><span class="p">)</span>
    <span class="n">img_distorted</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">img</span><span class="p">,</span> <span class="n">img_contrast</span><span class="p">,</span> <span class="n">img_mean</span><span class="p">,</span> <span class="n">img_jpeg</span><span class="p">,</span> <span class="n">img_blur</span><span class="p">,</span> <span class="n">img_saltpepper</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">img_distorted</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">img_distorted</span> <span class="o">=</span> <span class="n">get_distorted_images</span><span class="p">()</span>
<span class="n">mse_values</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">img_distorted</span> <span class="o">-</span> <span class="n">img_distorted</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">ssim_values</span> <span class="o">=</span> <span class="n">po</span><span class="o">.</span><span class="n">metric</span><span class="o">.</span><span class="n">ssim</span><span class="p">(</span><span class="n">img_distorted</span><span class="p">,</span> <span class="n">img_distorted</span><span class="p">[[</span><span class="mi">0</span><span class="p">]])[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Original image&quot;</span><span class="p">,</span> <span class="s2">&quot;Contrast change&quot;</span><span class="p">,</span> <span class="s2">&quot;Mean shift&quot;</span><span class="p">,</span> <span class="s2">&quot;JPEG artifact&quot;</span><span class="p">,</span> <span class="s2">&quot;Gaussian blur&quot;</span><span class="p">,</span> <span class="s2">&quot;Salt-and-pepper noise&quot;</span><span class="p">]</span>
<span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">MSE=</span><span class="si">{</span><span class="n">mse_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">, SSIM=</span><span class="si">{</span><span class="n">ssim_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>
<span class="n">po</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_distorted</span><span class="p">,</span> <span class="n">vrange</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">titles</span><span class="p">,</span> <span class="n">col_wrap</span><span class="o">=</span><span class="mi">3</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_14525/543434810.py:5: DeprecationWarning: Starting with ImageIO v3 the behavior of this function will switch to that of iio.v3.imread. To keep the current behavior (and make this warning dissapear) use `import imageio.v2 as imageio` or call `imageio.v2.imread` directly.
  return imageio.imread(buffer.getbuffer(), format=&#34;jpg&#34;).astype(float) / 255
/home/zxy/miniconda3/envs/plenoptic/lib/python3.8/site-packages/torch/functional.py:478: UserWarning: torch.meshgrid: in an upcoming release, it will be required to pass the indexing argument. (Triggered internally at  ../aten/src/ATen/native/TensorShape.cpp:2895.)
  return _VF.meshgrid(tensors, **kwargs)  # type: ignore[attr-defined]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_models_04_Perceptual_distance_5_1.png" src="../../_images/tutorials_models_04_Perceptual_distance_5_1.png" />
</div>
</div>
<p>We can see that the SSIM index matches human perception better than MSE.</p>
<p>While the scalar SSIM index is a concise summary, the SSIM map offers richer information about where perceptual discrepancy is located in the image. Here, we visualize the SSIM map of a JPEG compressed image, and also show the absolute error (absolute value of the difference) for comparison. In both maps, darker means more different.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_demo_images</span><span class="p">():</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s2">&quot;../data/Parrot.png&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">img_jpeg</span> <span class="o">=</span> <span class="n">add_jpeg_artifact</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">quality</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">img_jpeg</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">img_jpeg</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">ssim_map_small</span> <span class="o">=</span> <span class="n">po</span><span class="o">.</span><span class="n">metric</span><span class="o">.</span><span class="n">ssim_map</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">img_jpeg</span><span class="p">)</span>
    <span class="n">ssim_map</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">ssim_map</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">5</span><span class="p">:</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">ssim_map_small</span>
    <span class="n">abs_map</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">img</span> <span class="o">-</span> <span class="n">img_jpeg</span><span class="p">)</span>
    <span class="n">img_demo</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">img</span><span class="p">,</span> <span class="n">img_jpeg</span><span class="p">,</span> <span class="n">ssim_map</span><span class="p">,</span> <span class="n">abs_map</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">img_demo</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">img_demo</span> <span class="o">=</span> <span class="n">get_demo_images</span><span class="p">()</span>
<span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Original&quot;</span><span class="p">,</span> <span class="s2">&quot;JPEG artifact&quot;</span><span class="p">,</span> <span class="s2">&quot;SSIM map&quot;</span><span class="p">,</span> <span class="s2">&quot;Absolute error&quot;</span><span class="p">]</span>
<span class="n">po</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_demo</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">titles</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_14525/543434810.py:5: DeprecationWarning: Starting with ImageIO v3 the behavior of this function will switch to that of iio.v3.imread. To keep the current behavior (and make this warning dissapear) use `import imageio.v2 as imageio` or call `imageio.v2.imread` directly.
  return imageio.imread(buffer.getbuffer(), format=&#34;jpg&#34;).astype(float) / 255
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_models_04_Perceptual_distance_8_1.png" src="../../_images/tutorials_models_04_Perceptual_distance_8_1.png" />
</div>
</div>
<p>You can judge whether the SSIM map captures the location of perceptual discrepancy better than absolute error.</p>
<section id="MS-SSIM-(multiscale-structural-similarity)">
<h3>MS-SSIM (multiscale structural similarity)<a class="headerlink" href="#MS-SSIM-(multiscale-structural-similarity)" title="Link to this heading"></a></h3>
<p>MS-SSIM computes SSIM on multiple scales of the images. To do this, the two images <span class="math notranslate nohighlight">\(\mathbf{X}\)</span> and <span class="math notranslate nohighlight">\(\mathbf{Y}\)</span> are recursively blurred and downsampled by a factor of 2 to produce two sequences of images: <span class="math notranslate nohighlight">\(\mathbf{X}_1, \cdots, \mathbf{X}_M\)</span> and <span class="math notranslate nohighlight">\(\mathbf{Y}_1, \cdots, \mathbf{Y}_M\)</span>, where <span class="math notranslate nohighlight">\(\mathbf{X}_1 = \mathbf{X}\)</span>, and <span class="math notranslate nohighlight">\(\mathbf{X}_{i+1}\)</span> is obtained by blurring and downsampling <span class="math notranslate nohighlight">\(\mathbf{X}_{i}\)</span> (same for <span class="math notranslate nohighlight">\(\mathbf{Y}\)</span>). Such a sequence is called
a Gaussian pyramid. We define a contrast-structural index that does not include luminance component:</p>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}\text{CS}(\mathbf{X}, \mathbf{Y}) = \frac{1}{N} \sum_{i=1}^N c_i(\mathbf{X}, \mathbf{Y}) s_i(\mathbf{X}, \mathbf{Y}) = \frac{1}{N} \sum_{i=1}^N \frac{2\sigma_{XY,i} + C_2} {{\sigma_{X,i}}^2 + {\sigma_{Y,i}}^2 + C_2}\\The MS-SSIM index is defined as:\end{aligned}\end{align} \]</div>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}\text{MS-SSIM}(\mathbf{X}, \mathbf{Y}) = \text{SSIM}(\mathbf{X}_M, \mathbf{Y}_M)^{\gamma_M} \prod_{k=1}^{M-1} \text{CS}(\mathbf{X}_i, \mathbf{Y}_i)^{\gamma_i}\\where :math:`\gamma_1, \cdots, \gamma_M` are exponents that determine the relative importance of different scales. They are determined by a human psychophysics experiment and are constrained to sum to 1. When :math:`M=1`, the MS-SSIM index is the same as the SSIM index. In the standard implementation of MS-SSIM, :math:`M = 5`. In ``plenoptic``, the MS-SSIM index is computed by the function ``po.metric.ms_ssim``. For more information, see the original paper:\end{aligned}\end{align} \]</div>
<p>Wang, Z., Simoncelli, E. P., &amp; Bovik, A. C. (2003, November). Multiscale structural similarity for image quality assessment. In <em>The Thrity-Seventh Asilomar Conference on Signals, Systems &amp; Computers</em>, 2003 (Vol. 2, pp. 1398-1402). IEEE.</p>
<p>Here we use the same distortions on Einstein image to demonstrate MS-SSIM:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">msssim_values</span> <span class="o">=</span> <span class="n">po</span><span class="o">.</span><span class="n">metric</span><span class="o">.</span><span class="n">ms_ssim</span><span class="p">(</span><span class="n">img_distorted</span><span class="p">,</span> <span class="n">img_distorted</span><span class="p">[[</span><span class="mi">0</span><span class="p">]])[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Original image&quot;</span><span class="p">,</span> <span class="s2">&quot;Contrast change&quot;</span><span class="p">,</span> <span class="s2">&quot;Mean shift&quot;</span><span class="p">,</span> <span class="s2">&quot;JPEG artifact&quot;</span><span class="p">,</span> <span class="s2">&quot;Gaussian blur&quot;</span><span class="p">,</span> <span class="s2">&quot;Salt-and-pepper noise&quot;</span><span class="p">]</span>
<span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">MSE=</span><span class="si">{</span><span class="n">mse_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">, MS-SSIM=</span><span class="si">{</span><span class="n">msssim_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>
<span class="n">po</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_distorted</span><span class="p">,</span> <span class="n">vrange</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">titles</span><span class="p">,</span> <span class="n">col_wrap</span><span class="o">=</span><span class="mi">3</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_models_04_Perceptual_distance_12_0.png" src="../../_images/tutorials_models_04_Perceptual_distance_12_0.png" />
</div>
</div>
</section>
<section id="NLPD-(normalized-Laplacian-pyramid-distance)">
<h3>NLPD (normalized Laplacian pyramid distance)<a class="headerlink" href="#NLPD-(normalized-Laplacian-pyramid-distance)" title="Link to this heading"></a></h3>
<p>Similar to MS-SSIM, the NLPD is also based on a multiscale representation of the images. Also similar to MS-SSIM, the idea of NLPD is also to separate out the effects of luminance and contrast difference. Unlike MS-SSIM, the NLPD directly performs luminance subtraction and contrast normalization on each scale, and then computes simple square difference. The NLPD uses the Laplacian pyramid for luminance subtraction. Given a Gaussian pyramid <span class="math notranslate nohighlight">\(\mathbf{X}_1, \cdots, \mathbf{X}_M\)</span>, for
<span class="math notranslate nohighlight">\(k=1, \cdots, M - 1\)</span>, we upsample and blur <span class="math notranslate nohighlight">\(\mathbf{X}_{k+1}\)</span> to produce <span class="math notranslate nohighlight">\(\mathbf{\hat{X}}_k\)</span>, which is a blurry version of <span class="math notranslate nohighlight">\(\mathbf{X}_k\)</span>, and let <span class="math notranslate nohighlight">\(\mathbf{X}'_k = \mathbf{X}_k - \mathbf{\hat{X}}_k\)</span>. Define <span class="math notranslate nohighlight">\(\mathbf{X}'_M = \mathbf{X}_M\)</span>, and we get the Laplacian pyramid <span class="math notranslate nohighlight">\(\mathbf{X}'_1, \cdots, \mathbf{X}'_M\)</span>. In <code class="docutils literal notranslate"><span class="pre">plenoptic</span></code>, the Laplacian pyramid is implemented by <code class="docutils literal notranslate"><span class="pre">po.simul.LaplacianPyramid</span></code>.</p>
<p>The contrast normalization is achieved by dividing by a local estimation of amplitude:</p>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}\mathbf{X}''_{k,i} = \frac{\mathbf{X}'_{k,i}} {f(\mathbf{X}'_{k,N(i)}; \sigma_k, \mathbf{p}_k)}, \qquad f(\mathbf{X}'_{k,N(i)}; \sigma_k, \mathbf{p}_k) = \sigma_k + \sum_{j\in N(i)} p_{k,j-i} |\mathbf{X}'_{k,j}|\\where :math:`N(i)` is the neighborhood of pixel :math:`i` which does not include :math:`i` itself, and the parameters :math:`\sigma_k` and :math:`\mathbf{p}_k` are learned from an image dataset:\end{aligned}\end{align} \]</div>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}\sigma_k = \mathbb{E}_{\mathbf{X},i} \left( |\mathbf{X}'_{k,i}| \right) \qquad \mathbf{p}_k = \arg\min_{\mathbf{p}_k} \mathbb{E}_{\mathbf{X},i} \left( \mathbf{X}'_{k,i} - f(\mathbf{X}'_{k,N(i)}; \sigma_k, \mathbf{p}_k) \right)^2\\Note that this learning is performed on the clean images only, without access to the corruption type or human phychophysics data. The sequence :math:`\mathbf{X}''_1, \cdots, \mathbf{X}''_M` is the normalized Laplacian pyramid. The same procudure is done for :math:`\mathbf{Y}`. The NLPD is defined as:\end{aligned}\end{align} \]</div>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}\text{NLPD}(\mathbf{X}, \mathbf{Y}) = \frac{1}{M} \sum_{k=1}^M \sqrt{\frac{1}{N_k} \sum_{i=1}^{N_k} (\mathbf{X}''_{k,i} - \mathbf{Y}''_{k,i})^2}\\where :math:`N_k` is the number of pixels of :math:`\mathbf{X}''_k`. In ``plenoptic``, the NLPD is computed by the function ``po.metric.nlpd``. For more information, see the original paper:\end{aligned}\end{align} \]</div>
<p>Laparra, V., Ballé, J., Berardino, A., &amp; Simoncelli, E. P. (2016). Perceptual image quality assessment using a normalized Laplacian pyramid. <em>Electronic Imaging</em>, 2016(16), 1-6.</p>
<p>Here we use the same distortions on Einstein image to demonstrate NLPD:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nlpd_values</span> <span class="o">=</span> <span class="n">po</span><span class="o">.</span><span class="n">metric</span><span class="o">.</span><span class="n">nlpd</span><span class="p">(</span><span class="n">img_distorted</span><span class="p">,</span> <span class="n">img_distorted</span><span class="p">[[</span><span class="mi">0</span><span class="p">]])[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Original image&quot;</span><span class="p">,</span> <span class="s2">&quot;Contrast change&quot;</span><span class="p">,</span> <span class="s2">&quot;Mean shift&quot;</span><span class="p">,</span> <span class="s2">&quot;JPEG artifact&quot;</span><span class="p">,</span> <span class="s2">&quot;Gaussian blur&quot;</span><span class="p">,</span> <span class="s2">&quot;Salt-and-pepper noise&quot;</span><span class="p">]</span>
<span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">MSE=</span><span class="si">{</span><span class="n">mse_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">, NLPD=</span><span class="si">{</span><span class="n">nlpd_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>
<span class="n">po</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_distorted</span><span class="p">,</span> <span class="n">vrange</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">titles</span><span class="p">,</span> <span class="n">col_wrap</span><span class="o">=</span><span class="mi">3</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_models_04_Perceptual_distance_15_0.png" src="../../_images/tutorials_models_04_Perceptual_distance_15_0.png" />
</div>
</div>
</section>
<section id="Usage">
<h3>Usage<a class="headerlink" href="#Usage" title="Link to this heading"></a></h3>
<p>The basic usage of <code class="docutils literal notranslate"><span class="pre">ssim</span></code>, <code class="docutils literal notranslate"><span class="pre">ms_ssim</span></code> and <code class="docutils literal notranslate"><span class="pre">nlpd</span></code> in the <code class="docutils literal notranslate"><span class="pre">po.metric</span></code> module is the same: they take two arguments that are images to be compared, whose shapes should be in the format <code class="docutils literal notranslate"><span class="pre">(batch,</span> <span class="pre">channel,</span> <span class="pre">height,</span> <span class="pre">width)</span></code>. All these functions are designed for grayscale images, so the channel dimension is treated as another batch dimension. The height and width of the two arguments should be the same, and the batch and channel sizes of the two arguments should be broadcastable. The broadcasting
is already demonstrated in the examples of SSIM, MS-SSIM and NLPD that use the Einstein image.</p>
<p>SSIM, MS-SSIM and NLPD are not scale-invariant. The input images should have values between 0 and 1. Otherwise, the result may be inaccurate, and we will raise a warning (but will still compute it).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Take SSIM as an example here. The images in img_demo have a range of [0, 1].</span>
<span class="n">val1</span> <span class="o">=</span> <span class="n">po</span><span class="o">.</span><span class="n">metric</span><span class="o">.</span><span class="n">ssim</span><span class="p">(</span><span class="n">img_demo</span><span class="p">[[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">img_demo</span><span class="p">[[</span><span class="mi">1</span><span class="p">]])</span>
<span class="n">val2</span> <span class="o">=</span> <span class="n">po</span><span class="o">.</span><span class="n">metric</span><span class="o">.</span><span class="n">ssim</span><span class="p">(</span><span class="n">img_demo</span><span class="p">[[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="mi">255</span><span class="p">,</span> <span class="n">img_demo</span><span class="p">[[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span>  <span class="c1"># This produces a wrong result and triggers a warning: Image range falls outside [0, 1].</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;True SSIM: </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">val1</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, rescaled image SSIM: </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">val2</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True SSIM: 0.7703, rescaled image SSIM: 0.4048
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/zxy/Documents/Thesis/plenoptic/plenoptic/metric/perceptual_distance.py:43: UserWarning: Image range falls outside [0, 1]. img1: tensor([ 14., 255.]), img2: tensor([  0., 255.]). Continuing anyway...
  warnings.warn(&#34;Image range falls outside [0, 1].&#34;
</pre></div></div>
</div>
</section>
<section id="Comparison-of-performance">
<h3>Comparison of performance<a class="headerlink" href="#Comparison-of-performance" title="Link to this heading"></a></h3>
<p>The performance of these perceptual distance metrics can be measured by the correlation with human psychophysics data: the TID2013 dataset consists of 3000 different distorted images (25 clean images x 24 types of distortions x 5 levels of distortions), each with its own mean opinion score (MOS; the perceived quality of the distorted image). Higher MOS means a smaller distance from its corresponding clean image. The TID2013 dataset is described in the following paper:</p>
<p>Ponomarenko, N., Jin, L., Ieremeiev, O., Lukin, V., Egiazarian, K., Astola, J., … &amp; Kuo, C. C. J. (2015). Image database TID2013: Peculiarities, results and perspectives. <em>Signal processing: Image communication</em>, 30, 57-77.</p>
<p>Since both SSIM and MS-SSIM have higher values for less different image pairs, and are maximized at 1 for identical images, we need to convert them to distances as 1-SSIM and 1-(MS-SSIM). Then we will plot MOS against the three metrics: 1-SSIM, 1-(MS-SSIM) and NLPD, as well as the baseline RMSE (square root of mean square error). We will also measure the correlation.</p>
<p>To execute this part of the notebook, the TID2013 dataset needs to be downloaded from the link <a class="reference external" href="http://www.ponomarenko.info/tid2013/tid2013.rar">http://www.ponomarenko.info/tid2013/tid2013.rar</a>, and extracted to a folder. You should name this folder as <code class="docutils literal notranslate"><span class="pre">tid2013</span></code> and put it under <code class="docutils literal notranslate"><span class="pre">../data/</span></code>. If you want to put it somewhere else, or you already have this dataset on your computer, you must change the <code class="docutils literal notranslate"><span class="pre">folder</span></code> argument of the <code class="docutils literal notranslate"><span class="pre">get_tid2013_data</span></code> function below.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_tid2013_data</span><span class="p">(</span><span class="n">folder</span><span class="o">=</span><span class="s2">&quot;../data/tid2013/&quot;</span><span class="p">):</span>
    <span class="n">reference_images</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">25</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">384</span><span class="p">,</span> <span class="mi">512</span><span class="p">])</span>
    <span class="n">distorted_images</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">25</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">384</span><span class="p">,</span> <span class="mi">512</span><span class="p">])</span>
    <span class="n">reference_filemap</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">reference_images/&quot;</span><span class="p">)}</span>
    <span class="n">distorted_filemap</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">distorted_images/&quot;</span><span class="p">)}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">):</span>
        <span class="n">reference_filename</span> <span class="o">=</span> <span class="n">reference_filemap</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;i</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">.bmp&quot;</span><span class="p">]</span>
        <span class="n">reference_images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">reference_images/</span><span class="si">{</span><span class="n">reference_filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;L&quot;</span><span class="p">)))</span> <span class="o">/</span> <span class="mi">255</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">24</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
                <span class="n">distorted_filename</span> <span class="o">=</span> <span class="n">distorted_filemap</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;i</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.bmp&quot;</span><span class="p">]</span>
                <span class="n">distorted_images</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">distorted_images/</span><span class="si">{</span><span class="n">distorted_filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;L&quot;</span><span class="p">)))</span> <span class="o">/</span> <span class="mi">255</span>
    <span class="n">distorted_images</span> <span class="o">=</span> <span class="n">distorted_images</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">17</span><span class="p">))</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">24</span><span class="p">))]</span>  <span class="c1"># Remove color distortions</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">mos.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">g</span><span class="p">:</span>
        <span class="n">mos_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">readlines</span><span class="p">()))</span>
    <span class="n">mos_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mos_values</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">25</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
    <span class="n">mos_values</span> <span class="o">=</span> <span class="n">mos_values</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">17</span><span class="p">))</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">24</span><span class="p">))]</span>  <span class="c1"># Remove color distortions</span>
    <span class="k">return</span> <span class="n">reference_images</span><span class="p">,</span> <span class="n">distorted_images</span><span class="p">,</span> <span class="n">mos_values</span>

<span class="k">def</span> <span class="nf">correlate_with_tid</span><span class="p">(</span><span class="n">func_list</span><span class="p">,</span> <span class="n">name_list</span><span class="p">):</span>
    <span class="n">reference_images</span><span class="p">,</span> <span class="n">distorted_images</span><span class="p">,</span> <span class="n">mos_values</span> <span class="o">=</span> <span class="n">get_tid2013_data</span><span class="p">()</span>
    <span class="n">distance</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">func_list</span><span class="p">),</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">func_list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">):</span>
            <span class="n">distance</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">reference_images</span><span class="p">[[</span><span class="n">j</span><span class="p">]],</span> <span class="n">distorted_images</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

    <span class="n">plot_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">func_list</span><span class="p">))))</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">plot_size</span><span class="p">,</span> <span class="n">plot_size</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">plot_size</span> <span class="o">*</span> <span class="mi">6</span><span class="p">,</span> <span class="n">plot_size</span> <span class="o">*</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">axs</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">edgecolor_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">]</span>
    <span class="n">facecolor_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">]</span>
    <span class="n">shape_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;^&quot;</span><span class="p">]</span>
    <span class="n">distortion_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Additive Gaussian noise&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Spatially correlated noise&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Masked noise&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;High frequency noise&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Impulse noise&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Quantization noise&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Gaussian blur&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Image denoising&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;JPEG compression&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;JPEG2000 compression&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;JPEG transmission errors&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;JPEG2000 transmission errors&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Non eccentricity pattern noise&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Local block-wise distortions of different intensity&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Mean shift (intensity shift)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Contrast change&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Multiplicative Gaussian noise&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Comfort noise&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Lossy compression of noisy images&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Image color quantization with dither&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Chromatic aberrations&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Sparse sampling and reconstruction&quot;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">name_list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">22</span><span class="p">):</span>
            <span class="n">edgecolor</span> <span class="o">=</span> <span class="n">edgecolor_list</span><span class="p">[</span><span class="n">j</span> <span class="o">%</span> <span class="mi">5</span><span class="p">]</span>
            <span class="n">facecolor</span> <span class="o">=</span> <span class="n">facecolor_list</span><span class="p">[</span><span class="n">j</span> <span class="o">//</span> <span class="mi">5</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">facecolor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">facecolor</span> <span class="o">=</span> <span class="n">edgecolor</span>
                <span class="n">edgecolor</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">distance</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">mos_values</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                           <span class="n">edgecolors</span><span class="o">=</span><span class="n">edgecolor</span><span class="p">,</span> <span class="n">facecolors</span><span class="o">=</span><span class="n">facecolor</span><span class="p">,</span>
                           <span class="n">marker</span><span class="o">=</span><span class="n">shape_list</span><span class="p">[</span><span class="n">j</span> <span class="o">//</span> <span class="mi">5</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">distortion_names</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="n">pearsonr_value</span> <span class="o">=</span> <span class="n">pearsonr</span><span class="p">(</span><span class="o">-</span><span class="n">mos_values</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">distance</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">spearmanr_value</span> <span class="o">=</span> <span class="n">spearmanr</span><span class="p">(</span><span class="o">-</span><span class="n">mos_values</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">distance</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;pearson </span><span class="si">{</span><span class="n">pearsonr_value</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, spearman </span><span class="si">{</span><span class="n">spearmanr_value</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;MOS&quot;</span><span class="p">)</span>
    <span class="n">lines</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower center&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">rmse</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">img2</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">img1</span> <span class="o">-</span> <span class="n">img2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">one_minus_ssim</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">img2</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">po</span><span class="o">.</span><span class="n">metric</span><span class="o">.</span><span class="n">ssim</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">img2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">one_minus_msssim</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">img2</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">po</span><span class="o">.</span><span class="n">metric</span><span class="o">.</span><span class="n">ms_ssim</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">img2</span><span class="p">)</span>

<span class="n">correlate_with_tid</span><span class="p">(</span><span class="n">func_list</span><span class="o">=</span><span class="p">[</span><span class="n">rmse</span><span class="p">,</span> <span class="n">one_minus_ssim</span><span class="p">,</span> <span class="n">one_minus_msssim</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">metric</span><span class="o">.</span><span class="n">nlpd</span><span class="p">],</span> <span class="n">name_list</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;RMSE&quot;</span><span class="p">,</span> <span class="s2">&quot;1 - SSIM&quot;</span><span class="p">,</span> <span class="s2">&quot;1 - (MS-SSIM)&quot;</span><span class="p">,</span> <span class="s2">&quot;NLPD&quot;</span><span class="p">])</span>  <span class="c1"># This takes some minutes to run</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_models_04_Perceptual_distance_21_0.png" src="../../_images/tutorials_models_04_Perceptual_distance_21_0.png" />
</div>
</div>
<p>Each point in the figures is a distorted image, and the color/shape indicates the distortion type. The goodness of the perceptual distance metrics can be qualitatively assessed by looking at how well the points follow a monotonic function, and how straight this monotonic function is. We can see that points for RMSE and 1-SSIM are more scattered than 1-(MS-SSIM) and NLPD. The points for NLPD follows a much straighter line than other methods. The points for RMSE have outliers belonging to certain
distortion types, notably mean shift and contrast change, while all three perceptual distance metrics are able to handle them better.</p>
<p>For a quantitative comparison, we calculate the Pearson’s and Spearman’s correlation coefficient between MOS and each perceptual distance metric (shown above the figures). Pearson’s correlation measures linear relationship, while Spearman’s correlation allows a nonlinear relationship since it only depends on ranking. We can see that the performance of the metrics, as measured by the correlation coefficients, is: NLPD &gt; MS-SSIM &gt; SSIM &gt; RMSE.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="03_Steerable_Pyramid.html" class="btn btn-neutral float-left" title="Steerable Pyramid" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Metamer-Portilla-Simoncelli.html" class="btn btn-neutral float-right" title="Portilla-Simoncelli Texture Metamer" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, Lab for Computational Vision.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>