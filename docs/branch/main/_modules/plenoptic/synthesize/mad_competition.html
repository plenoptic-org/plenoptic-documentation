
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>plenoptic.synthesize.mad_competition &#8212; plenoptic 1.3.2.dev304 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css?v=9c3e77be" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=d54d67fd" />
  
  <!-- So that users can add custom icons -->
  <script src="../../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../../_static/documentation_options.js?v=69473dd2"></script>
    <script src="../../../_static/doctools.js?v=fd6eb6e6"></script>
    <script src="../../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=6dbb43f8"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js?v=1ae7504c"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/plenoptic/synthesize/mad_competition';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.16.1';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://docs.plenoptic.org/docs/branch/main/_static/version_switcher.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = '1.3.2';
        DOCUMENTATION_OPTIONS.show_version_warning_banner =
            true;
        </script>
    <script src="../../../_static/custom-icon.js?v=0bae05a2"></script>
    <link rel="icon" href="../../../_static/plenoptic.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="1.3.2" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class=" navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/Plenoptic_Logo_CMYK_Full_Wide.svg" class="logo__image only-light" alt="plenoptic 1.3.2.dev304 documentation - Home"/>
    <img src="../../../_static/Plenoptic_Logo_CMYK_Full_DarkMode_Wide.svg" class="logo__image only-dark pst-js-only" alt="plenoptic 1.3.2.dev304 documentation - Home"/>
  
  
</a></div>
    
      <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-2"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-2"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-2"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-2">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
    
  </div>
  
  <div class=" navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../getting_started/index.html">
    Getting started
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../user_guide/index.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../api.html">
    API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../reference/index.html">
    Reference
  </a>
</li>

            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button"
                data-bs-toggle="dropdown" aria-expanded="false"
                aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
<li class=" ">
  <a class="nav-link dropdown-item nav-external" href="https://github.com/plenoptic-org/plenoptic/releases">
    Changelog
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../../../developers/index.html">
    For developers
  </a>
</li>

                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://plenoptic.org" title="Home" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-solid fa-house fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Home</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/plenoptic-org/plenoptic" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/plenoptic" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-custom fa-pypi fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../getting_started/index.html">
    Getting started
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../user_guide/index.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../api.html">
    API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../reference/index.html">
    Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://github.com/plenoptic-org/plenoptic/releases">
    Changelog
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../developers/index.html">
    For developers
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://plenoptic.org" title="Home" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-solid fa-house fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Home</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/plenoptic-org/plenoptic" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/plenoptic" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-custom fa-pypi fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">plenoptic.synthesize.mad_competition</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for plenoptic.synthesize.mad_competition</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Maximum Differentiation Competition.</span>

<span class="sd">Maximum Differentiation Competition synthesizes images which maximally distinguish</span>
<span class="sd">between a pair of metrics. Generally speaking, they are synthesized in pairs (two images</span>
<span class="sd">that one metric considers identical and the other considers as different as possible) or</span>
<span class="sd">groups of four (a pair of such pairs, one for each of the two metrics). They emphasize</span>
<span class="sd">the features that distinguish metrics, highlighting the features that one metric</span>
<span class="sd">considers important that the other is invariant to.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">contextlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Literal</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyrtools.tools.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_figure</span> <span class="k">as</span> <span class="n">pt_make_figure</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tensor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm.auto</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">..tools</span><span class="w"> </span><span class="kn">import</span> <span class="n">data</span><span class="p">,</span> <span class="n">display</span><span class="p">,</span> <span class="n">optim</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..tools.convergence</span><span class="w"> </span><span class="kn">import</span> <span class="n">_loss_convergence</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..tools.validate</span><span class="w"> </span><span class="kn">import</span> <span class="n">validate_input</span><span class="p">,</span> <span class="n">validate_metric</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.synthesis</span><span class="w"> </span><span class="kn">import</span> <span class="n">OptimizedSynthesis</span>


<div class="viewcode-block" id="MADCompetition">
<a class="viewcode-back" href="../../../generated/plenoptic.synthesize.mad_competition.MADCompetition.html#plenoptic.synthesize.mad_competition.MADCompetition">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">MADCompetition</span><span class="p">(</span><span class="n">OptimizedSynthesis</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Synthesize a single maximally-differentiating image for two metrics.</span>

<span class="sd">    Following the basic idea in [1]_, this class synthesizes a</span>
<span class="sd">    maximally-differentiating image for two given metrics, based on a given</span>
<span class="sd">    image. We start by adding noise to this image and then iteratively</span>
<span class="sd">    adjusting its pixels so as to either minimize or maximize</span>
<span class="sd">    ``optimized_metric`` while holding the value of ``reference_metric`` constant.</span>

<span class="sd">    MADCompetiton accepts two metrics as its input. These should be callables</span>
<span class="sd">    that take two images and return a single number, and that number should be</span>
<span class="sd">    0 if and only if the two images are identical (thus, the larger the number,</span>
<span class="sd">    the more different the two images).</span>

<span class="sd">    Note that a full set of MAD Competition images consists of two pairs: a maximal and</span>
<span class="sd">    a minimal image for each metric. A single instantiation of ``MADCompetition`` will</span>
<span class="sd">    generate one of these four images.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image</span>
<span class="sd">        A tensor, this is the image we use as the reference point.</span>
<span class="sd">    optimized_metric</span>
<span class="sd">        The metric whose value you wish to minimize or maximize, which takes</span>
<span class="sd">        two tensors and returns a scalar.</span>
<span class="sd">    reference_metric</span>
<span class="sd">        The metric whose value you wish to keep fixed, which takes two tensors</span>
<span class="sd">        and returns a scalar.</span>
<span class="sd">    minmax</span>
<span class="sd">        Whether you wish to minimize or maximize ``optimized_metric``.</span>
<span class="sd">    metric_tradeoff_lambda</span>
<span class="sd">        Lambda to multiply by ``reference_metric`` loss and add to</span>
<span class="sd">        ``optimized_metric`` loss. If ``None``, we pick a value so the two</span>
<span class="sd">        initial losses are approximately equal in magnitude.</span>
<span class="sd">    range_penalty_lambda</span>
<span class="sd">        Lambda to multiply by range penalty and add to loss.</span>
<span class="sd">    allowed_range</span>
<span class="sd">        Range (inclusive) of allowed pixel values. Any values outside this</span>
<span class="sd">        range will be penalized.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. [1] Wang, Z., &amp; Simoncelli, E. P. (2008). Maximum differentiation (MAD)</span>
<span class="sd">           competition: A methodology for comparing computational models of</span>
<span class="sd">           perceptual discriminability. Journal of Vision, 8(12), 1â€“13.</span>
<span class="sd">           https://dx.doi.org/10.1167/8.12.8</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
        <span class="n">optimized_metric</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span> <span class="o">|</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span> <span class="n">Tensor</span><span class="p">],</span>
        <span class="n">reference_metric</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span> <span class="o">|</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span> <span class="n">Tensor</span><span class="p">],</span>
        <span class="n">minmax</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">],</span>
        <span class="n">metric_tradeoff_lambda</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">range_penalty_lambda</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">allowed_range</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">range_penalty_lambda</span><span class="p">,</span> <span class="n">allowed_range</span><span class="p">)</span>
        <span class="n">validate_input</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">allowed_range</span><span class="o">=</span><span class="n">allowed_range</span><span class="p">)</span>
        <span class="n">validate_metric</span><span class="p">(</span>
            <span class="n">optimized_metric</span><span class="p">,</span>
            <span class="n">image_shape</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
            <span class="n">image_dtype</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">validate_metric</span><span class="p">(</span>
            <span class="n">reference_metric</span><span class="p">,</span>
            <span class="n">image_shape</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
            <span class="n">image_dtype</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_optimized_metric</span> <span class="o">=</span> <span class="n">optimized_metric</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reference_metric</span> <span class="o">=</span> <span class="n">reference_metric</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_image_shape</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scheduler</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scheduler_step_arg</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_optimized_metric_loss</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reference_metric_loss</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">minmax</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;synthesis_target must be one of {&#39;min&#39;, &#39;max&#39;}, but got &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;value </span><span class="si">{</span><span class="n">minmax</span><span class="si">}</span><span class="s2"> instead!&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mad_image</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initial_image</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reference_metric_target</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># If no metric_tradeoff_lambda is specified, pick one that gets them to</span>
        <span class="c1"># approximately the same magnitude</span>
        <span class="k">if</span> <span class="n">metric_tradeoff_lambda</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">other_image</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand_like</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
            <span class="n">optim_loss</span> <span class="o">=</span> <span class="n">optimized_metric</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">other_image</span><span class="p">)</span>
            <span class="n">loss_ratio</span> <span class="o">=</span> <span class="n">optim_loss</span> <span class="o">/</span> <span class="n">reference_metric</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">other_image</span><span class="p">)</span>
            <span class="n">metric_tradeoff_lambda</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">loss_ratio</span><span class="p">))</span>
            <span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Since metric_tradeoff_lamda was None, automatically set&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; to </span><span class="si">{</span><span class="n">metric_tradeoff_lambda</span><span class="si">}</span><span class="s2"> to roughly balance metrics.&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metric_tradeoff_lambda</span> <span class="o">=</span> <span class="n">metric_tradeoff_lambda</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_minmax</span> <span class="o">=</span> <span class="n">minmax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store_progress</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_saved_mad_image</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="MADCompetition.setup">
<a class="viewcode-back" href="../../../generated/plenoptic.synthesize.mad_competition.MADCompetition.html#plenoptic.synthesize.mad_competition.MADCompetition.setup">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">initial_noise</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">optimizer</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Optimizer</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">optimizer_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">scheduler</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">LRScheduler</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">scheduler_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the MAD image, optimizer, and scheduler.</span>

<span class="sd">        Can only be called once. If ``load()`` has been called, ``initial_noise`` must</span>
<span class="sd">        be None.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        initial_noise</span>
<span class="sd">            :attr:`mad_image` is initialized to ``self.image + initial_noise *</span>
<span class="sd">            torch.randn_like(self.image)``, so this gives the standard deviation of the</span>
<span class="sd">            Gaussian noise. If ``None``, we use a value of 0.1.</span>
<span class="sd">        optimizer</span>
<span class="sd">            The un-initialized optimizer object to use. If ``None``, we use Adam.</span>
<span class="sd">        optimizer_kwargs</span>
<span class="sd">            The keyword arguments to pass to the optimizer on initialization. If</span>
<span class="sd">            ``None``, we use ``{&quot;lr&quot;: .01}`` and, if optimizer is ``None``,</span>
<span class="sd">            ``{&quot;amsgrad&quot;: True}``.</span>
<span class="sd">        scheduler</span>
<span class="sd">            The un-initialized learning rate scheduler object to use. If ``None``, we</span>
<span class="sd">            don&#39;t use one.</span>
<span class="sd">        scheduler_kwargs</span>
<span class="sd">            The keyword arguments to pass to the scheduler on initialization.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If you try to set ``initial_noise`` after calling :func:`load`.</span>
<span class="sd">        ValueError</span>
<span class="sd">            If ``setup`` is called more than once or after :func:`synthesize`.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        Set initial noise:</span>

<span class="sd">        &gt;&gt;&gt; import plenoptic as po</span>
<span class="sd">        &gt;&gt;&gt; img = po.data.einstein()</span>
<span class="sd">        &gt;&gt;&gt; mad = po.synth.MADCompetition(</span>
<span class="sd">        ...     img,</span>
<span class="sd">        ...     lambda x, y: 1 - po.metric.ssim(x, y),</span>
<span class="sd">        ...     po.metric.mse,</span>
<span class="sd">        ...     &quot;min&quot;,</span>
<span class="sd">        ...     metric_tradeoff_lambda=0.1,</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; mad.setup(1)</span>
<span class="sd">        &gt;&gt;&gt; mad.synthesize(10)</span>

<span class="sd">        Set optimizer:</span>

<span class="sd">        &gt;&gt;&gt; import plenoptic as po</span>
<span class="sd">        &gt;&gt;&gt; img = po.data.einstein()</span>
<span class="sd">        &gt;&gt;&gt; mad = po.synth.MADCompetition(</span>
<span class="sd">        ...     img,</span>
<span class="sd">        ...     lambda x, y: 1 - po.metric.ssim(x, y),</span>
<span class="sd">        ...     po.metric.mse,</span>
<span class="sd">        ...     &quot;min&quot;,</span>
<span class="sd">        ...     metric_tradeoff_lambda=0.1,</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; mad.setup(optimizer=torch.optim.SGD, optimizer_kwargs={&quot;lr&quot;: 0.01})</span>
<span class="sd">        &gt;&gt;&gt; mad.synthesize(10)</span>

<span class="sd">        Use with save/load. Only the optimizer object is necessary, its kwargs and the</span>
<span class="sd">        initial noise are handled by load.</span>

<span class="sd">        &gt;&gt;&gt; import plenoptic as po</span>
<span class="sd">        &gt;&gt;&gt; img = po.data.einstein()</span>
<span class="sd">        &gt;&gt;&gt; mad = po.synth.MADCompetition(</span>
<span class="sd">        ...     img,</span>
<span class="sd">        ...     lambda x, y: 1 - po.metric.ssim(x, y),</span>
<span class="sd">        ...     po.metric.mse,</span>
<span class="sd">        ...     &quot;min&quot;,</span>
<span class="sd">        ...     metric_tradeoff_lambda=0.1,</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; mad.setup(1, optimizer=torch.optim.SGD, optimizer_kwargs={&quot;lr&quot;: 0.01})</span>
<span class="sd">        &gt;&gt;&gt; mad.synthesize(10)</span>
<span class="sd">        &gt;&gt;&gt; mad.save(&quot;mad_setup.pt&quot;)</span>
<span class="sd">        &gt;&gt;&gt; mad = po.synth.MADCompetition(</span>
<span class="sd">        ...     img,</span>
<span class="sd">        ...     lambda x, y: 1 - po.metric.ssim(x, y),</span>
<span class="sd">        ...     po.metric.mse,</span>
<span class="sd">        ...     &quot;min&quot;,</span>
<span class="sd">        ...     metric_tradeoff_lambda=0.1,</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; mad.load(&quot;mad_setup.pt&quot;)</span>
<span class="sd">        &gt;&gt;&gt; mad.setup(optimizer=torch.optim.SGD)</span>
<span class="sd">        &gt;&gt;&gt; mad.synthesize(10)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mad_image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">initial_noise</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">initial_noise</span> <span class="o">=</span> <span class="mf">0.1</span>
            <span class="n">mad_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">+</span> <span class="n">initial_noise</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
            <span class="n">mad_image</span> <span class="o">=</span> <span class="n">mad_image</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">allowed_range</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initial_image</span> <span class="o">=</span> <span class="n">mad_image</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
            <span class="n">mad_image</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mad_image</span> <span class="o">=</span> <span class="n">mad_image</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reference_metric_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_metric</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mad_image</span>
            <span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reference_metric_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_reference_metric_target</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_optimized_metric_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">optimized_metric</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mad_image</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loaded</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">initial_noise</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot set initial_noise after calling load()!&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;setup() can only be called once and must be called&quot;</span>
                    <span class="s2">&quot; before synthesize()!&quot;</span>
                <span class="p">)</span>

        <span class="c1"># initialize the optimizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_optimizer</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mad_image</span><span class="p">,</span> <span class="n">optimizer_kwargs</span><span class="p">)</span>
        <span class="c1"># and scheduler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_scheduler</span><span class="p">(</span><span class="n">scheduler</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">scheduler_kwargs</span><span class="p">)</span>
        <span class="c1"># reset _loaded, if everything ran successfully</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loaded</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="MADCompetition.synthesize">
<a class="viewcode-back" href="../../../generated/plenoptic.synthesize.mad_competition.MADCompetition.html#plenoptic.synthesize.mad_competition.MADCompetition.synthesize">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">synthesize</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">max_iter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">store_progress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">stop_criterion</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-4</span><span class="p">,</span>
        <span class="n">stop_iters_to_check</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Synthesize a MAD image.</span>

<span class="sd">        Update the pixels of :attr:`initial_image` to maximize or minimize</span>
<span class="sd">        (depending on the value of ``minmax``) the value of</span>
<span class="sd">        ``optimized_metric(image, mad_image)`` while keeping the value of</span>
<span class="sd">        ``reference_metric(image, mad_image)`` constant.</span>

<span class="sd">        We run this until either we reach ``max_iter`` or the loss changes less than</span>
<span class="sd">        ``stop_criterion`` over the past ``stop_iters_to_check`` iterations,</span>
<span class="sd">        whichever comes first.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        max_iter</span>
<span class="sd">            The maximum number of iterations to run before we end synthesis</span>
<span class="sd">            (unless we hit the stop criterion).</span>
<span class="sd">        store_progress</span>
<span class="sd">            Whether we should store the MAD image in progress during synthesis. If</span>
<span class="sd">            ``False``, we don&#39;t save anything. If True, we save every iteration. If an</span>
<span class="sd">            int, we save every ``store_progress`` iterations (note then that ``0`` is</span>
<span class="sd">            the same as ``False`` and ``1`` the same as ``True``).</span>
<span class="sd">        stop_criterion</span>
<span class="sd">            If the loss over the past ``stop_iters_to_check`` has changed</span>
<span class="sd">            less than ``stop_criterion``, we terminate synthesis.</span>
<span class="sd">        stop_iters_to_check</span>
<span class="sd">            How many iterations back to check in order to see if the</span>
<span class="sd">            loss has stopped decreasing (for ``stop_criterion``).</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If we find a NaN during optimization.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># if setup hasn&#39;t been called manually, call it now.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mad_image</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scheduler</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_loss</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># get ready to store progress</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store_progress</span> <span class="o">=</span> <span class="n">store_progress</span>

        <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">max_iter</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>
            <span class="c1"># update saved_* attrs. len(_losses) gives the total number of</span>
            <span class="c1"># iterations and will be correct across calls to `synthesize`</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_losses</span><span class="p">))</span>

            <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimizer_step</span><span class="p">(</span><span class="n">pbar</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">loss</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Found a NaN in loss during optimization.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_convergence</span><span class="p">(</span><span class="n">stop_criterion</span><span class="p">,</span> <span class="n">stop_iters_to_check</span><span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Loss has converged, stopping synthesis&quot;</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="c1"># compute current loss, no need to compute gradient</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_current_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective_function</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

        <span class="n">pbar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="MADCompetition.objective_function">
<a class="viewcode-back" href="../../../generated/plenoptic.synthesize.mad_competition.MADCompetition.html#plenoptic.synthesize.mad_competition.MADCompetition.objective_function">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">objective_function</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mad_image</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the MADCompetition synthesis loss.</span>

<span class="sd">        This computes:</span>

<span class="sd">        .. math::</span>

<span class="sd">            t L_1(x, \hat{x}) &amp;+ \lambda_1 [L_2(x, x+\epsilon) - L_2(x, \hat{x})]^2 \\</span>
<span class="sd">                              &amp;+ \lambda_2 \mathcal{B}(\hat{x})</span>

<span class="sd">        where :math:`t` is 1 if :attr:`minmax` is ``&#39;min&#39;`` and -1 if it&#39;s ``&#39;max&#39;``,</span>
<span class="sd">        :math:`L_1` is :attr:`optimized_metric`, :math:`L_2` is</span>
<span class="sd">        :attr:`reference_metric`, :math:`x` is :attr:`image`, :math:`\hat{x}` is</span>
<span class="sd">        :attr:`mad_image`, :math:`\epsilon` is the initial noise, :math:`\mathcal{B}` is</span>
<span class="sd">        the quadratic bound penalty, :math:`\lambda_1` is :attr:`metric_tradeoff_lambda`</span>
<span class="sd">        and :math:`\lambda_2` is :attr:`range_penalty_lambda`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mad_image</span>
<span class="sd">            Proposed ``mad_image``, :math:`\hat{x}` in the above equation. If</span>
<span class="sd">            ``None``, use ``self.mad_image``.</span>
<span class="sd">        image</span>
<span class="sd">            Proposed ``image``, :math:`x` in the above equation. If</span>
<span class="sd">            ``None``, use ``self.image``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        loss</span>
<span class="sd">            1-element tensor containing the loss on this step.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span>
        <span class="k">if</span> <span class="n">mad_image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mad_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mad_image</span>
            <span class="c1"># if this is empty, then self.mad_image hasn&#39;t been initialized</span>
            <span class="k">if</span> <span class="n">mad_image</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">synth_target</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">minmax</span><span class="p">]</span>
        <span class="n">synthesis_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimized_metric</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">mad_image</span><span class="p">)</span>
        <span class="n">fixed_loss</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reference_metric_target</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_metric</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">mad_image</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">range_penalty</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">penalize_range</span><span class="p">(</span><span class="n">mad_image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_range</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">synth_target</span> <span class="o">*</span> <span class="n">synthesis_loss</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric_tradeoff_lambda</span> <span class="o">*</span> <span class="n">fixed_loss</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">range_penalty_lambda</span> <span class="o">*</span> <span class="n">range_penalty</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="MADCompetition.get_progress">
<a class="viewcode-back" href="../../../generated/plenoptic.synthesize.mad_competition.MADCompetition.html#plenoptic.synthesize.mad_competition.MADCompetition.get_progress">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_progress</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">iteration</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">iteration_selection</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;floor&quot;</span><span class="p">,</span> <span class="s2">&quot;ceiling&quot;</span><span class="p">,</span> <span class="s2">&quot;round&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;round&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return dictionary summarizing synthesis progress at ``iteration``.</span>

<span class="sd">        This returns a dictionary containing info from :attr:`losses`,</span>
<span class="sd">        :attr:`pixel_change_norm`, :attr:`gradient_norm`, and</span>
<span class="sd">        :attr:`saved_mad_image` corresponding to ``iteration``. If synthesis was</span>
<span class="sd">        run with ``store_progress=False`` (and so we did not cache anything in</span>
<span class="sd">        :attr:`saved_mad_image`), then that key will be missing. If synthesis was</span>
<span class="sd">        run with ``store_progress&gt;1``, we will grab the corresponding tensor</span>
<span class="sd">        from :attr:`saved_mad_image`, with behavior determined by</span>
<span class="sd">        ``iteration_selection``.</span>

<span class="sd">        The returned dictionary will additionally contain the keys:</span>

<span class="sd">        - ``&quot;iteration&quot;``: the (0-indexed positive) synthesis iteration that the</span>
<span class="sd">          values for :attr:`losses`, :attr:`pixel_change_norm`, and</span>
<span class="sd">          :attr:`gradient_norm` come from.</span>

<span class="sd">        - If ``self.store_progress``, ``&quot;store_progress_iteration&quot;``: the (0-indexed</span>
<span class="sd">          positive) synthesis iteration that the value for :attr:`saved_mad_image` comes</span>
<span class="sd">          from.</span>

<span class="sd">        Note that for the most recent iteration (``iteration=-1`` or ``iteration=None``</span>
<span class="sd">        or ``iteration==len(self.losses)-1``), we do not have values for</span>
<span class="sd">        :attr:`pixel_change_norm` or :attr:`gradient_norm`, since in this case we are</span>
<span class="sd">        showing the loss and value for the current MAD image.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        iteration</span>
<span class="sd">            Synthesis iteration to summarize. If ``None``, grab the most recent.</span>
<span class="sd">            Negative values are allowed.</span>
<span class="sd">        iteration_selection</span>

<span class="sd">            How to select the relevant iteration from :attr:`saved_mad_image`</span>
<span class="sd">            when the request iteration wasn&#39;t stored.</span>

<span class="sd">            When synthesis was run with ``store_progress=n`` (where ``n&gt;1``),</span>
<span class="sd">            MAD images are only saved every ``n`` iterations. If you request an</span>
<span class="sd">            iteration where a MAD image wasn&#39;t saved, this determines which available</span>
<span class="sd">            iteration is used instead:</span>

<span class="sd">            * ``&quot;floor&quot;``: use the closest saved iteration **before** the</span>
<span class="sd">              requested one.</span>

<span class="sd">            * ``&quot;ceiling&quot;``: use the closest saved iteration **after** the</span>
<span class="sd">              requested one.</span>

<span class="sd">            * ``&quot;round&quot;``: use the closest saved iteration.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        progress_info</span>
<span class="sd">            Dictionary summarizing synthesis progress.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        IndexError</span>
<span class="sd">            If ``iteration`` takes an illegal value.</span>

<span class="sd">        Warns</span>
<span class="sd">        -----</span>
<span class="sd">        UserWarning</span>
<span class="sd">            If the iteration used for ``saved_mad_image`` is not the same as the</span>
<span class="sd">            argument ``iteration`` (because e.g., you set ``iteration=3`` but</span>
<span class="sd">            ``self.store_progress=2``).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_progress</span><span class="p">(</span>
            <span class="n">iteration</span><span class="p">,</span>
            <span class="n">iteration_selection</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;reference_metric_loss&quot;</span><span class="p">,</span> <span class="s2">&quot;optimized_metric_loss&quot;</span><span class="p">],</span>
            <span class="n">store_progress_attributes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;saved_mad_image&quot;</span><span class="p">],</span>
        <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_optimizer_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pbar</span><span class="p">:</span> <span class="n">tqdm</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute and propagate gradients, then step optimizer to update mad_image.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pbar</span>
<span class="sd">            A tqdm progress-bar, which we update with a postfix</span>
<span class="sd">            describing the current loss, gradient norm, and learning</span>
<span class="sd">            rate (it already tells us which iteration and the time</span>
<span class="sd">            elapsed).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        loss</span>
<span class="sd">            1-element tensor containing the loss on this step.</span>
<span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># numpydoc ignore=ES01</span>
        <span class="n">last_iter_mad_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mad_image</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_closure</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
        <span class="n">grad_norm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">vector_norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mad_image</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">ord</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gradient_norm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grad_norm</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>

        <span class="n">fm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_metric</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mad_image</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reference_metric_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fm</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimized_metric</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mad_image</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_optimized_metric_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sm</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>

        <span class="c1"># optionally step the scheduler, passing loss if needed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scheduler_step_arg</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

        <span class="n">pixel_change_norm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">vector_norm</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mad_image</span> <span class="o">-</span> <span class="n">last_iter_mad_image</span><span class="p">,</span> <span class="nb">ord</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pixel_change_norm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pixel_change_norm</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>

        <span class="c1"># add extra info here if you want it to show up in progress bar</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">(</span>
            <span class="n">OrderedDict</span><span class="p">(</span>
                <span class="n">loss</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">loss</span><span class="si">:</span><span class="s2">.04e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;lr&quot;</span><span class="p">],</span>
                <span class="n">gradient_norm</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">grad_norm</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.04e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">pixel_change_norm</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pixel_change_norm</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.04e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">reference_metric</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fm</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.04e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">optimized_metric</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sm</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.04e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">loss</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_convergence</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">stop_criterion</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">stop_iters_to_check</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether the loss has stabilized and, if so, return True.</span>

<span class="sd">        Uses :func:`~plenoptic.tools.convergence._loss_convergence`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        stop_criterion</span>
<span class="sd">            If the loss over the past ``stop_iters_to_check`` has changed</span>
<span class="sd">            less than ``stop_criterion``, we terminate synthesis.</span>
<span class="sd">        stop_iters_to_check</span>
<span class="sd">            How many iterations back to check in order to see if the</span>
<span class="sd">            loss has stopped decreasing (for ``stop_criterion``).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        loss_stabilized</span>
<span class="sd">            Whether the loss has stabilized or not.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_loss_convergence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stop_criterion</span><span class="p">,</span> <span class="n">stop_iters_to_check</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Store mad_image and model response, if appropriate.</span>

<span class="sd">        If it&#39;s the right iteration, we update :attr:`saved_mad_image`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        i</span>
<span class="sd">            The current iteration.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        stored</span>
<span class="sd">            True if we stored this iteration, False if not.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_progress</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_progress</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="c1"># want these to always be on cpu, to reduce memory use for GPUs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_saved_mad_image</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mad_image</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">))</span>
            <span class="n">stored</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stored</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">stored</span>

<div class="viewcode-block" id="MADCompetition.save">
<a class="viewcode-back" href="../../../generated/plenoptic.synthesize.mad_competition.MADCompetition.html#plenoptic.synthesize.mad_competition.MADCompetition.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save all relevant variables in .pt file.</span>

<span class="sd">        Note that if ``store_progress`` is True, this will probably be very</span>
<span class="sd">        large.</span>

<span class="sd">        See :func:`load` docstring for an example of use.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file_path</span>
<span class="sd">            The path to save the MADCompetition object to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">save_io_attrs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;_optimized_metric&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;_image&quot;</span><span class="p">,</span> <span class="s2">&quot;_mad_image&quot;</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;_reference_metric&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;_image&quot;</span><span class="p">,</span> <span class="s2">&quot;_mad_image&quot;</span><span class="p">)),</span>
        <span class="p">]</span>
        <span class="n">save_state_dict_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;_optimizer&quot;</span><span class="p">,</span> <span class="s2">&quot;_scheduler&quot;</span><span class="p">]</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">save_io_attrs</span><span class="p">,</span> <span class="n">save_state_dict_attrs</span><span class="p">)</span></div>


<div class="viewcode-block" id="MADCompetition.to">
<a class="viewcode-back" href="../../../generated/plenoptic.synthesize.mad_competition.MADCompetition.html#plenoptic.synthesize.mad_competition.MADCompetition.to">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Move and/or casts the parameters and buffers.</span>

<span class="sd">        This can be called as</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            to(device=None, dtype=None, non_blocking=False)</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            to(dtype, non_blocking=False)</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            to(tensor, non_blocking=False)</span>

<span class="sd">        Its signature is similar to :meth:`torch.Tensor.to`, but only accepts</span>
<span class="sd">        floating point desired ``dtype``. In addition, this method will</span>
<span class="sd">        only cast the floating point parameters and buffers to ``dtype``</span>
<span class="sd">        (if given). The integral parameters and buffers will be moved</span>
<span class="sd">        ``device``, if that is given, but with dtypes unchanged. When</span>
<span class="sd">        `on_blocking`` is set, it tries to convert/move asynchronously</span>
<span class="sd">        with respect to the host if possible, e.g., moving CPU Tensors with</span>
<span class="sd">        pinned memory to CUDA devices.</span>

<span class="sd">        See :meth:`torch.nn.Module.to` for examples.</span>

<span class="sd">        .. note::</span>
<span class="sd">            This method modifies the module in-place.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        device : torch.device</span>
<span class="sd">            The desired device of the parameters and buffers in this module.</span>
<span class="sd">        dtype : torch.dtype</span>
<span class="sd">            The desired floating point type of the floating point parameters and</span>
<span class="sd">            buffers in this module.</span>
<span class="sd">        tensor : torch.Tensor</span>
<span class="sd">            Tensor whose dtype and device are the desired dtype and device for</span>
<span class="sd">            all parameters and buffers in this module.</span>
<span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># numpydoc ignore=PR01,PR02</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;_initial_image&quot;</span><span class="p">,</span> <span class="s2">&quot;_image&quot;</span><span class="p">,</span> <span class="s2">&quot;_mad_image&quot;</span><span class="p">,</span> <span class="s2">&quot;_saved_mad_image&quot;</span><span class="p">]</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="n">attrs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># if the metrics are Modules, then we should pass them as well. If</span>
        <span class="c1"># they&#39;re functions then nothing needs to be done.</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reference_metric</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimized_metric</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="MADCompetition.load">
<a class="viewcode-back" href="../../../generated/plenoptic.synthesize.mad_competition.MADCompetition.html#plenoptic.synthesize.mad_competition.MADCompetition.load">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">map_location</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tensor_equality_atol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-8</span><span class="p">,</span>
        <span class="n">tensor_equality_rtol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-5</span><span class="p">,</span>
        <span class="o">**</span><span class="n">pickle_load_args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load all relevant stuff from a .pt file.</span>

<span class="sd">        This must be called by a ``MADCompetition`` object initialized just like the</span>
<span class="sd">        saved object.</span>

<span class="sd">        Note this operates in place and so doesn&#39;t return anything.</span>

<span class="sd">        .. versionchanged:: 1.2</span>
<span class="sd">           load behavior changed in a backwards-incompatible manner in order to</span>
<span class="sd">           compatible with breaking changes in torch 2.6.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file_path</span>
<span class="sd">            The path to load the synthesis object from.</span>
<span class="sd">        map_location</span>
<span class="sd">            Argument to pass to ``torch.load`` as ``map_location``. If you save</span>
<span class="sd">            stuff that was being run on a GPU and are loading onto a</span>
<span class="sd">            CPU, you&#39;ll need this to make sure everything lines up</span>
<span class="sd">            properly. This should be structured like the str you would</span>
<span class="sd">            pass to :class:`torch.device`.</span>
<span class="sd">        tensor_equality_atol</span>
<span class="sd">            Absolute tolerance to use when checking for tensor equality during load,</span>
<span class="sd">            passed to :func:`torch.allclose`. It may be necessary to increase if you are</span>
<span class="sd">            saving and loading on two machines with torch built by different cuda</span>
<span class="sd">            versions. Be careful when changing this! See</span>
<span class="sd">            :class:`torch.finfo&lt;torch.torch.finfo&gt;` for more details about floating</span>
<span class="sd">            point precision of different data types (especially, ``eps``); if you have</span>
<span class="sd">            to increase this by more than 1 or 2 decades, then you are probably not</span>
<span class="sd">            dealing with a numerical issue.</span>
<span class="sd">        tensor_equality_rtol</span>
<span class="sd">            Relative tolerance to use when checking for tensor equality during load,</span>
<span class="sd">            passed to :func:`torch.allclose`. It may be necessary to increase if you are</span>
<span class="sd">            saving and loading on two machines with torch built by different cuda</span>
<span class="sd">            versions. Be careful when changing this! See</span>
<span class="sd">            :class:`torch.finfo&lt;torch.torch.finfo&gt;` for more details about floating</span>
<span class="sd">            point precision of different data types (especially, ``eps``); if you have</span>
<span class="sd">            to increase this by more than 1 or 2 decades, then you are probably not</span>
<span class="sd">            dealing with a numerical issue.</span>
<span class="sd">        **pickle_load_args</span>
<span class="sd">            Any additional kwargs will be added to ``pickle_module.load`` via</span>
<span class="sd">            :func:`torch.load`, see that function&#39;s docstring for details.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If :func:`setup` or :func:`synthesize` has been called before this call</span>
<span class="sd">            to ``load``.</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the object saved at ``file_path`` is not a ``MADCompetition`` object.</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the saved and loading ``MADCompetition`` objects have a different value</span>
<span class="sd">            for any of :attr:`image`, :attr:`range_penalty_lambda`,</span>
<span class="sd">            :attr:`allowed_range`, :attr:`metric_tradeoff_lambda`, or :attr:`minmax`.</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the behavior of :attr:`optimized_metric` or :attr:`reference_metric` is</span>
<span class="sd">            different between the saved and loading objects.</span>

<span class="sd">        Warns</span>
<span class="sd">        -----</span>
<span class="sd">        UserWarning</span>
<span class="sd">            If :func:`setup` will need to be called after ``load``, to finish</span>
<span class="sd">            initializing :attr:`optimizer` or :attr:`scheduler`.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :func:`~plenoptic.tools.io.examine_saved_synthesis`</span>
<span class="sd">            Examine metadata from saved object: pytorch and plenoptic versions, name of</span>
<span class="sd">            the synthesis object, shapes of tensors, etc.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; import plenoptic as po</span>
<span class="sd">        &gt;&gt;&gt; img = po.data.einstein()</span>
<span class="sd">        &gt;&gt;&gt; def ds_ssim(x, y):</span>
<span class="sd">        ...     return 1 - po.metric.ssim(x, y)</span>
<span class="sd">        &gt;&gt;&gt; mad = po.synth.MADCompetition(</span>
<span class="sd">        ...     img, po.metric.mse, ds_ssim, &quot;min&quot;, metric_tradeoff_lambda=10</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; mad.synthesize(max_iter=5, store_progress=True)</span>
<span class="sd">        &gt;&gt;&gt; mad.save(&quot;mad.pt&quot;)</span>
<span class="sd">        &gt;&gt;&gt; mad_copy = po.synth.MADCompetition(</span>
<span class="sd">        ...     img, po.metric.mse, ds_ssim, &quot;min&quot;, metric_tradeoff_lambda=10</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; mad_copy.load(&quot;mad.pt&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_attributes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;_image&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_metric_tradeoff_lambda&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_range_penalty_lambda&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_allowed_range&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_minmax&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">check_io_attrs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;_optimized_metric&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;_image&quot;</span><span class="p">,</span> <span class="s2">&quot;_mad_image&quot;</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;_reference_metric&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;_image&quot;</span><span class="p">,</span> <span class="s2">&quot;_mad_image&quot;</span><span class="p">)),</span>
        <span class="p">]</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
            <span class="n">file_path</span><span class="p">,</span>
            <span class="s2">&quot;losses&quot;</span><span class="p">,</span>
            <span class="n">map_location</span><span class="o">=</span><span class="n">map_location</span><span class="p">,</span>
            <span class="n">check_attributes</span><span class="o">=</span><span class="n">check_attributes</span><span class="p">,</span>
            <span class="n">check_io_attributes</span><span class="o">=</span><span class="n">check_io_attrs</span><span class="p">,</span>
            <span class="n">state_dict_attributes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;_optimizer&quot;</span><span class="p">,</span> <span class="s2">&quot;_scheduler&quot;</span><span class="p">],</span>
            <span class="n">tensor_equality_atol</span><span class="o">=</span><span class="n">tensor_equality_atol</span><span class="p">,</span>
            <span class="n">tensor_equality_rtol</span><span class="o">=</span><span class="n">tensor_equality_rtol</span><span class="p">,</span>
            <span class="o">**</span><span class="n">pickle_load_args</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># make this require a grad again</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mad_image</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">()</span>
        <span class="c1"># these are always supposed to be on cpu, but may get copied over to</span>
        <span class="c1"># gpu on load (which can cause problems when resuming synthesis), so</span>
        <span class="c1"># fix that.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_saved_mad_image</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saved_mad_image</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s2">&quot;cpu&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_saved_mad_image</span> <span class="o">=</span> <span class="p">[</span><span class="n">mad</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">mad</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saved_mad_image</span><span class="p">]</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mad_image</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Maximally-differentiating image, the parameter we are optimizing.&quot;&quot;&quot;</span>
        <span class="c1"># numpydoc ignore=RT01,ES01</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mad_image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mad_image</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">optimized_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span> <span class="o">|</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span> <span class="n">Tensor</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The metric whose value we are minimizing or maximizing.&quot;&quot;&quot;</span>
        <span class="c1"># numpydoc ignore=RT01,ES01</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimized_metric</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">reference_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span> <span class="o">|</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span> <span class="n">Tensor</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The metric whose value we are keeping constant.&quot;&quot;&quot;</span>
        <span class="c1"># numpydoc ignore=RT01,ES01</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reference_metric</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">image</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The reference image for this MAD Competition.&quot;&quot;&quot;</span>
        <span class="c1"># numpydoc ignore=RT01,ES01</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">initial_image</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initial image for MAD Competition.</span>

<span class="sd">        This is the image whose distance to ``image``, the reference, we are</span>
<span class="sd">        maximizing/minimizing for ``optimized_metric``, while keeping constant for</span>
<span class="sd">        ``reference_metric``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># numpydoc ignore=RT01</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initial_image</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">reference_metric_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :attr:`reference_metric` loss over iterations.</span>

<span class="sd">        That is, the value of ``reference_metric(image, mad_image)``. Ideally, this is</span>
<span class="sd">        equal to ``reference_metric(image, initial_image)``.</span>

<span class="sd">        This tensor always lives on the CPU, regardless of the device of the</span>
<span class="sd">        ``MADCompetition`` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># numpydoc ignore=RT01</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_reference_metric_loss</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">optimized_metric_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :attr:`optimized_metric` loss over iterations.</span>

<span class="sd">        That is, the value of ``optimized_metric(image, mad_image)``. Ideally, this is</span>
<span class="sd">        either very different from ``optimized_metric(image, initial_image)``.</span>

<span class="sd">        This tensor always lives on the CPU, regardless of the device of the</span>
<span class="sd">        ``MADCompetition`` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># numpydoc ignore=RT01</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_optimized_metric_loss</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">metric_tradeoff_lambda</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tradeoff between the two metrics in synthesis loss.&quot;&quot;&quot;</span>
        <span class="c1"># numpydoc ignore=RT01,ES01</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metric_tradeoff_lambda</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">minmax</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Whether we are minimizing or maximizing :attr:`optimized_metric`.&quot;&quot;&quot;</span>
        <span class="c1"># numpydoc ignore=RT01,ES01</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_minmax</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">saved_mad_image</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :attr:`mad_image`, cached over time for later examination.</span>

<span class="sd">        How often the MAD image is cached is determined by the ``store_progress``</span>
<span class="sd">        argument to the :func:`synthesize` function.</span>

<span class="sd">        The last entry will always be the current :attr:`mad_image`.</span>

<span class="sd">        If ``store_progress==1``, then this corresponds directly to :attr:`losses`:</span>
<span class="sd">        ``losses[i]`` is the error for ``saved_mad_image[i]``</span>

<span class="sd">        This tensor always lives on the CPU, regardless of the device of the</span>
<span class="sd">        ``MADCompetition`` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># numpydoc ignore=RT01</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mad_image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># for memory purposes, always on CPU</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_saved_mad_image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mad_image</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)])</span></div>



<div class="viewcode-block" id="plot_loss">
<a class="viewcode-back" href="../../../generated/plenoptic.synthesize.mad_competition.html#plenoptic.synthesize.mad_competition.plot_loss">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_loss</span><span class="p">(</span>
    <span class="n">mad</span><span class="p">:</span> <span class="n">MADCompetition</span><span class="p">,</span>
    <span class="n">iteration</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">axes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">mpl</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">Axes</span><span class="p">]</span> <span class="o">|</span> <span class="n">mpl</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">mpl</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot metric losses.</span>

<span class="sd">    Plots ``mad.optimized_metric_loss`` and ``mad.reference_metric_loss`` on two</span>
<span class="sd">    separate axes, over all iterations. Also plots a red dot at ``iteration``,</span>
<span class="sd">    to highlight the loss there. If ``iteration=None``, then the dot will be at</span>
<span class="sd">    the final iteration.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mad</span>
<span class="sd">        MADCompetition object whose loss we want to plot.</span>
<span class="sd">    iteration</span>
<span class="sd">        Which iteration to display. If ``None``, we show the most recent one.</span>
<span class="sd">        Negative values are also allowed.</span>
<span class="sd">    axes</span>
<span class="sd">        Pre-existing axes for plot. If a list of axes, must be the two axes to</span>
<span class="sd">        use for this plot. If a single axis, we&#39;ll split it in half</span>
<span class="sd">        horizontally. If ``None``, we call :func:`matplotlib.pyplot.gca()`.</span>
<span class="sd">    **kwargs</span>
<span class="sd">        Passed to :func:`matplotlib.pyplot.semilogy`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    axes :</span>
<span class="sd">        The matplotlib axes containing the plot.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    IndexError</span>
<span class="sd">        If ``iteration`` takes an illegal value.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    We plot ``abs(mad.losses)`` because if we&#39;re maximizing the synthesis</span>
<span class="sd">    metric, we minimized its negative. By plotting the absolute value, we get</span>
<span class="sd">    them all on the same scale.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># this warning is not relevant for this plotting function</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;loss iteration and iteration for&quot;</span><span class="p">)</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="n">mad</span><span class="o">.</span><span class="n">get_progress</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">axes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">display</span><span class="o">.</span><span class="n">clean_up_axes</span><span class="p">(</span>
            <span class="n">axes</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="s2">&quot;left&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">gs</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">get_subplotspec</span><span class="p">()</span><span class="o">.</span><span class="n">subgridspec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">figure</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])]</span>
    <span class="n">losses</span> <span class="o">=</span> <span class="p">[</span><span class="n">mad</span><span class="o">.</span><span class="n">reference_metric_loss</span><span class="p">,</span> <span class="n">mad</span><span class="o">.</span><span class="n">optimized_metric_loss</span><span class="p">]</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;reference_metric_loss&quot;</span><span class="p">,</span> <span class="s2">&quot;optimized_metric_loss&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">losses</span><span class="p">,</span> <span class="n">names</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">progress</span><span class="p">[</span><span class="s2">&quot;iteration&quot;</span><span class="p">],</span> <span class="n">progress</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Synthesis iteration&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="n">name</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ax</span></div>



<div class="viewcode-block" id="display_mad_image">
<a class="viewcode-back" href="../../../generated/plenoptic.synthesize.mad_competition.html#plenoptic.synthesize.mad_competition.display_mad_image">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">display_mad_image</span><span class="p">(</span>
    <span class="n">mad</span><span class="p">:</span> <span class="n">MADCompetition</span><span class="p">,</span>
    <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">channel_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">zoom</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">iteration</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ax</span><span class="p">:</span> <span class="n">mpl</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">mpl</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display MAD image.</span>

<span class="sd">    We use :func:`~plenoptic.tools.display.imshow` to display the synthesized image and</span>
<span class="sd">    attempt to automatically find the most reasonable zoom value. You can override this</span>
<span class="sd">    value using the zoom arg, but remember that :func:`~plenoptic.tools.display.imshow`</span>
<span class="sd">    is opinionated about the size of the resulting image and will throw an Exception if</span>
<span class="sd">    the axis created is not big enough for the selected zoom.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mad</span>
<span class="sd">        MADCompetition object whose MAD image we want to display.</span>
<span class="sd">    batch_idx</span>
<span class="sd">        Which index to take from the batch dimension.</span>
<span class="sd">    channel_idx</span>
<span class="sd">        Which index to take from the channel dimension. If ``None``, we assume</span>
<span class="sd">        image is RGB(A) and show all channels.</span>
<span class="sd">    zoom</span>
<span class="sd">        How much to zoom in / enlarge the synthesized image, the ratio</span>
<span class="sd">        of display pixels to image pixels. If ``None``, we</span>
<span class="sd">        attempt to find the best value ourselves.</span>
<span class="sd">    iteration</span>
<span class="sd">        Which iteration to display. If ``None``, we show the most recent one.</span>
<span class="sd">        Negative values are also allowed. If ``iteration!=None`` and</span>
<span class="sd">        ``mad.store_progress&gt;1`` (that is, the MAD image was not cached on every</span>
<span class="sd">        iteration), then we show the cached MAD image from the nearest iteration.</span>
<span class="sd">    ax</span>
<span class="sd">        Pre-existing axes for plot. If ``None``, we call :func:`matplotlib.pyplot.gca`.</span>
<span class="sd">    title</span>
<span class="sd">        Title to add to axis. If ``None``, we use ``&quot;MAD Image [iteration={iter}]&quot;``,</span>
<span class="sd">        where ``iter`` gives the iteration corresponding to the displayed image.</span>
<span class="sd">    **kwargs</span>
<span class="sd">        Passed to :func:`~plenoptic.tools.display.imshow`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ax :</span>
<span class="sd">        The matplotlib axes containing the plot.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If ``batch_idx`` is not an int.</span>
<span class="sd">    IndexError</span>
<span class="sd">        If ``iteration`` takes an illegal value.</span>

<span class="sd">    Warns</span>
<span class="sd">    -----</span>
<span class="sd">    UserWarning</span>
<span class="sd">        If the iteration used for ``saved_mad_image`` is not the same as the argument</span>
<span class="sd">        ``iteration`` (because e.g., you set ``iteration=3`` but</span>
<span class="sd">        ``mad.store_progress=2``).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">progress</span> <span class="o">=</span> <span class="n">mad</span><span class="o">.</span><span class="n">get_progress</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">progress</span><span class="p">[</span><span class="s2">&quot;saved_mad_image&quot;</span><span class="p">]</span>
        <span class="nb">iter</span> <span class="o">=</span> <span class="n">progress</span><span class="p">[</span><span class="s2">&quot;store_progress_iteration&quot;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">iteration</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;When mad.store_progress=False, iteration must be None!&quot;</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">mad</span><span class="o">.</span><span class="n">mad_image</span>
        <span class="c1"># losses will always have one extra value, the current loss.</span>
        <span class="nb">iter</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mad</span><span class="o">.</span><span class="n">losses</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">batch_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;batch_idx must be an integer!&quot;</span><span class="p">)</span>
    <span class="c1"># we&#39;re only plotting one image here, so if the user wants multiple</span>
    <span class="c1"># channels, they must be RGB</span>
    <span class="n">as_rgb</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">channel_idx</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;MAD Image [iteration=</span><span class="si">{</span><span class="nb">iter</span><span class="si">}</span><span class="s2">]&quot;</span>
    <span class="n">display</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
        <span class="n">image</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
        <span class="n">zoom</span><span class="o">=</span><span class="n">zoom</span><span class="p">,</span>
        <span class="n">batch_idx</span><span class="o">=</span><span class="n">batch_idx</span><span class="p">,</span>
        <span class="n">channel_idx</span><span class="o">=</span><span class="n">channel_idx</span><span class="p">,</span>
        <span class="n">as_rgb</span><span class="o">=</span><span class="n">as_rgb</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ax</span></div>



<div class="viewcode-block" id="plot_pixel_values">
<a class="viewcode-back" href="../../../generated/plenoptic.synthesize.mad_competition.html#plenoptic.synthesize.mad_competition.plot_pixel_values">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_pixel_values</span><span class="p">(</span>
    <span class="n">mad</span><span class="p">:</span> <span class="n">MADCompetition</span><span class="p">,</span>
    <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">channel_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">iteration</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ylim</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">ax</span><span class="p">:</span> <span class="n">mpl</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">mpl</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot histogram of pixel values of reference and MAD images.</span>

<span class="sd">    As a way to check the distributions of pixel intensities and see</span>
<span class="sd">    if there&#39;s any values outside the allowed range.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mad</span>
<span class="sd">        MADCompetition object with the images whose pixel values we want to compare.</span>
<span class="sd">    batch_idx</span>
<span class="sd">        Which index to take from the batch dimension.</span>
<span class="sd">    channel_idx</span>
<span class="sd">        Which index to take from the channel dimension. If ``None``, we use all</span>
<span class="sd">        channels (assumed use-case is RGB(A) images).</span>
<span class="sd">    iteration</span>
<span class="sd">        Which iteration to display. If ``None``, we show the most recent one.</span>
<span class="sd">        Negative values are also allowed. If ``iteration!=None`` and</span>
<span class="sd">        ``mad.store_progress&gt;1`` (that is, the MAD image was not cached on every</span>
<span class="sd">        iteration), then we use the cached MAD image from the nearest iteration.</span>
<span class="sd">    ylim</span>
<span class="sd">        If tuple, the ylimit to set for this axis. If ``False``, we leave</span>
<span class="sd">        it untouched.</span>
<span class="sd">    ax</span>
<span class="sd">        Pre-existing axes for plot. If ``None``, we call</span>
<span class="sd">        :func:`matplotlib.pyplot.gca()`.</span>
<span class="sd">    **kwargs</span>
<span class="sd">        Passed to :func:`matplotlib.pyplot.hist`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ax :</span>
<span class="sd">        Creates axes.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    IndexError</span>
<span class="sd">        If ``iteration`` takes an illegal value.</span>

<span class="sd">    Warns</span>
<span class="sd">    -----</span>
<span class="sd">    UserWarning</span>
<span class="sd">        If the iteration used for ``saved_mad_image`` is not the same as the argument</span>
<span class="sd">        ``iteration`` (because e.g., you set ``iteration=3`` but</span>
<span class="sd">        ``mad.store_progress=2``).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_freedman_diaconis_bins</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate number of hist bins using Freedman-Diaconis rule.</span>

<span class="sd">        Copied from seaborn.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        a</span>
<span class="sd">            The array to histogram.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        n_bins</span>
<span class="sd">            Number of bins to use for histogram.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># From https://stats.stackexchange.com/questions/798/</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">iqr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="n">h</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">iqr</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">))</span>
        <span class="c1"># fall back to sqrt(a) bins if iqr is 0</span>
        <span class="k">if</span> <span class="n">h</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">a</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">a</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="n">h</span><span class="p">))</span>

    <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">)</span>
    <span class="n">progress</span> <span class="o">=</span> <span class="n">mad</span><span class="o">.</span><span class="n">get_progress</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">mad_image</span> <span class="o">=</span> <span class="n">progress</span><span class="p">[</span><span class="s2">&quot;saved_mad_image&quot;</span><span class="p">]</span>
        <span class="nb">iter</span> <span class="o">=</span> <span class="n">progress</span><span class="p">[</span><span class="s2">&quot;store_progress_iteration&quot;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">iteration</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;When mad.store_progress=False, iteration must be None!&quot;</span><span class="p">)</span>
        <span class="n">mad_image</span> <span class="o">=</span> <span class="n">mad</span><span class="o">.</span><span class="n">mad_image</span>
        <span class="c1"># losses will always have one extra value, the current loss.</span>
        <span class="nb">iter</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mad</span><span class="o">.</span><span class="n">losses</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">mad</span><span class="o">.</span><span class="n">image</span><span class="p">[</span><span class="n">batch_idx</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">channel_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">channel_idx</span><span class="p">]</span>
        <span class="n">mad_image</span> <span class="o">=</span> <span class="n">mad_image</span><span class="p">[</span><span class="n">channel_idx</span><span class="p">]</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">image</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">mad_image</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">mad_image</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
        <span class="n">mad_image</span><span class="p">,</span>
        <span class="n">bins</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">_freedman_diaconis_bins</span><span class="p">(</span><span class="n">image</span><span class="p">),</span> <span class="mi">50</span><span class="p">),</span>
        <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;MAD image [iteration=</span><span class="si">{</span><span class="nb">iter</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
        <span class="n">image</span><span class="p">,</span>
        <span class="n">bins</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">_freedman_diaconis_bins</span><span class="p">(</span><span class="n">image</span><span class="p">),</span> <span class="mi">50</span><span class="p">),</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Reference image&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ylim</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Histogram of pixel values&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ax</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_check_included_plots</span><span class="p">(</span><span class="n">to_check</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">to_check_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check whether the user wanted us to create plots that we can&#39;t.</span>

<span class="sd">    Helper function for :func:`plot_synthesis_status` and :func:`animate`.</span>

<span class="sd">    Raises a ``ValueError`` if ``to_check`` contains any values that are not allowed.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    to_check</span>
<span class="sd">        The variable to check. We ensure that it doesn&#39;t contain any extra (not</span>
<span class="sd">        allowed) values. If a list, we check its contents. If a dict, we check</span>
<span class="sd">        its keys.</span>
<span class="sd">    to_check_name</span>
<span class="sd">        Name of the ``to_check`` variable, used in the error message.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If ``to_check`` takes an illegal value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">allowed_vals</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;display_mad_image&quot;</span><span class="p">,</span>
        <span class="s2">&quot;plot_loss&quot;</span><span class="p">,</span>
        <span class="s2">&quot;plot_pixel_values&quot;</span><span class="p">,</span>
        <span class="s2">&quot;misc&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">to_check</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">to_check</span>
    <span class="n">not_allowed</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vals</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_vals</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">not_allowed</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">to_check_name</span><span class="si">}</span><span class="s2"> contained value(s) </span><span class="si">{</span><span class="n">not_allowed</span><span class="si">}</span><span class="s2">! &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Only </span><span class="si">{</span><span class="n">allowed_vals</span><span class="si">}</span><span class="s2"> are permissible!&quot;</span>
        <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_setup_synthesis_fig</span><span class="p">(</span>
    <span class="n">fig</span><span class="p">:</span> <span class="n">mpl</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">axes_idx</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">included_plots</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;display_mad_image&quot;</span><span class="p">,</span>
        <span class="s2">&quot;plot_loss&quot;</span><span class="p">,</span>
        <span class="s2">&quot;plot_pixel_values&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">display_mad_image_width</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">plot_loss_width</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">plot_pixel_values_width</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">mpl</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">mpl</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">Axes</span><span class="p">],</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set up figure for :func:`plot_synthesis_status`.</span>

<span class="sd">    Creates figure with enough axes for the all the plots you want. Will</span>
<span class="sd">    also create index in ``axes_idx`` for them if you haven&#39;t done so already.</span>

<span class="sd">    If ``fig=None``, all axes will be on the same row and have the same width. If</span>
<span class="sd">    you want them to be on different rows, will need to initialize ``fig`` yourself</span>
<span class="sd">    and pass that in. For changing width, change the corresponding ``*_width`` arg,</span>
<span class="sd">    which gives width relative to other axes. So if you want the axis for the</span>
<span class="sd">    loss plot to be three times as wide as the others, set ``loss_width=3``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fig</span>
<span class="sd">        The figure to plot on or ``None``. If ``None``, we create a new figure.</span>
<span class="sd">    axes_idx</span>
<span class="sd">        Dictionary specifying which axes contains which type of plot, allows for more</span>
<span class="sd">        fine-grained control of the resulting figure. Probably only helpful if fig is</span>
<span class="sd">        also defined. Possible keys: ``&quot;loss&quot;``, ``&quot;pixel_values&quot;``, ``&quot;misc&quot;``. Values</span>
<span class="sd">        should all be ints. If you tell this function to create a plot that doesn&#39;t have</span>
<span class="sd">        a corresponding key, we find the lowest int that is not already in the dict, so</span>
<span class="sd">        if you have axes that you want unchanged, place their idx in ``&quot;misc&quot;``.</span>
<span class="sd">    figsize</span>
<span class="sd">        The size of the figure to create. It may take a little bit of</span>
<span class="sd">        playing around to find a reasonable value. If ``None``, we attempt to</span>
<span class="sd">        make our best guess, aiming to have relative width=1 correspond to 5.</span>
<span class="sd">    included_plots</span>
<span class="sd">        Which plots to include. Must be some subset of ``&#39;display_mad_image&#39;,</span>
<span class="sd">        &#39;plot_loss&#39;, &#39;plot_pixel_values&#39;``.</span>
<span class="sd">    display_mad_image_width</span>
<span class="sd">        Relative width of the axis for the synthesized image.</span>
<span class="sd">    plot_loss_width</span>
<span class="sd">        Relative width of the axis for loss plot.</span>
<span class="sd">    plot_pixel_values_width</span>
<span class="sd">        Relative width of the axis for image pixel intensities histograms.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig</span>
<span class="sd">        The figure to plot on.</span>
<span class="sd">    axes</span>
<span class="sd">        List or array of axes contained in fig.</span>
<span class="sd">    axes_idx</span>
<span class="sd">        Dictionary identifying the idx for each plot type.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_subplots</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">axes_idx</span> <span class="o">=</span> <span class="n">axes_idx</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">width_ratios</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="s2">&quot;display_mad_image&quot;</span> <span class="ow">in</span> <span class="n">included_plots</span><span class="p">:</span>
        <span class="n">n_subplots</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">width_ratios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">display_mad_image_width</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;display_mad_image&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">axes_idx</span><span class="p">:</span>
            <span class="n">axes_idx</span><span class="p">[</span><span class="s2">&quot;display_mad_image&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">_find_min_int</span><span class="p">(</span><span class="n">axes_idx</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="k">if</span> <span class="s2">&quot;plot_loss&quot;</span> <span class="ow">in</span> <span class="n">included_plots</span><span class="p">:</span>
        <span class="n">n_subplots</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">width_ratios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plot_loss_width</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;plot_loss&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">axes_idx</span><span class="p">:</span>
            <span class="n">axes_idx</span><span class="p">[</span><span class="s2">&quot;plot_loss&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">_find_min_int</span><span class="p">(</span><span class="n">axes_idx</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="k">if</span> <span class="s2">&quot;plot_pixel_values&quot;</span> <span class="ow">in</span> <span class="n">included_plots</span><span class="p">:</span>
        <span class="n">n_subplots</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">width_ratios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plot_pixel_values_width</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;plot_pixel_values&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">axes_idx</span><span class="p">:</span>
            <span class="n">axes_idx</span><span class="p">[</span><span class="s2">&quot;plot_pixel_values&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">_find_min_int</span><span class="p">(</span><span class="n">axes_idx</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">width_ratios</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">width_ratios</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">figsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># we want (5, 5) for each subplot, with a bit of room between</span>
            <span class="c1"># each subplot</span>
            <span class="n">figsize</span> <span class="o">=</span> <span class="p">((</span><span class="n">width_ratios</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="n">width_ratios</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">width_ratios</span> <span class="o">=</span> <span class="n">width_ratios</span> <span class="o">/</span> <span class="n">width_ratios</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="n">n_subplots</span><span class="p">,</span>
            <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span>
            <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;width_ratios&quot;</span><span class="p">:</span> <span class="n">width_ratios</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">n_subplots</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">axes</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">axes</span>
    <span class="c1"># make sure misc contains all the empty axes</span>
    <span class="n">misc_axes</span> <span class="o">=</span> <span class="n">axes_idx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;misc&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">misc_axes</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span>
        <span class="n">misc_axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">misc_axes</span><span class="p">]</span>
    <span class="n">all_axes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">axes_idx</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="c1"># so if it&#39;s a list of ints</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span>
            <span class="n">all_axes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">all_axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">misc_axes</span> <span class="o">+=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_axes</span><span class="p">]</span>
    <span class="n">axes_idx</span><span class="p">[</span><span class="s2">&quot;misc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">misc_axes</span>
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">axes_idx</span>


<div class="viewcode-block" id="plot_synthesis_status">
<a class="viewcode-back" href="../../../generated/plenoptic.synthesize.mad_competition.html#plenoptic.synthesize.mad_competition.plot_synthesis_status">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_synthesis_status</span><span class="p">(</span>
    <span class="n">mad</span><span class="p">:</span> <span class="n">MADCompetition</span><span class="p">,</span>
    <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">channel_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">iteration</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">vrange</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;indep1&quot;</span><span class="p">,</span>
    <span class="n">zoom</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">fig</span><span class="p">:</span> <span class="n">mpl</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">axes_idx</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">included_plots</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;display_mad_image&quot;</span><span class="p">,</span>
        <span class="s2">&quot;plot_loss&quot;</span><span class="p">,</span>
        <span class="s2">&quot;plot_pixel_values&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">width_ratios</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">mpl</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make a plot showing synthesis status.</span>

<span class="sd">    We create several subplots to analyze this. The plots to include are</span>
<span class="sd">    specified by including their name in the ``included_plots`` list. All plots</span>
<span class="sd">    can be created separately using the method with the same name.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mad</span>
<span class="sd">        MADCompetition object whose status we want to plot.</span>
<span class="sd">    batch_idx</span>
<span class="sd">        Which index to take from the batch dimension.</span>
<span class="sd">    channel_idx</span>
<span class="sd">        Which index to take from the channel dimension. If ``None``, we use all</span>
<span class="sd">        channels (assumed use-case is RGB(A) image).</span>
<span class="sd">    iteration</span>
<span class="sd">        Which iteration to display. If ``None``, we show the most recent one.</span>
<span class="sd">        Negative values are also allowed. If ``iteration!=None`` and</span>
<span class="sd">        ``mad.store_progress&gt;1`` (that is, the MAD image was not cached on every</span>
<span class="sd">        iteration), then we use the cached MAD image from the nearest iteration.</span>
<span class="sd">    vrange</span>
<span class="sd">        The vrange option to pass to ``display_mad_image()``. See</span>
<span class="sd">        docstring of :func:`~plenoptic.tools.display.imshow` for possible values.</span>
<span class="sd">    zoom</span>
<span class="sd">        How much to zoom in / enlarge the synthesized image, the ratio</span>
<span class="sd">        of display pixels to image pixels. If ``None``, we</span>
<span class="sd">        attempt to find the best value ourselves.</span>
<span class="sd">    fig</span>
<span class="sd">        If ``None``, we create a new figure. otherwise we assume this is</span>
<span class="sd">        an empty figure that has the appropriate size and number of</span>
<span class="sd">        subplots.</span>
<span class="sd">    axes_idx</span>
<span class="sd">        Dictionary specifying which axes contains which type of plot, allows</span>
<span class="sd">        for more fine-grained control of the resulting figure. Probably only</span>
<span class="sd">        helpful if fig is also defined. Possible keys: ``&#39;mad_image&#39;,</span>
<span class="sd">        &#39;loss&#39;, &#39;pixel_values&#39;, &#39;misc&#39;``. Values should all be ints. If you</span>
<span class="sd">        tell this function to create a plot that doesn&#39;t have a corresponding</span>
<span class="sd">        key, we find the lowest int that is not already in the dict, so if you</span>
<span class="sd">        have axes that you want unchanged, place their idx in ``&#39;misc&#39;``.</span>
<span class="sd">    figsize</span>
<span class="sd">        The size of the figure to create. It may take a little bit of</span>
<span class="sd">        playing around to find a reasonable value. If ``None``, we attempt to</span>
<span class="sd">        make our best guess, aiming to have each axis be of size ``(5, 5)``.</span>
<span class="sd">    included_plots</span>
<span class="sd">        Which plots to include. Must be some subset of ``&#39;display_mad_image&#39;,</span>
<span class="sd">        &#39;plot_loss&#39;, &#39;plot_pixel_values&#39;``.</span>
<span class="sd">    width_ratios</span>
<span class="sd">        If ``width_ratios`` is an empty dictionary, ``plot_loss`` will have</span>
<span class="sd">        double the width of the other plots. To change that, specify their</span>
<span class="sd">        relative widths using the keys: [&#39;display_mad_image&#39;, &#39;plot_loss&#39;,</span>
<span class="sd">        &#39;plot_pixel_values&#39;] and floats specifying their relative width.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig</span>
<span class="sd">        The figure containing this plot.</span>
<span class="sd">    axes_idx</span>
<span class="sd">        Dictionary giving index of each plot.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If ``mad.mad_image`` object is not 3d or 4d.</span>
<span class="sd">    ValueError</span>
<span class="sd">        If the ``iteration is not None`` and the given ``mad`` object was run</span>
<span class="sd">        with ``store_progress=False``.</span>

<span class="sd">    Warns</span>
<span class="sd">    -----</span>
<span class="sd">    UserWarning</span>
<span class="sd">        If the iteration used for ``saved_mad_image`` is not the same as the argument</span>
<span class="sd">        ``iteration`` (because e.g., you set ``iteration=3`` but</span>
<span class="sd">        ``mad.store_progress=2``).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">iteration</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">mad</span><span class="o">.</span><span class="n">store_progress</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;synthesis() was run with store_progress=False, &quot;</span>
            <span class="s2">&quot;cannot specify which iteration to plot (only&quot;</span>
            <span class="s2">&quot; last one, with iteration=None)&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">mad</span><span class="o">.</span><span class="n">mad_image</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;plot_synthesis_status() expects 3 or 4d data;&quot;</span>
            <span class="s2">&quot;unexpected behavior will result otherwise!&quot;</span>
        <span class="p">)</span>
    <span class="n">_check_included_plots</span><span class="p">(</span><span class="n">included_plots</span><span class="p">,</span> <span class="s2">&quot;included_plots&quot;</span><span class="p">)</span>
    <span class="n">_check_included_plots</span><span class="p">(</span><span class="n">width_ratios</span><span class="p">,</span> <span class="s2">&quot;width_ratios&quot;</span><span class="p">)</span>
    <span class="n">_check_included_plots</span><span class="p">(</span><span class="n">axes_idx</span><span class="p">,</span> <span class="s2">&quot;axes_idx&quot;</span><span class="p">)</span>
    <span class="n">width_ratios</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">_width&quot;</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">width_ratios</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">axes_idx</span> <span class="o">=</span> <span class="n">_setup_synthesis_fig</span><span class="p">(</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes_idx</span><span class="p">,</span> <span class="n">figsize</span><span class="p">,</span> <span class="n">included_plots</span><span class="p">,</span> <span class="o">**</span><span class="n">width_ratios</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;display_mad_image&quot;</span> <span class="ow">in</span> <span class="n">included_plots</span><span class="p">:</span>
        <span class="n">display_mad_image</span><span class="p">(</span>
            <span class="n">mad</span><span class="p">,</span>
            <span class="n">batch_idx</span><span class="o">=</span><span class="n">batch_idx</span><span class="p">,</span>
            <span class="n">channel_idx</span><span class="o">=</span><span class="n">channel_idx</span><span class="p">,</span>
            <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">axes_idx</span><span class="p">[</span><span class="s2">&quot;display_mad_image&quot;</span><span class="p">]],</span>
            <span class="n">zoom</span><span class="o">=</span><span class="n">zoom</span><span class="p">,</span>
            <span class="n">vrange</span><span class="o">=</span><span class="n">vrange</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;plot_loss&quot;</span> <span class="ow">in</span> <span class="n">included_plots</span><span class="p">:</span>
        <span class="n">plot_loss</span><span class="p">(</span><span class="n">mad</span><span class="p">,</span> <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">axes_idx</span><span class="p">[</span><span class="s2">&quot;plot_loss&quot;</span><span class="p">]])</span>
        <span class="c1"># this function creates a single axis for loss, which plot_loss then</span>
        <span class="c1"># split into two. this makes sure the right two axes are present in the</span>
        <span class="c1"># dict</span>
        <span class="n">all_axes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">axes_idx</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="c1"># so if it&#39;s a list of ints</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span>
                <span class="n">all_axes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">all_axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">new_axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_axes</span><span class="p">]</span>
        <span class="n">axes_idx</span><span class="p">[</span><span class="s2">&quot;plot_loss&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_axes</span>
    <span class="k">if</span> <span class="s2">&quot;plot_pixel_values&quot;</span> <span class="ow">in</span> <span class="n">included_plots</span><span class="p">:</span>
        <span class="n">plot_pixel_values</span><span class="p">(</span>
            <span class="n">mad</span><span class="p">,</span>
            <span class="n">batch_idx</span><span class="o">=</span><span class="n">batch_idx</span><span class="p">,</span>
            <span class="n">channel_idx</span><span class="o">=</span><span class="n">channel_idx</span><span class="p">,</span>
            <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">axes_idx</span><span class="p">[</span><span class="s2">&quot;plot_pixel_values&quot;</span><span class="p">]],</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axes_idx</span></div>



<div class="viewcode-block" id="animate">
<a class="viewcode-back" href="../../../generated/plenoptic.synthesize.mad_competition.html#plenoptic.synthesize.mad_competition.animate">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">animate</span><span class="p">(</span>
    <span class="n">mad</span><span class="p">:</span> <span class="n">MADCompetition</span><span class="p">,</span>
    <span class="n">framerate</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">batch_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">channel_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">zoom</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">fig</span><span class="p">:</span> <span class="n">mpl</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">axes_idx</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">included_plots</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;display_mad_image&quot;</span><span class="p">,</span>
        <span class="s2">&quot;plot_loss&quot;</span><span class="p">,</span>
        <span class="s2">&quot;plot_pixel_values&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">width_ratios</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">mpl</span><span class="o">.</span><span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Animate synthesis progress.</span>

<span class="sd">    This is essentially the figure produced by</span>
<span class="sd">    ``mad.plot_synthesis_status`` animated over time, for each stored</span>
<span class="sd">    iteration.</span>

<span class="sd">    This functions returns a matplotlib FuncAnimation object. See our</span>
<span class="sd">    documentation (e.g., :ref:`quickstart-nb`) for examples on how to view it in</span>
<span class="sd">    a Jupyter notebook. In order to save, use ``anim.save(filename)``. In either</span>
<span class="sd">    case, this can take a while and you&#39;ll need the appropriate writer installed</span>
<span class="sd">    and on your path, e.g., ffmpeg, imagemagick, etc). See</span>
<span class="sd">    :doc:`matplotlib documentation &lt;matplotlib:api/animation_api&gt;` for more details.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mad</span>
<span class="sd">        MADCompetition object whose synthesis we want to animate.</span>
<span class="sd">    framerate</span>
<span class="sd">        How many frames a second to display.</span>
<span class="sd">    batch_idx</span>
<span class="sd">        Which index to take from the batch dimension.</span>
<span class="sd">    channel_idx</span>
<span class="sd">        Which index to take from the channel dimension. If ``None``, we use all</span>
<span class="sd">        channels (assumed use-case is RGB(A) image).</span>
<span class="sd">    zoom</span>
<span class="sd">        How much to zoom in / enlarge the synthesized image, the ratio</span>
<span class="sd">        of display pixels to image pixels. If ``None``, we</span>
<span class="sd">        attempt to find the best value ourselves.</span>
<span class="sd">    fig</span>
<span class="sd">        If ``None``, we create a new figure. otherwise we assume this is</span>
<span class="sd">        an empty figure that has the appropriate size and number of</span>
<span class="sd">        subplots.</span>
<span class="sd">    axes_idx</span>
<span class="sd">        Dictionary specifying which axes contains which type of plot, allows</span>
<span class="sd">        for more fine-grained control of the resulting figure. Probably only</span>
<span class="sd">        helpful if fig is also defined. Possible keys: ``&#39;mad_image&#39;,</span>
<span class="sd">        &#39;loss&#39;, &#39;pixel_values&#39;, &#39;misc&#39;``. Values should all be ints. If you</span>
<span class="sd">        tell this function to create a plot that doesn&#39;t have a corresponding</span>
<span class="sd">        key, we find the lowest int that is not already in the dict, so if you</span>
<span class="sd">        have axes that you want unchanged, place their idx in ``&#39;misc&#39;``.</span>
<span class="sd">    figsize</span>
<span class="sd">        The size of the figure to create. It may take a little bit of</span>
<span class="sd">        playing around to find a reasonable value. If ``None``, we attempt to</span>
<span class="sd">        make our best guess, aiming to have each axis be of size ``(5, 5)``.</span>
<span class="sd">    included_plots</span>
<span class="sd">        Which plots to include. Must be some subset of ``&#39;display_mad_image&#39;,</span>
<span class="sd">        &#39;plot_loss&#39;, &#39;plot_pixel_values&#39;``.</span>
<span class="sd">    width_ratios</span>
<span class="sd">        If ``width_ratios`` is an empty dictionary, ``plot_loss`` will have</span>
<span class="sd">        double the width of the other plots. To change that, specify their</span>
<span class="sd">        relative widths using the keys: [&#39;display_mad_image&#39;, &#39;plot_loss&#39;,</span>
<span class="sd">        &#39;plot_pixel_values&#39;] and floats specifying their relative width.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    anim</span>
<span class="sd">        The animation object. In order to view, must convert to HTML</span>
<span class="sd">        or save.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If the given ``mad`` object was run with ``store_progress=False``.</span>
<span class="sd">    ValueError</span>
<span class="sd">        If ``mad.mage_image`` object is not 3d or 4d.</span>
<span class="sd">    ValueError</span>
<span class="sd">        If we do not know how to interpret the value of ``ylim``.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Unless specified, we use the ffmpeg backend, which requires that you have</span>
<span class="sd">    ffmpeg installed and on your path (https://ffmpeg.org/download.html).</span>
<span class="sd">    To use a different, use the matplotlib rcParams:</span>
<span class="sd">    ``matplotlib.rcParams[&#39;animation.writer&#39;] = writer``, see</span>
<span class="sd">    `matplotlib documentation</span>
<span class="sd">    &lt;https://matplotlib.org/stable/api/animation_api.html#writer-classes&gt;`_ for more</span>
<span class="sd">    details.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mad</span><span class="o">.</span><span class="n">store_progress</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;synthesize() was run with store_progress=False, cannot animate!&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">mad</span><span class="o">.</span><span class="n">mad_image</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;animate() expects 3 or 4d data; unexpected behavior will result otherwise!&quot;</span>
        <span class="p">)</span>
    <span class="n">_check_included_plots</span><span class="p">(</span><span class="n">included_plots</span><span class="p">,</span> <span class="s2">&quot;included_plots&quot;</span><span class="p">)</span>
    <span class="n">_check_included_plots</span><span class="p">(</span><span class="n">width_ratios</span><span class="p">,</span> <span class="s2">&quot;width_ratios&quot;</span><span class="p">)</span>
    <span class="n">_check_included_plots</span><span class="p">(</span><span class="n">axes_idx</span><span class="p">,</span> <span class="s2">&quot;axes_idx&quot;</span><span class="p">)</span>
    <span class="c1"># we run plot_synthesis_status to initialize the figure if either fig is</span>
    <span class="c1"># None or if there are no titles on any axes, which we assume means that</span>
    <span class="c1"># it&#39;s an empty figure</span>
    <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">ax</span><span class="o">.</span><span class="n">get_title</span><span class="p">()</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">]):</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes_idx</span> <span class="o">=</span> <span class="n">plot_synthesis_status</span><span class="p">(</span>
            <span class="n">mad</span><span class="o">=</span><span class="n">mad</span><span class="p">,</span>
            <span class="n">batch_idx</span><span class="o">=</span><span class="n">batch_idx</span><span class="p">,</span>
            <span class="n">channel_idx</span><span class="o">=</span><span class="n">channel_idx</span><span class="p">,</span>
            <span class="n">iteration</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span>
            <span class="n">zoom</span><span class="o">=</span><span class="n">zoom</span><span class="p">,</span>
            <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span>
            <span class="n">included_plots</span><span class="o">=</span><span class="n">included_plots</span><span class="p">,</span>
            <span class="n">axes_idx</span><span class="o">=</span><span class="n">axes_idx</span><span class="p">,</span>
            <span class="n">width_ratios</span><span class="o">=</span><span class="n">width_ratios</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="c1"># grab the artist for the second plot (we don&#39;t need to do this for the</span>
    <span class="c1"># MAD image plot, because we use the update_plot function for that)</span>
    <span class="k">if</span> <span class="s2">&quot;plot_loss&quot;</span> <span class="ow">in</span> <span class="n">included_plots</span><span class="p">:</span>
        <span class="n">scat</span> <span class="o">=</span> <span class="p">[</span><span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">collections</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">axes_idx</span><span class="p">[</span><span class="s2">&quot;plot_loss&quot;</span><span class="p">]]</span>
    <span class="k">if</span> <span class="s2">&quot;display_mad_image&quot;</span> <span class="ow">in</span> <span class="n">included_plots</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">axes_idx</span><span class="p">[</span><span class="s2">&quot;display_mad_image&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;MAD Image&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">movie_plot</span><span class="p">(</span><span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">mpl</span><span class="o">.</span><span class="n">artist</span><span class="o">.</span><span class="n">Artist</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Matplotlib function for animation.</span>

<span class="sd">        Update plots for frame ``i``.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        i</span>
<span class="sd">            The frame to plot.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        artists</span>
<span class="sd">            The updated matplotlib artists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># this warning is not relevant for animate</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span>
                <span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;loss iteration and iteration for&quot;</span>
            <span class="p">)</span>
            <span class="n">artists</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="s2">&quot;display_mad_image&quot;</span> <span class="ow">in</span> <span class="n">included_plots</span><span class="p">:</span>
                <span class="n">artists</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="n">display</span><span class="o">.</span><span class="n">update_plot</span><span class="p">(</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">axes_idx</span><span class="p">[</span><span class="s2">&quot;display_mad_image&quot;</span><span class="p">]],</span>
                        <span class="n">data</span><span class="o">=</span><span class="n">mad</span><span class="o">.</span><span class="n">saved_mad_image</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                        <span class="n">batch_idx</span><span class="o">=</span><span class="n">batch_idx</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;plot_pixel_values&quot;</span> <span class="ow">in</span> <span class="n">included_plots</span><span class="p">:</span>
                <span class="c1"># this is the dumbest way to do this, but it&#39;s simple --</span>
                <span class="c1"># clearing the axes can cause problems if the user has, for</span>
                <span class="c1"># example, changed the tick locator or formatter. not sure how</span>
                <span class="c1"># to handle this best right now</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">axes_idx</span><span class="p">[</span><span class="s2">&quot;plot_pixel_values&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="n">plot_pixel_values</span><span class="p">(</span>
                    <span class="n">mad</span><span class="p">,</span>
                    <span class="n">batch_idx</span><span class="o">=</span><span class="n">batch_idx</span><span class="p">,</span>
                    <span class="n">channel_idx</span><span class="o">=</span><span class="n">channel_idx</span><span class="p">,</span>
                    <span class="n">iteration</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">mad</span><span class="o">.</span><span class="n">store_progress</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">mad</span><span class="o">.</span><span class="n">losses</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="n">ax</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">axes_idx</span><span class="p">[</span><span class="s2">&quot;plot_pixel_values&quot;</span><span class="p">]],</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;plot_loss&quot;</span> <span class="ow">in</span> <span class="n">included_plots</span><span class="p">:</span>
                <span class="c1"># loss always contains values from every iteration, but everything</span>
                <span class="c1"># else will be subsampled.</span>
                <span class="n">x_val</span> <span class="o">=</span> <span class="n">mad</span><span class="o">.</span><span class="n">_convert_iteration</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">scat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_offsets</span><span class="p">((</span><span class="n">x_val</span><span class="p">,</span> <span class="n">mad</span><span class="o">.</span><span class="n">reference_metric_loss</span><span class="p">[</span><span class="n">x_val</span><span class="p">]))</span>
                <span class="n">scat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_offsets</span><span class="p">((</span><span class="n">x_val</span><span class="p">,</span> <span class="n">mad</span><span class="o">.</span><span class="n">optimized_metric_loss</span><span class="p">[</span><span class="n">x_val</span><span class="p">]))</span>
                <span class="n">artists</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">scat</span><span class="p">)</span>
            <span class="c1"># as long as blitting is True, need to return a sequence of artists</span>
            <span class="k">return</span> <span class="n">artists</span>

    <span class="c1"># don&#39;t need an init_func, since we handle initialization ourselves</span>
    <span class="n">anim</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span>
        <span class="n">fig</span><span class="p">,</span>
        <span class="n">movie_plot</span><span class="p">,</span>
        <span class="n">frames</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">mad</span><span class="o">.</span><span class="n">saved_mad_image</span><span class="p">),</span>
        <span class="n">blit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">interval</span><span class="o">=</span><span class="mf">1000.0</span> <span class="o">/</span> <span class="n">framerate</span><span class="p">,</span>
        <span class="n">repeat</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">anim</span></div>



<div class="viewcode-block" id="display_mad_image_all">
<a class="viewcode-back" href="../../../generated/plenoptic.synthesize.mad_competition.html#plenoptic.synthesize.mad_competition.display_mad_image_all">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">display_mad_image_all</span><span class="p">(</span>
    <span class="n">mad_metric1_min</span><span class="p">:</span> <span class="n">MADCompetition</span><span class="p">,</span>
    <span class="n">mad_metric2_min</span><span class="p">:</span> <span class="n">MADCompetition</span><span class="p">,</span>
    <span class="n">mad_metric1_max</span><span class="p">:</span> <span class="n">MADCompetition</span><span class="p">,</span>
    <span class="n">mad_metric2_max</span><span class="p">:</span> <span class="n">MADCompetition</span><span class="p">,</span>
    <span class="n">metric1_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">metric2_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">zoom</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">mpl</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display all MAD Competition images.</span>

<span class="sd">    To generate a full set of MAD Competition images, you need four instances:</span>
<span class="sd">    one for minimizing and maximizing each metric. This helper function creates</span>
<span class="sd">    a figure to display the full set of images.</span>

<span class="sd">    In addition to the four MAD Competition images, this also plots the initial</span>
<span class="sd">    image from ``mad_metric1_min``, for comparison.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mad_metric1_min</span>
<span class="sd">        ``MADCompetition`` object that minimized the first metric.</span>
<span class="sd">    mad_metric2_min</span>
<span class="sd">        ``MADCompetition`` object that minimized the second metric.</span>
<span class="sd">    mad_metric1_max</span>
<span class="sd">        ``MADCompetition`` object that maximized the first metric.</span>
<span class="sd">    mad_metric2_max</span>
<span class="sd">        ``MADCompetition`` object that maximized the second metric.</span>
<span class="sd">    metric1_name</span>
<span class="sd">        Name of the first metric. If ``None``, we use the name of the</span>
<span class="sd">        ``optimized_metric`` function from ``mad_metric1_min``.</span>
<span class="sd">    metric2_name</span>
<span class="sd">        Name of the second metric. If ``None``, we use the name of the</span>
<span class="sd">        ``optimized_metric`` function from ``mad_metric2_min``.</span>
<span class="sd">    zoom</span>
<span class="sd">        Ratio of display pixels to image pixels. See</span>
<span class="sd">        :func:`~plenoptic.tools.display.imshow` for details.</span>
<span class="sd">    **kwargs</span>
<span class="sd">        Passed to :func:`~plenoptic.tools.display.imshow`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig</span>
<span class="sd">        Figure containing the images.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If the four ``MADCompetition`` instances do not have the same ``image``</span>
<span class="sd">        attribute.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># this is a bit of a hack right now, because they don&#39;t all have same</span>
    <span class="c1"># initial image</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">mad_metric1_min</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">mad_metric2_min</span><span class="o">.</span><span class="n">image</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All four instances of MADCompetition must have same image!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">mad_metric1_min</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">mad_metric1_max</span><span class="o">.</span><span class="n">image</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All four instances of MADCompetition must have same image!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">mad_metric1_min</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">mad_metric2_max</span><span class="o">.</span><span class="n">image</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All four instances of MADCompetition must have same image!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">metric1_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">metric1_name</span> <span class="o">=</span> <span class="n">mad_metric1_min</span><span class="o">.</span><span class="n">optimized_metric</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">if</span> <span class="n">metric2_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">metric2_name</span> <span class="o">=</span> <span class="n">mad_metric2_min</span><span class="o">.</span><span class="n">optimized_metric</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">pt_make_figure</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="n">zoom</span> <span class="o">*</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mad_metric1_min</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]])</span>
    <span class="n">mads</span> <span class="o">=</span> <span class="p">[</span><span class="n">mad_metric1_min</span><span class="p">,</span> <span class="n">mad_metric1_max</span><span class="p">,</span> <span class="n">mad_metric2_min</span><span class="p">,</span> <span class="n">mad_metric2_max</span><span class="p">]</span>
    <span class="n">titles</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">f</span><span class="s2">&quot;Minimize </span><span class="si">{</span><span class="n">metric1_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;Maximize </span><span class="si">{</span><span class="n">metric1_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;Minimize </span><span class="si">{</span><span class="n">metric2_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;Maximize </span><span class="si">{</span><span class="n">metric2_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="c1"># we&#39;re only plotting one image here, so if the user wants multiple</span>
    <span class="c1"># channels, they must be RGB</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;channel_idx&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mad_metric1_min</span><span class="o">.</span><span class="n">initial_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">as_rgb</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">as_rgb</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">display</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
        <span class="n">mad_metric1_min</span><span class="o">.</span><span class="n">image</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Reference image&quot;</span><span class="p">,</span>
        <span class="n">zoom</span><span class="o">=</span><span class="n">zoom</span><span class="p">,</span>
        <span class="n">as_rgb</span><span class="o">=</span><span class="n">as_rgb</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">display</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
        <span class="n">mad_metric1_min</span><span class="o">.</span><span class="n">initial_image</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Initial (noisy) image&quot;</span><span class="p">,</span>
        <span class="n">zoom</span><span class="o">=</span><span class="n">zoom</span><span class="p">,</span>
        <span class="n">as_rgb</span><span class="o">=</span><span class="n">as_rgb</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">mad</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">mads</span><span class="p">,</span> <span class="n">titles</span><span class="p">):</span>
        <span class="n">display_mad_image</span><span class="p">(</span><span class="n">mad</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="n">zoom</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span></div>



<div class="viewcode-block" id="plot_loss_all">
<a class="viewcode-back" href="../../../generated/plenoptic.synthesize.mad_competition.html#plenoptic.synthesize.mad_competition.plot_loss_all">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_loss_all</span><span class="p">(</span>
    <span class="n">mad_metric1_min</span><span class="p">:</span> <span class="n">MADCompetition</span><span class="p">,</span>
    <span class="n">mad_metric2_min</span><span class="p">:</span> <span class="n">MADCompetition</span><span class="p">,</span>
    <span class="n">mad_metric1_max</span><span class="p">:</span> <span class="n">MADCompetition</span><span class="p">,</span>
    <span class="n">mad_metric2_max</span><span class="p">:</span> <span class="n">MADCompetition</span><span class="p">,</span>
    <span class="n">metric1_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">metric2_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">metric1_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="s2">&quot;C0&quot;</span><span class="p">},</span>
    <span class="n">metric2_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="s2">&quot;C1&quot;</span><span class="p">},</span>
    <span class="n">min_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;linestyle&quot;</span><span class="p">:</span> <span class="s2">&quot;--&quot;</span><span class="p">},</span>
    <span class="n">max_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;linestyle&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">},</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">mpl</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot loss for full set of MAD Competiton instances.</span>

<span class="sd">    To generate a full set of MAD Competition images, you need four instances:</span>
<span class="sd">    one for minimizing and maximizing each metric. This helper function creates</span>
<span class="sd">    a two-axis figure to display the loss for this full set.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mad_metric1_min</span>
<span class="sd">        ``MADCompetition`` object that minimized the first metric.</span>
<span class="sd">    mad_metric2_min</span>
<span class="sd">        ``MADCompetition`` object that minimized the second metric.</span>
<span class="sd">    mad_metric1_max</span>
<span class="sd">        ``MADCompetition`` object that maximized the first metric.</span>
<span class="sd">    mad_metric2_max</span>
<span class="sd">        ``MADCompetition`` object that maximized the second metric.</span>
<span class="sd">    metric1_name</span>
<span class="sd">        Name of the first metric. If ``None``, we use the name of the</span>
<span class="sd">        ``optimized_metric`` function from ``mad_metric1_min``.</span>
<span class="sd">    metric2_name</span>
<span class="sd">        Name of the second metric. If ``None``, we use the name of the</span>
<span class="sd">        ``optimized_metric`` function from ``mad_metric2_min``.</span>
<span class="sd">    metric1_kwargs</span>
<span class="sd">        Dictionary of arguments to pass to :func:`matplotlib.pyplot.plot` to identify</span>
<span class="sd">        synthesis instance where the first metric was being optimized.</span>
<span class="sd">    metric2_kwargs</span>
<span class="sd">        Dictionary of arguments to pass to :func:`matplotlib.pyplot.plot` to identify</span>
<span class="sd">        synthesis instance where the second metric was being optimized.</span>
<span class="sd">    min_kwargs</span>
<span class="sd">        Dictionary of arguments to pass to :func:`matplotlib.pyplot.plot` to identify</span>
<span class="sd">        synthesis instance where ``optimized_metric`` was being minimized.</span>
<span class="sd">    max_kwargs</span>
<span class="sd">        Dictionary of arguments to pass to :func:`matplotlib.pyplot.plot` to identify</span>
<span class="sd">        synthesis instance where ``optimized_metric`` was being maximized.</span>
<span class="sd">    figsize</span>
<span class="sd">        Size of the figure we create.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig</span>
<span class="sd">        Figure containing the plot.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If the four ``MADCompetition`` instances do not have the same ``image``</span>
<span class="sd">        attribute.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">mad_metric1_min</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">mad_metric2_min</span><span class="o">.</span><span class="n">image</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All four instances of MADCompetition must have same image!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">mad_metric1_min</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">mad_metric1_max</span><span class="o">.</span><span class="n">image</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All four instances of MADCompetition must have same image!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">mad_metric1_min</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">mad_metric2_max</span><span class="o">.</span><span class="n">image</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All four instances of MADCompetition must have same image!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">metric1_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">metric1_name</span> <span class="o">=</span> <span class="n">mad_metric1_min</span><span class="o">.</span><span class="n">optimized_metric</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">if</span> <span class="n">metric2_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">metric2_name</span> <span class="o">=</span> <span class="n">mad_metric2_min</span><span class="o">.</span><span class="n">optimized_metric</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="n">plot_loss</span><span class="p">(</span>
        <span class="n">mad_metric1_min</span><span class="p">,</span>
        <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Minimize </span><span class="si">{</span><span class="n">metric1_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">metric1_kwargs</span><span class="p">,</span>
        <span class="o">**</span><span class="n">min_kwargs</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">plot_loss</span><span class="p">(</span>
        <span class="n">mad_metric1_max</span><span class="p">,</span>
        <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Maximize </span><span class="si">{</span><span class="n">metric1_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">metric1_kwargs</span><span class="p">,</span>
        <span class="o">**</span><span class="n">max_kwargs</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># we pass the axes backwards here because the fixed and synthesis metrics are</span>
    <span class="c1"># the opposite as they are in the instances above.</span>
    <span class="n">plot_loss</span><span class="p">(</span>
        <span class="n">mad_metric2_min</span><span class="p">,</span>
        <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Minimize </span><span class="si">{</span><span class="n">metric2_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">metric2_kwargs</span><span class="p">,</span>
        <span class="o">**</span><span class="n">min_kwargs</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">plot_loss</span><span class="p">(</span>
        <span class="n">mad_metric2_max</span><span class="p">,</span>
        <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Maximize </span><span class="si">{</span><span class="n">metric2_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">metric2_kwargs</span><span class="p">,</span>
        <span class="o">**</span><span class="n">max_kwargs</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Loss&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">metric2_name</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Loss&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">metric1_name</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;center left&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">fig</span></div>

</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      Â© Copyright 2019-2025, Plenoptic authors.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 9.0.4.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>