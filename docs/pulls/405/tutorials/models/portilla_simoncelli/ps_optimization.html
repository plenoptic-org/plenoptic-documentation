

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Portilla-Simoncelli optimization details &mdash; plenoptic 1.3.2.dev217 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../../../_static/plot_directive.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css?v=9c3e77be" />
      <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=a2d047e6" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=4ba52da5"></script>
      <script src="../../../_static/doctools.js?v=fd6eb6e6"></script>
      <script src="../../../_static/sphinx_highlight.js?v=6ffebe34"></script>
      <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../_static/copybutton.js?v=6dbb43f8"></script>
      <script>let toggleHintShow = 'Click to show';</script>
      <script>let toggleHintHide = 'Click to hide';</script>
      <script>let toggleOpenOnPrint = 'true';</script>
      <script src="../../../_static/togglebutton.js?v=1ae7504c"></script>
      <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
      <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Portilla-Simoncelli Model Limitations" href="ps_limitations.html" />
    <link rel="prev" title="Understanding Portilla-Simoncelli model statistics" href="ps_understand_stats.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            plenoptic
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Basic concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../jupyter.html">Using Jupyter to Run Example Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../conceptual_intro.html">Conceptual Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../models.html">Model requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../citation.html">Citation Guide and Bibliography</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Synthesis method introductions</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../intro/Eigendistortions.html">Eigendistortions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../intro/MAD_Competition_1.html">MAD Competition Conceptual Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../intro/MAD_Competition_2.html">MAD Competition Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../intro/Metamer.html">Metamers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Models and metrics</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Perceptual_distance.html">Perceptual distance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Steerable_Pyramid.html">Steerable Pyramid</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="ps_index.html">Portilla-Simoncelli Texture Model</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="ps_intro.html">What is a visual texture?</a></li>
<li class="toctree-l2"><a class="reference internal" href="ps_basic_synthesis.html">Using the Portilla-Simoncelli model in plenoptic</a></li>
<li class="toctree-l2"><a class="reference internal" href="ps_examples.html">Example Portilla-Simoncelli metamers from different texture classes</a></li>
<li class="toctree-l2"><a class="reference internal" href="ps_understand_stats.html">Understanding Portilla-Simoncelli model statistics</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Portilla-Simoncelli optimization details</a></li>
<li class="toctree-l2"><a class="reference internal" href="ps_limitations.html">Portilla-Simoncelli Model Limitations</a></li>
<li class="toctree-l2"><a class="reference internal" href="ps_matlab_differences.html">Notable differences between Matlab and Plenoptic Implementations</a></li>
<li class="toctree-l2"><a class="reference internal" href="ps_extensions.html">More than just texture metamers</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Synthesis method examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../applications/Demo_Eigendistortion.html">Reproducing Berardino et al., 2017 (Eigendistortions)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../applications/Original_MAD.html">Reproducing Wang and Simoncelli, 2008 (MAD Competition)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Advanced usage</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tips.html">Tips and Tricks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reproducibility.html">Reproducibility and Compatibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advanced/Display.html">Display and animate functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advanced/Synthesis_extensions.html">Extending existing synthesis objects</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">For Developers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../synthesis.html">Synthesis object design</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">plenoptic</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="ps_index.html">Portilla-Simoncelli Texture Model</a></li>
      <li class="breadcrumb-item active">Portilla-Simoncelli optimization details</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/tutorials/models/portilla_simoncelli/ps_optimization.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="portilla-simoncelli-optimization-details">
<span id="ps-optimization"></span><h1>Portilla-Simoncelli optimization details<a class="headerlink" href="#portilla-simoncelli-optimization-details" title="Link to this heading"></a></h1>
<p>As you read the other Portilla-Simoncelli notebooks, you may have noticed that the example metamer synthesis code is a bit more complicated than the <a class="reference internal" href="../../intro/Metamer.html#metamer-nb"><span class="std std-ref">basic Metamer usage</span></a>. There are two choices that are important for finding good solutions: the LBFGS optimization algorithm and a custom loss function. This notebook will discuss those two choices in a bit more detail, as well as what “good” means.</p>
<section id="what-is-a-good-metamer">
<h2>What is a “good” metamer?<a class="headerlink" href="#what-is-a-good-metamer" title="Link to this heading"></a></h2>
<p>In theory, model metamers are sets of images that have different pixel values and identical model outputs. In practice, metamer synthesis is a non-convex optimization problem in a high-dimensional space. In such problems, one typically optimizes until optimization has converged (i.e., the loss has stopped decreasing) or your result is “good enough” (i.e., the loss is low enough). Each study must determine what “good enough” means for them, and you are encouraged to read papers that have used model metamers (e.g., <span id="id1"><a class="reference internal" href="../../../citation.html#id21" title="Jeremy Freeman and Eero P Simoncelli. Metamers of the ventral stream. Nature Neuroscience, 14(9):1195–1201, aug 2011. arXiv:PMC3164938, doi:10.1038/nn.2889.">Freeman and Simoncelli, 2011</a></span>, <span id="id2"><a class="reference internal" href="../../../citation.html#id20" title="Jenelle Feather, Alex Durango, Ray Gonzalez, and Josh McDermott. Metamers of neural networks reveal divergence from human perceptual systems. In NeurIPS, 10078–10089. 2019.">Feather <em>et al.</em>, 2019</a></span>, <span id="id3"><a class="reference internal" href="../../../citation.html#id17" title="William F Broderick, Gizem Rufo, Jonathan Winawer, and Eero P Simoncelli. Foveated metamers of the early visual system. eLife, October 2025. URL: http://dx.doi.org/10.7554/eLife.90554.2, doi:10.7554/elife.90554.2.">Broderick <em>et al.</em>, 2025</a></span>) to see the approaches they have taken.</p>
<p>For the purposes of plenoptic, which provides implementations for researchers to use in their own experiments, “best” means “the lowest loss in the shortest time possible”. Therefore, for the purposes of plenoptic’s <a class="reference internal" href="../../../generated/plenoptic.simulate.models.portilla_simoncelli.html#plenoptic.simulate.models.portilla_simoncelli.PortillaSimoncelli" title="plenoptic.simulate.models.portilla_simoncelli.PortillaSimoncelli"><code class="xref py py-class docutils literal notranslate"><span class="pre">PortillaSimoncelli</span></code></a> implementation, we evaluated multiple possible configurations of optimizers, optimizer configurations, and optimization loss functions against each other and against the <a class="reference external" href="https://github.com/LabForComputationalVision/textureSynth">earlier MATLAB implementation</a>. This investigation can be found in <a class="reference external" href="https://github.com/plenoptic-org/plenoptic/issues/365">Issue #365</a>; the results are summarized in this notebook.</p>
<div class="note admonition">
<p class="admonition-title">What about perceptual quality?</p>
<p>For the texture model, good metamer synthesis also means that, when your target image is a natural texture, successful Portilla-Simoncelli metamer synthesis should result in an image which:</p>
<ol class="arabic simple">
<li><p>Looks natural.</p></li>
<li><p>Belongs to the same perceptual texture class as the target.</p></li>
<li><p>Is not identical to the original image.</p></li>
</ol>
<p>In an ideal world, these criteria would be identical to “has a low loss value”. However, the Portilla-Simoncelli texture statistics are not all of equal perceptual importance: the <strong>variance of the highpass residuals</strong>, for example, is related to the magnitude of high spatial frequencies in the image, where are much larger in the white noise samples used to initialize metamer synthesis than in natural images. This statistic only makes a small contribution to the overall loss, but is very important to metamer perceptual quality, which is important for the results laid out in this notebook.</p>
<p>And note, as discussed in <a class="reference internal" href="ps_limitations.html#ps-limitations"><span class="std std-ref">Portilla-Simoncelli Model Limitations</span></a>, this model was developed to align with human perception <strong>only for textures</strong>. Matching the Portilla-Simoncelli model output on a non-texture image will almost certainly not meet the first two desiderata in the list above.</p>
</div>
</section>
<section id="optimizer-configuration">
<h2>Optimizer configuration<a class="headerlink" href="#optimizer-configuration" title="Link to this heading"></a></h2>
<p>By default, <a class="reference internal" href="../../../generated/plenoptic.synthesize.metamer.Metamer.html#plenoptic.synthesize.metamer.Metamer" title="plenoptic.synthesize.metamer.Metamer"><code class="xref py py-class docutils literal notranslate"><span class="pre">Metamer</span></code></a> uses the <a class="reference external" href="https://docs.pytorch.org/docs/stable/generated/torch.optim.Adam.html#torch.optim.Adam" title="(in PyTorch v2.10)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Adam</span></code></a> optimizer, a variant of stochastic gradient descent. However, we found that <a class="reference external" href="https://docs.pytorch.org/docs/stable/generated/torch.optim.LBFGS.html#torch.optim.LBFGS" title="(in PyTorch v2.10)"><code class="xref py py-class docutils literal notranslate"><span class="pre">LBFGS</span></code></a> (the <a class="reference external" href="https://en.wikipedia.org/wiki/Limited-memory_BFGS">Limited-memory Broyden–Fletcher–Goldfarb–Shanno algorithm</a>) performs much better. LBFGS tracks the history of the optimization parameters (i.e., the metamer image pixels) over time, and uses this to approximate the second derivatives of the gradient. This results in:</p>
<ul class="simple">
<li><p>Higher memory usage.</p></li>
<li><p>Longer duration per optimization step.</p></li>
<li><p>Much faster decrease in loss per optimization step.</p></li>
</ul>
<p>In our experiments, using LBFGS results in lower loss for a given duration of synthesis time than using Adam or the original MATLAB code, across a variety of target images and initializations. Additionally, the loss continues to decrease beyond the point when the alternatives have started to converge.</p>
<p>LBFGS has many keyword arguments that users are able to tweak. From our experiments, we found that the following dictionary does a good job of balancing the tradeoff between reducing the loss as far as possible and overall synthesis duration:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">opt_kwargs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;max_iter&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="s2">&quot;max_eval&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="s2">&quot;history_size&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
    <span class="s2">&quot;line_search_fn&quot;</span><span class="p">:</span> <span class="s2">&quot;strong_wolfe&quot;</span><span class="p">,</span>
    <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Of these arguments, the only one that we believe users may want to experiment with is <code class="docutils literal notranslate"><span class="pre">history_size</span></code>: a larger history size results in a larger memory footprint (which grows with the square of the value) and slightly longer durations. Loss does not decrease monotonically with <code class="docutils literal notranslate"><span class="pre">history_size</span></code>: we found that loss decreased from <code class="docutils literal notranslate"><span class="pre">history_size=3</span></code> to <code class="docutils literal notranslate"><span class="pre">history_size=100</span></code> and then increased with <code class="docutils literal notranslate"><span class="pre">history_size=300</span></code>. We have decided <code class="docutils literal notranslate"><span class="pre">history_size=100</span></code> is a good tradeoff for the purposes of our documentation and tests, but users may find increased performance with other values.</p>
<div class="note dropdow admonition">
<p class="admonition-title">How much memory?</p>
<p>As mentioned, increasing <code class="docutils literal notranslate"><span class="pre">history_size</span></code> leads to more memory being used. In our tests, running <a class="reference internal" href="../../../generated/plenoptic.simulate.models.portilla_simoncelli.html#plenoptic.simulate.models.portilla_simoncelli.PortillaSimoncelli" title="plenoptic.simulate.models.portilla_simoncelli.PortillaSimoncelli"><code class="xref py py-class docutils literal notranslate"><span class="pre">PortillaSimoncelli</span></code></a> metamer synthesis for 100 iterations with the default initialization arguments, <code class="docutils literal notranslate"><span class="pre">history_size=100</span></code>, and a 256 by 256 image had a peak memory usage of about 600MB.</p>
</div>
<p>Finally, as with all iterative optimization procedures, we must decide how long to run synthesis for. In our experiments, for 10 to 200 iterations, the loss decreases as approximately one over the number of iterations, and the synthesis duration (in <a class="reference external" href="https://en.wikipedia.org/wiki/Elapsed_real_time">wall time</a>) increases approximately linearly with the number of iterations (the exact duration will depend on your hardware). For our documentation and tests, we have decided to use <code class="docutils literal notranslate"><span class="pre">max_iter=100</span></code>, though users may want to run synthesis for longer.</p>
<p>If you are interested, more details about the experiments that lead to the above recommendations can be found in <a class="reference external" href="https://github.com/plenoptic-org/plenoptic/issues/365">Issue #365</a>.</p>
</section>
<section id="custom-loss-function">
<span id="ps-loss-function"></span><h2>Custom loss function<a class="headerlink" href="#custom-loss-function" title="Link to this heading"></a></h2>
<p>When using the LBFGS optimizer configured as described above, plenoptic’s Portilla-Simoncelli metamer synthesis has a lower loss in every component than the MATLAB implementation, with the notable exception of the variance of highpass residuals. The two synthesis implementations (as discussed in <a class="reference internal" href="ps_matlab_differences.html#ps-mat-diffs"><span class="std std-ref">Notable differences between Matlab and Plenoptic Implementations</span></a>) are very different from each other: the MATLAB code does something akin to coordinate descent, where it optimizes each set of statistics separately, whereas the plenoptic code optimizes all of them together by trying to minimize the overall loss. This results in plenoptic weighting each statistic approximately equally and thus, implicitly, being considered equally important. They thus each have an approximately equal error at any given moment during synthesis, whereas the MATLAB code drops the error in the variance of the highpass residuals <em>incredibly</em> rapidly, matching it with much higher precision than the other statistics.</p>
<p>In order to make plenoptic’s synthesis perform similarly, we need to make this statistic more important than the others. We do this by using a custom loss function which reweights the representation of each image before computing the L2-norm of the difference these representations. We do this using a custom loss function which reweights the representation of each image before computing the L2-norm of the difference. See <a class="reference internal" href="../../../generated/plenoptic.tools.optim.html#plenoptic.tools.optim.portilla_simoncelli_loss_factory" title="plenoptic.tools.optim.portilla_simoncelli_loss_factory"><code class="xref py py-func docutils literal notranslate"><span class="pre">portilla_simoncelli_loss_factory</span></code></a> for more details.</p>
<p>We use a similar trick to remove the image’s minimum and maximum from the loss, since these non-differentiable functions make optimization unstable. The range penalty handles this constraint instead.</p>
<p>To see what this looks like, here is how you could create the custom loss function directly:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">plenoptic</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">po</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>

<span class="n">image</span> <span class="o">=</span> <span class="n">po</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">einstein</span><span class="p">()</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">po</span><span class="o">.</span><span class="n">simul</span><span class="o">.</span><span class="n">PortillaSimoncelli</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span>
<span class="n">weights</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">convert_to_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="n">image</span><span class="p">)))</span>
<span class="c1"># reweight the pixel min/max and the variance of the highpass residuals</span>
<span class="n">weights</span><span class="p">[</span><span class="s2">&quot;pixel_statistics&quot;</span><span class="p">][</span><span class="o">...</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">weights</span><span class="p">[</span><span class="s2">&quot;var_highpass_residual&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="s2">&quot;var_highpass_residual&quot;</span><span class="p">])</span>
<span class="n">weights</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">convert_to_tensor</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">loss</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">l2_norm</span><span class="p">(</span><span class="n">weights</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span> <span class="n">weights</span> <span class="o">*</span> <span class="n">y</span><span class="p">)</span>

<span class="n">met</span> <span class="o">=</span> <span class="n">po</span><span class="o">.</span><span class="n">synth</span><span class="o">.</span><span class="n">Metamer</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">loss_function</span><span class="o">=</span><span class="n">loss</span><span class="p">)</span>
</pre></div>
</div>
<p>This function makes use of the <a class="reference internal" href="../../../generated/plenoptic.simulate.models.portilla_simoncelli.html#plenoptic.simulate.models.portilla_simoncelli.PortillaSimoncelli.convert_to_dict" title="plenoptic.simulate.models.portilla_simoncelli.PortillaSimoncelli.convert_to_dict"><code class="xref py py-func docutils literal notranslate"><span class="pre">convert_to_dict</span></code></a> and <a class="reference internal" href="../../../generated/plenoptic.simulate.models.portilla_simoncelli.html#plenoptic.simulate.models.portilla_simoncelli.PortillaSimoncelli.convert_to_tensor" title="plenoptic.simulate.models.portilla_simoncelli.PortillaSimoncelli.convert_to_tensor"><code class="xref py py-func docutils literal notranslate"><span class="pre">convert_to_tensor</span></code></a> methods, which allow us to convert the Portilla-Simoncelli model representation from the standard vector form into a more structured dictionary form and vice versa.</p>
<div class="hint admonition">
<p class="admonition-title">How would I do this for my own model?</p>
<p>For your own model, you could do something similar to the above to reweight your model representation as needed. However, you could also simply change the representation of your model, performing the reweighting in your model’s <code class="docutils literal notranslate"><span class="pre">forward</span></code> <!-- skip-lint --> method. We did not do that because we want our representation to match that of the original MATLAB implementation. Using a reweighting function may also make testing out a variety of weights more straightforward.</p>
<p>We also recommend reading <a class="reference internal" href="../../../tips.html#tips-model-tweak"><span class="std std-ref">Tweaking the model</span></a> for more information.</p>
</div>
</section>
<section id="parallelism-and-cpu-efficiency">
<span id="threads"></span><h2>Parallelism and CPU efficiency<a class="headerlink" href="#parallelism-and-cpu-efficiency" title="Link to this heading"></a></h2>
<p>PyTorch allows users to control the number of <a class="reference external" href="https://en.wikipedia.org/wiki/Thread_(computing)">threads</a> used for parallelism on the CPU. By default, pytorch seems to be greedy, grabbing more threads than are helpful, especially if you are running several less memory-intensive jobs (like Portilla-Simoncelli metamer synthesis) at once. This problem is exacerbated when using the LBFGS optimizer.</p>
<p>Thus, we have found that CPU-only performance can be increased by about three times when doing the following to restrict the number of threads:</p>
<ul>
<li><p>Put <a class="reference external" href="https://docs.pytorch.org/docs/stable/generated/torch.set_num_threads.html#torch.set_num_threads" title="(in PyTorch v2.10)"><code class="xref py py-func docutils literal notranslate"><span class="pre">torch.set_num_threads(1)</span></code></a> at the top of your script.</p></li>
<li><p>Set the <code class="docutils literal notranslate"><span class="pre">OMP_NUM_THREADS</span></code> environment variable to 1 (this controls the number of threads available to <a class="reference external" href="https://docs.pytorch.org/tutorials/recipes/recipes/tuning_guide.html#utilize-openmp">OpenMP</a>). This can be done on the command-line by prepending <code class="docutils literal notranslate"><span class="pre">OMP_NUM_THREADS=1</span></code> before calling python (or ipython or jupyter or however you run your scripts), e.g., <code class="docutils literal notranslate"><span class="pre">OMP_NUM_THREADS=1</span> <span class="pre">python</span> <span class="pre">my_awesome_script.py</span></code> or by adding the following at the top of your script:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;OMP_NUM_THREADS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
</li>
</ul>
<p>In practice, you are encouraged to experiment with the two above settings to find the best configuration for your problem.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="ps_understand_stats.html" class="btn btn-neutral float-left" title="Understanding Portilla-Simoncelli model statistics" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="ps_limitations.html" class="btn btn-neutral float-right" title="Portilla-Simoncelli Model Limitations" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019-2025, Plenoptic authors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>