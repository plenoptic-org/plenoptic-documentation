

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Perceptual distance &mdash; plenoptic 1.3.2.dev56 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
      <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=a2d047e6" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=e82ef70f"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../_static/copybutton.js?v=35a8b989"></script>
      <script>let toggleHintShow = 'Click to show';</script>
      <script>let toggleHintHide = 'Click to hide';</script>
      <script>let toggleOpenOnPrint = 'true';</script>
      <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
      <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
      <script src="../../_static/design-tabs.js?v=f930bc37"></script>
      <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      <script type="application/vnd.jupyter.widget-state+json">{"state": {"c00914763595408f8a5e7721b0ec9fb1": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": "2", "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "b06164513f924781b770c473fc4068ec": {"model_name": "ProgressStyleModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "ProgressStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "StyleView", "bar_color": null, "description_width": ""}}, "c1717f9ff5524c23b4f5320a0bd9128f": {"model_name": "FloatProgressModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "FloatProgressModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "ProgressView", "bar_style": "success", "description": "", "description_allow_html": false, "layout": "IPY_MODEL_c00914763595408f8a5e7721b0ec9fb1", "max": 1.0, "min": 0.0, "orientation": "horizontal", "style": "IPY_MODEL_b06164513f924781b770c473fc4068ec", "tabbable": null, "tooltip": null, "value": 1.0}}, "d43f19f430994b1f90e50c2b2245ad51": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "e9625603e0c2428b97c1ac94ba19f587": {"model_name": "HTMLStyleModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "HTMLStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "StyleView", "background": null, "description_width": "", "font_size": null, "text_color": null}}, "515541a228c043d6936127cbfaa0dce0": {"model_name": "HTMLModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "HTMLModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "HTMLView", "description": "", "description_allow_html": false, "layout": "IPY_MODEL_d43f19f430994b1f90e50c2b2245ad51", "placeholder": "\u200b", "style": "IPY_MODEL_e9625603e0c2428b97c1ac94ba19f587", "tabbable": null, "tooltip": null, "value": "100%"}}, "3ece20663f404d71acf66262351ba517": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "c33daa20d94d4897bdf69b7e1810fefd": {"model_name": "HTMLStyleModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "HTMLStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "StyleView", "background": null, "description_width": "", "font_size": null, "text_color": null}}, "58689fbed1394d128b1bda996c4fc588": {"model_name": "HTMLModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "HTMLModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "HTMLView", "description": "", "description_allow_html": false, "layout": "IPY_MODEL_3ece20663f404d71acf66262351ba517", "placeholder": "\u200b", "style": "IPY_MODEL_c33daa20d94d4897bdf69b7e1810fefd", "tabbable": null, "tooltip": null, "value": "\u20071.23G/1.23G\u2007[00:00&lt;00:00,\u20072.74TB/s]"}}, "a0ff8072e2e1414bb5551b0d7b5d5d6d": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": "inline-flex", "flex": null, "flex_flow": "row wrap", "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": "79px"}}, "4a702a312ba540f48beab204e7117535": {"model_name": "HBoxModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "HBoxModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "HBoxView", "box_style": "", "children": ["IPY_MODEL_515541a228c043d6936127cbfaa0dce0", "IPY_MODEL_c1717f9ff5524c23b4f5320a0bd9128f", "IPY_MODEL_58689fbed1394d128b1bda996c4fc588"], "layout": "IPY_MODEL_a0ff8072e2e1414bb5551b0d7b5d5d6d", "tabbable": null, "tooltip": null}}}, "version_major": 2, "version_minor": 0}</script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script crossorigin="anonymous" data-jupyter-widgets-cdn="https://cdn.jsdelivr.net/npm/" src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@1.0.6/dist/embed-amd.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Portilla-Simoncelli Texture Metamer" href="Portilla_Simoncelli.html" />
    <link rel="prev" title="Metamers" href="../intro/Metamer.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            plenoptic
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Basic concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../jupyter.html">Using Jupyter to Run Example Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../conceptual_intro.html">Conceptual Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../models.html">Model requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../citation.html">Citation Guide and Bibliography</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Synthesis method introductions</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../intro/Eigendistortions.html">Eigendistortions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/MAD_Competition_1.html">MAD Competition Conceptual Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/MAD_Competition_2.html">MAD Competition Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/Metamer.html">Metamers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Models and metrics</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Perceptual distance</a></li>
<li class="toctree-l1"><a class="reference internal" href="Portilla_Simoncelli.html">Portilla-Simoncelli Texture Metamer</a></li>
<li class="toctree-l1"><a class="reference internal" href="Steerable_Pyramid.html">Steerable Pyramid</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Synthesis method examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../applications/Demo_Eigendistortion.html">Reproducing Berardino et al., 2017 (Eigendistortions)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../applications/Original_MAD.html">Reproducing Wang and Simoncelli, 2008 (MAD Competition)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Advanced usage</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../synthesis.html">Synthesis object design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tips.html">Tips and Tricks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reproducibility.html">Reproducibility and Compatibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/modules.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/Display.html">Display and animate functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/Synthesis_extensions.html">Extending existing synthesis objects</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">plenoptic</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Perceptual distance</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/tutorials/models/Perceptual_distance.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pooch</span>

<span class="c1"># don&#39;t have pooch output messages about downloading or untarring</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">pooch</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="s2">&quot;WARNING&quot;</span><span class="p">)</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span>
    <span class="s2">&quot;ignore&quot;</span><span class="p">,</span>
    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;The default behavior of tarfile extraction&quot;</span><span class="p">,</span>
    <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="important admonition">
<p class="admonition-title">Download</p>
<p>Download this notebook: <strong><a class="reference download internal" download="" href="../../_downloads/4eede51f5de3f8c820af43279743a570/Perceptual_distance.ipynb"><code class="xref download myst-nb docutils literal notranslate"><span class="pre">Perceptual_distance.ipynb</span></code></a></strong>!</p>
</div>
<section class="tex2jax_ignore mathjax_ignore" id="perceptual-distance">
<h1>Perceptual distance<a class="headerlink" href="#perceptual-distance" title="Link to this heading"></a></h1>
<p>The easiest way to measure the difference between two images is by computing the mean square error (MSE), but it does not match the perceptual distance judged by humans. Several perceptual distance functions have been developed to better match human perception. This tutorial introduces three perceptual distance functions available in <code class="docutils literal notranslate"><span class="pre">plenoptic</span></code> package: <a class="reference internal" href="../../api/plenoptic.metric.html#plenoptic.metric.perceptual_distance.ssim" title="plenoptic.metric.perceptual_distance.ssim"><span class="xref myst py py-func">SSIM</span></a> (structural similarity), <a class="reference internal" href="../../api/plenoptic.metric.html#plenoptic.metric.perceptual_distance.ms_ssim" title="plenoptic.metric.perceptual_distance.ms_ssim"><span class="xref myst py py-func">MS-SSIM</span></a> (multiscale structural similarity) and <a class="reference internal" href="../../api/plenoptic.metric.html#plenoptic.metric.perceptual_distance.nlpd" title="plenoptic.metric.perceptual_distance.nlpd"><span class="xref myst py py-func">NLPD</span></a> (normalized Laplacian pyramid distance).</p>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Link to this heading"></a></h2>
<p><strong>SSIM</strong>: <a class="reference external" href="https://www.cns.nyu.edu/pub/lcv/wang03-reprint.pdf">Wang, Z., Bovik, A. C., Sheikh, H. R., &amp; Simoncelli, E. P. (2004). Image quality assessment: from error visibility to structural similarity. <em>IEEE transactions on image processing</em>, 13(4), 600-612.</a></p>
<p><strong>MS-SSIM</strong>: <a class="reference external" href="https://www.cns.nyu.edu/pub/eero/wang03b.pdf">Wang, Z., Simoncelli, E. P., &amp; Bovik, A. C. (2003, November). Multiscale structural similarity for image quality assessment. In <em>The Thrity-Seventh Asilomar Conference on Signals, Systems &amp; Computers</em>, 2003 (Vol. 2, pp. 1398-1402). IEEE.</a></p>
<p><strong>NLPD</strong>: <a class="reference external" href="https://www.cns.nyu.edu/pub/lcv/laparra16a-reprint.pdf">Laparra, V., Ballé, J., Berardino, A., &amp; Simoncelli, E. P. (2016). Perceptual image quality assessment using a normalized Laplacian pyramid. <em>Electronic Imaging</em>, 2016(16), 1-6.</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">imageio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">pearsonr</span><span class="p">,</span> <span class="n">spearmanr</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">plenoptic</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">po</span>

<span class="c1"># this notebook runs just about as fast with GPU and CPU</span>
<span class="n">DEVICE</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="ssim-structural-similarity">
<h2>SSIM (structural similarity)<a class="headerlink" href="#ssim-structural-similarity" title="Link to this heading"></a></h2>
<p>The idea of SSIM index is to decompose the difference between two images into three components: luminance, contrast and structure. For two small image patches <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> and <span class="math notranslate nohighlight">\(\mathbf{y}\)</span>, these three components of difference are defined as:</p>
<div class="amsmath math notranslate nohighlight">
\[\begin{gather*}
l(\mathbf{x}, \mathbf{y}) = \frac{2 \mu_x \mu_y + C_1}{\mu_x^2 + \mu_y^2 + C_1}\\
c(\mathbf{x}, \mathbf{y}) = \frac{2 \sigma_x \sigma_y + C_2}{\sigma_x^2 + \sigma_y^2 + C_2}\\
s(\mathbf{x}, \mathbf{y}) = \frac{\sigma_{xy} + C_3}{\sigma_x \sigma_y + C_3}
\end{gather*}\]</div>
<p>where:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\mu_x\)</span> and <span class="math notranslate nohighlight">\(\mu_y\)</span> are the mean of <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> and <span class="math notranslate nohighlight">\(\mathbf{y}\)</span>,</p></li>
<li><p><span class="math notranslate nohighlight">\(\sigma_x\)</span> and <span class="math notranslate nohighlight">\(\sigma_y\)</span> are the standard deviation of <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> and <span class="math notranslate nohighlight">\(\mathbf{y}\)</span>,</p></li>
<li><p><span class="math notranslate nohighlight">\(\sigma_{xy}\)</span> is the covariance between <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> and <span class="math notranslate nohighlight">\(\mathbf{y}\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(C_1, C_2, C_3\)</span> are small constants.</p></li>
</ul>
<p>If we ignore the small constants, we can see that the luminance term <span class="math notranslate nohighlight">\(l(\mathbf{x}, \mathbf{y})\)</span> is a scale-invariant similarity measurement between <span class="math notranslate nohighlight">\(\mu_x\)</span> and <span class="math notranslate nohighlight">\(\mu_y\)</span>, and the contrast term <span class="math notranslate nohighlight">\(c(\mathbf{x}, \mathbf{y})\)</span> is such a measurement between <span class="math notranslate nohighlight">\(\sigma_x\)</span> and <span class="math notranslate nohighlight">\(\sigma_y\)</span>. The structural term <span class="math notranslate nohighlight">\(s(\mathbf{x}, \mathbf{y})\)</span> is the correlation coefficient between <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> and <span class="math notranslate nohighlight">\(\mathbf{y}\)</span>, which is invariant to addition and multiplication of constants on <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> or <span class="math notranslate nohighlight">\(\mathbf{y}\)</span>.</p>
<p>Local SSIM between two small image patches <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> and <span class="math notranslate nohighlight">\(\mathbf{y}\)</span> is defined as (let <span class="math notranslate nohighlight">\(C_3 = C_2 / 2\)</span>):</p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
d(\mathbf{x}, \mathbf{y}) &amp;= l(\mathbf{x}, \mathbf{y}) c(\mathbf{x}, \mathbf{y}) s(\mathbf{x}, \mathbf{y})\\
&amp;= \frac{\left( 2 \mu_x \mu_y + C_1 \right) \left( 2\sigma_{xy} + C_2 \right)} {\left( \mu_x^2 + \mu_y^2 + C_1 \right) \left( \sigma_x^2 + \sigma_y^2 + C_2 \right)}
\end{align*}\]</div>
<p>The local SSIM value <span class="math notranslate nohighlight">\(d(\mathbf{x}, \mathbf{y}) = 1\)</span> means the two patches are identical and <span class="math notranslate nohighlight">\(d(\mathbf{x}, \mathbf{y}) = 0\)</span> means they’re very different. When the two patches are negatively correlated, <span class="math notranslate nohighlight">\(d(\mathbf{x}, \mathbf{y})\)</span> can be negative. The local SSIM value is bounded between -1 and 1.</p>
<p>For two full images <span class="math notranslate nohighlight">\(\mathbf{X}, \mathbf{Y}\)</span>, an SSIM map is obtained by computing the local SSIM value <span class="math notranslate nohighlight">\(d\)</span> across the whole image. For each position on the images, instead of using a square patch centered on it, a circular-symmeric Gaussian kernel is used to compute the local mean, standard deviation and covariance terms <span class="math notranslate nohighlight">\(\mu_{X,i}, \mu_{Y,i}, \sigma_{X,i}, \sigma_{Y,i}, \sigma_{XY,i}\)</span>, where <span class="math notranslate nohighlight">\(i\)</span> is the pixel index. In this way we can obtain an SSIM map <span class="math notranslate nohighlight">\(d_i(\mathbf{X}, \mathbf{Y})\)</span>. The values in the SSIM map are averaged to generate a single number, which is the SSIM index:</p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
\text{SSIM}(\mathbf{X}, \mathbf{Y}) &amp;= \frac{1}{N} \sum_{i=1}^N d_i(\mathbf{X}, \mathbf{Y})\\
&amp;= \frac{1}{N} \sum_{i=1}^N l_i(\mathbf{X}, \mathbf{Y}) c_i(\mathbf{X}, \mathbf{Y}) s_i(\mathbf{X}, \mathbf{Y})\\
&amp;= \frac{1}{N} \sum_{i=1}^N \frac{\left( 2 \mu_{X,i} \mu_{Y,i} + C_1 \right) \left( 2\sigma_{XY,i} + C_2 \right)} {\left( {\mu_{X,i}}^2 + {\mu_{Y,i}}^2 + C_1 \right) \left( {\sigma_{X,i}}^2 + {\sigma_{Y,i}}^2 + C_2 \right)}
\end{align*}\]</div>
<p>where <span class="math notranslate nohighlight">\(N\)</span> is the number of pixels of the image. The SSIM index is also bounded between -1 and 1.  In <code class="docutils literal notranslate"><span class="pre">plenoptic</span></code>, the SSIM map is computed by the function <a class="reference internal" href="../../api/plenoptic.metric.html#plenoptic.metric.perceptual_distance.ssim_map" title="plenoptic.metric.perceptual_distance.ssim_map"><code class="xref py py-func docutils literal notranslate"><span class="pre">ssim_map</span></code></a>, and the SSIM index itself is computed by the function <a class="reference internal" href="../../api/plenoptic.metric.html#plenoptic.metric.perceptual_distance.ssim" title="plenoptic.metric.perceptual_distance.ssim"><code class="xref py py-func docutils literal notranslate"><span class="pre">ssim</span></code></a>. For more information, see the original paper:</p>
<p><a class="reference external" href="https://www.cns.nyu.edu/pub/lcv/wang03-reprint.pdf">Wang, Z., Bovik, A. C., Sheikh, H. R., &amp; Simoncelli, E. P. (2004). Image quality assessment: from error visibility to structural similarity. <em>IEEE transactions on image processing</em>, 13(4), 600-612.</a></p>
<section id="understanding-ssim">
<h3>Understanding SSIM<a class="headerlink" href="#understanding-ssim" title="Link to this heading"></a></h3>
<p>We demonstrate the effectiveness of SSIM by generating five different types of distortions (contrast stretching, mean shifting, JPEG compression, blurring, and salt-pepper noise) with the same MSE, and computing their SSIM values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>


<span class="k">def</span><span class="w"> </span><span class="nf">add_jpeg_artifact</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">quality</span><span class="p">):</span>
    <span class="c1"># need to convert this back to 2d 8-bit int for writing out as jpg</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">po</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="c1"># write to a temporary file</span>
    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.jpg&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmp</span><span class="p">:</span>
        <span class="n">imageio</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">quality</span><span class="o">=</span><span class="n">quality</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">po</span><span class="o">.</span><span class="n">load_images</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">img</span>


<span class="k">def</span><span class="w"> </span><span class="nf">add_saltpepper_noise</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">threshold</span><span class="p">):</span>
    <span class="n">po</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">img_saltpepper</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span>
                <span class="n">img_saltpepper</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">threshold</span><span class="p">:</span>
                <span class="n">img_saltpepper</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">img_saltpepper</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_distorted_images</span><span class="p">():</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">po</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">einstein</span><span class="p">()</span>
    <span class="n">img_mean</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">img</span> <span class="o">+</span> <span class="mf">0.05983</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">img_contrast</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">img</span> <span class="o">+</span> <span class="mf">0.20515</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">img</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">img_blur</span> <span class="o">=</span> <span class="n">po</span><span class="o">.</span><span class="n">simul</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">2.68</span><span class="p">)(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">img_saltpepper</span> <span class="o">=</span> <span class="n">add_saltpepper_noise</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.00651</span><span class="p">)</span>
    <span class="n">img_jpeg</span> <span class="o">=</span> <span class="n">add_jpeg_artifact</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">quality</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">img_distorted</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
        <span class="p">[</span><span class="n">img</span><span class="p">,</span> <span class="n">img_mean</span><span class="p">,</span> <span class="n">img_contrast</span><span class="p">,</span> <span class="n">img_blur</span><span class="p">,</span> <span class="n">img_saltpepper</span><span class="p">,</span> <span class="n">img_jpeg</span><span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">img_distorted</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>


<span class="n">img_distorted</span> <span class="o">=</span> <span class="n">get_distorted_images</span><span class="p">()</span>
<span class="n">mse_values</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">img_distorted</span> <span class="o">-</span> <span class="n">img_distorted</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">ssim_values</span> <span class="o">=</span> <span class="n">po</span><span class="o">.</span><span class="n">metric</span><span class="o">.</span><span class="n">ssim</span><span class="p">(</span><span class="n">img_distorted</span><span class="p">,</span> <span class="n">img_distorted</span><span class="p">[[</span><span class="mi">0</span><span class="p">]])[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">names</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Original image&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Mean shift&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Contrast change&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Gaussian blur&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Salt-and-pepper noise&quot;</span><span class="p">,</span>
    <span class="s2">&quot;JPEG artifact&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">titles</span> <span class="o">=</span> <span class="p">[</span>
    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">MSE=</span><span class="si">{</span><span class="n">mse_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">, SSIM=</span><span class="si">{</span><span class="n">ssim_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="p">]</span>
<span class="n">po</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_distorted</span><span class="p">,</span> <span class="n">vrange</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">titles</span><span class="p">,</span> <span class="n">col_wrap</span><span class="o">=</span><span class="mi">3</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/17778ca445a73a60deacad1026f4b78fb13902a90d66306de3badc76c0b2945c.png" src="../../_images/17778ca445a73a60deacad1026f4b78fb13902a90d66306de3badc76c0b2945c.png" />
</div>
</div>
<p>We can see that, while MSE is identical for all the distorted images, SSIM decreases as we go from left to right, top to bottom. Thus, SSIM matches human perception better than MSE.</p>
<p>While the scalar SSIM index is a concise summary, the SSIM map offers richer information about where perceptual discrepancy is located in the image. Here, we visualize the SSIM map of a JPEG compressed image, and also show the absolute error (absolute value of the difference) for comparison. In both maps, darker means more different.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_demo_images</span><span class="p">():</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">po</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">parrot</span><span class="p">(</span><span class="n">as_gray</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">img_jpeg</span> <span class="o">=</span> <span class="n">add_jpeg_artifact</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">quality</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">ssim_map_small</span> <span class="o">=</span> <span class="n">po</span><span class="o">.</span><span class="n">metric</span><span class="o">.</span><span class="n">ssim_map</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">img_jpeg</span><span class="p">)</span>
    <span class="n">ssim_map</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">ssim_map</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">5</span><span class="p">:</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">ssim_map_small</span>
    <span class="n">abs_map</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">img</span> <span class="o">-</span> <span class="n">img_jpeg</span><span class="p">)</span>
    <span class="n">img_demo</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">img</span><span class="p">,</span> <span class="n">img_jpeg</span><span class="p">,</span> <span class="n">ssim_map</span><span class="p">,</span> <span class="n">abs_map</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">img_demo</span>


<span class="n">img_demo</span> <span class="o">=</span> <span class="n">get_demo_images</span><span class="p">()</span>
<span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Original&quot;</span><span class="p">,</span> <span class="s2">&quot;JPEG artifact&quot;</span><span class="p">,</span> <span class="s2">&quot;SSIM map&quot;</span><span class="p">,</span> <span class="s2">&quot;Absolute error&quot;</span><span class="p">]</span>
<span class="n">po</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_demo</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">titles</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/1344fc161fec4e22931cc34e9838b09e01b49a7b38ca5c0b2fd51e296499b449.png" src="../../_images/1344fc161fec4e22931cc34e9838b09e01b49a7b38ca5c0b2fd51e296499b449.png" />
</div>
</div>
<p>You can judge whether the SSIM map captures the location of perceptual discrepancy better than absolute error.</p>
</section>
</section>
<section id="ms-ssim-multiscale-structural-similarity">
<h2>MS-SSIM (multiscale structural similarity)<a class="headerlink" href="#ms-ssim-multiscale-structural-similarity" title="Link to this heading"></a></h2>
<p>MS-SSIM computes SSIM on multiple scales of the images. To do this, the two images <span class="math notranslate nohighlight">\(\mathbf{X}\)</span> and <span class="math notranslate nohighlight">\(\mathbf{Y}\)</span> are recursively blurred and downsampled by a factor of 2 to produce two sequences of images: <span class="math notranslate nohighlight">\(\mathbf{X}_1, \cdots, \mathbf{X}_M\)</span> and <span class="math notranslate nohighlight">\(\mathbf{Y}_1, \cdots, \mathbf{Y}_M\)</span>, where <span class="math notranslate nohighlight">\(\mathbf{X}_1 = \mathbf{X}\)</span>, and <span class="math notranslate nohighlight">\(\mathbf{X}_{i+1}\)</span> is obtained by blurring and downsampling <span class="math notranslate nohighlight">\(\mathbf{X}_{i}\)</span> (same for <span class="math notranslate nohighlight">\(\mathbf{Y}\)</span>). Such a sequence is called a Gaussian pyramid. We define a contrast-structural index that does not include luminance component:</p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
\text{CS}(\mathbf{X}, \mathbf{Y}) &amp;= \frac{1}{N} \sum_{i=1}^N c_i(\mathbf{X}, \mathbf{Y}) s_i(\mathbf{X}, \mathbf{Y})\\
&amp;= \frac{1}{N} \sum_{i=1}^N \frac{2\sigma_{XY,i} + C_2} {{\sigma_{X,i}}^2 + {\sigma_{Y,i}}^2 + C_2}
\end{align*}\]</div>
<p>The MS-SSIM index is defined as:</p>
<div class="math notranslate nohighlight">
\[
\text{MS-SSIM}(\mathbf{X}, \mathbf{Y}) = \text{SSIM}(\mathbf{X}_M, \mathbf{Y}_M)^{\gamma_M} \prod_{k=1}^{M-1} \text{CS}(\mathbf{X}_i, \mathbf{Y}_i)^{\gamma_i}
\]</div>
<p>where <span class="math notranslate nohighlight">\(\gamma_1, \cdots, \gamma_M\)</span> are exponents that determine the relative importance of different scales. They are determined by a human psychophysics experiment and are constrained to sum to 1. When <span class="math notranslate nohighlight">\(M=1\)</span>, the MS-SSIM index is the same as the SSIM index. In the standard implementation of MS-SSIM, <span class="math notranslate nohighlight">\(M = 5\)</span>. In <code class="docutils literal notranslate"><span class="pre">plenoptic</span></code>, the MS-SSIM index is computed by the function <a class="reference internal" href="../../api/plenoptic.metric.html#plenoptic.metric.perceptual_distance.ms_ssim" title="plenoptic.metric.perceptual_distance.ms_ssim"><code class="xref py py-func docutils literal notranslate"><span class="pre">ms_ssim</span></code></a>. For more information, see the original paper:</p>
<p><a class="reference external" href="https://www.cns.nyu.edu/pub/eero/wang03b.pdf">Wang, Z., Simoncelli, E. P., &amp; Bovik, A. C. (2003, November). Multiscale structural similarity for image quality assessment. In <em>The Thrity-Seventh Asilomar Conference on Signals, Systems &amp; Computers</em>, 2003 (Vol. 2, pp. 1398-1402). IEEE.</a></p>
<p>Here we use the same distortions on Einstein image to demonstrate MS-SSIM:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">msssim_values</span> <span class="o">=</span> <span class="n">po</span><span class="o">.</span><span class="n">metric</span><span class="o">.</span><span class="n">ms_ssim</span><span class="p">(</span><span class="n">img_distorted</span><span class="p">,</span> <span class="n">img_distorted</span><span class="p">[[</span><span class="mi">0</span><span class="p">]])[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">titles</span> <span class="o">=</span> <span class="p">[</span>
    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">MSE=</span><span class="si">{</span><span class="n">mse_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">, MS-SSIM=</span><span class="si">{</span><span class="n">msssim_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="p">]</span>
<span class="n">po</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_distorted</span><span class="p">,</span> <span class="n">vrange</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">titles</span><span class="p">,</span> <span class="n">col_wrap</span><span class="o">=</span><span class="mi">3</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/6b5a6dd037eab40a03baa7ce2db54179c7ab0050ed070c0b07b27742e0b3146a.png" src="../../_images/6b5a6dd037eab40a03baa7ce2db54179c7ab0050ed070c0b07b27742e0b3146a.png" />
</div>
</div>
</section>
<section id="nlpd-normalized-laplacian-pyramid-distance">
<h2>NLPD (normalized Laplacian pyramid distance)<a class="headerlink" href="#nlpd-normalized-laplacian-pyramid-distance" title="Link to this heading"></a></h2>
<p>Similar to MS-SSIM, the NLPD is also based on a multiscale representation of the images. Also similar to MS-SSIM, the idea of NLPD is also to separate out the effects of luminance and contrast difference. Unlike MS-SSIM, the NLPD directly performs luminance subtraction and contrast normalization on each scale, and then computes simple square difference. The NLPD uses the Laplacian pyramid for luminance subtraction. Given a Gaussian pyramid <span class="math notranslate nohighlight">\(\mathbf{X}_1, \cdots, \mathbf{X}_M\)</span>, for <span class="math notranslate nohighlight">\(k=1, \cdots, M - 1\)</span>, we upsample and blur <span class="math notranslate nohighlight">\(\mathbf{X}_{k+1}\)</span> to produce <span class="math notranslate nohighlight">\(\mathbf{\hat{X}}_k\)</span>, which is a blurry version of <span class="math notranslate nohighlight">\(\mathbf{X}_k\)</span>, and let <span class="math notranslate nohighlight">\(\mathbf{X}'_k = \mathbf{X}_k - \mathbf{\hat{X}}_k\)</span>. Define <span class="math notranslate nohighlight">\(\mathbf{X}'_M = \mathbf{X}_M\)</span>, and we get the Laplacian pyramid <span class="math notranslate nohighlight">\(\mathbf{X}'_1, \cdots, \mathbf{X}'_M\)</span>. In <code class="docutils literal notranslate"><span class="pre">plenoptic</span></code>, the Laplacian pyramid is implemented by <a class="reference internal" href="../../api/plenoptic.simulate.canonical_computations.html#plenoptic.simulate.canonical_computations.laplacian_pyramid.LaplacianPyramid" title="plenoptic.simulate.canonical_computations.laplacian_pyramid.LaplacianPyramid"><code class="xref py py-class docutils literal notranslate"><span class="pre">LaplacianPyramid</span></code></a>.</p>
<p>The contrast normalization is achieved by dividing by a local estimation of amplitude:</p>
<div class="amsmath math notranslate nohighlight">
\[\begin{gather*}
\mathbf{X}''_{k,i} = \frac{\mathbf{X}'_{k,i}} {f(\mathbf{X}'_{k,N(i)}; \sigma_k, \mathbf{p}_k)},\\
f(\mathbf{X}'_{k,N(i)}; \sigma_k, \mathbf{p}_k) = \sigma_k + \sum_{j\in N(i)} p_{k,j-i} |\mathbf{X}'_{k,j}|
\end{gather*}\]</div>
<p>where <span class="math notranslate nohighlight">\(N(i)\)</span> is the neighborhood of pixel <span class="math notranslate nohighlight">\(i\)</span> which does not include <span class="math notranslate nohighlight">\(i\)</span> itself, and the parameters <span class="math notranslate nohighlight">\(\sigma_k\)</span> and <span class="math notranslate nohighlight">\(\mathbf{p}_k\)</span> are learned from an image dataset:</p>
<div class="amsmath math notranslate nohighlight">
\[\begin{gather*}
\sigma_k = \mathbb{E}_{\mathbf{X},i} \left( |\mathbf{X}'_{k,i}| \right)\\
\mathbf{p}_k = \arg\min_{\mathbf{p}_k} \mathbb{E}_{\mathbf{X},i} \left( \mathbf{X}'_{k,i} - f(\mathbf{X}'_{k,N(i)}; \sigma_k, \mathbf{p}_k) \right)^2
\end{gather*}\]</div>
<p>Note that this learning is performed on the clean images only, without access to the corruption type or human phychophysics data. The sequence <span class="math notranslate nohighlight">\(\mathbf{X}''_1, \cdots, \mathbf{X}''_M\)</span> is the normalized Laplacian pyramid. The same procedure is done for <span class="math notranslate nohighlight">\(\mathbf{Y}\)</span>. The NLPD is defined as:</p>
<div class="math notranslate nohighlight">
\[
\text{NLPD}(\mathbf{X}, \mathbf{Y}) = \frac{1}{M} \sum_{k=1}^M \sqrt{\frac{1}{N_k} \sum_{i=1}^{N_k} (\mathbf{X}''_{k,i} - \mathbf{Y}''_{k,i})^2}
\]</div>
<p>where <span class="math notranslate nohighlight">\(N_k\)</span> is the number of pixels of <span class="math notranslate nohighlight">\(\mathbf{X}''_k\)</span>. In <code class="docutils literal notranslate"><span class="pre">plenoptic</span></code>, the NLPD is computed by the function <a class="reference internal" href="../../api/plenoptic.metric.html#plenoptic.metric.perceptual_distance.nlpd" title="plenoptic.metric.perceptual_distance.nlpd"><code class="xref py py-func docutils literal notranslate"><span class="pre">nlpd</span></code></a>. For more information, see the original paper:</p>
<p><a class="reference external" href="https://www.cns.nyu.edu/pub/lcv/laparra16a-reprint.pdf">Laparra, V., Ballé, J., Berardino, A., &amp; Simoncelli, E. P. (2016). Perceptual image quality assessment using a normalized Laplacian pyramid. <em>Electronic Imaging</em>, 2016(16), 1-6.</a></p>
<p>Here we use the same distortions on Einstein image to demonstrate NLPD:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nlpd_values</span> <span class="o">=</span> <span class="n">po</span><span class="o">.</span><span class="n">metric</span><span class="o">.</span><span class="n">nlpd</span><span class="p">(</span><span class="n">img_distorted</span><span class="p">,</span> <span class="n">img_distorted</span><span class="p">[[</span><span class="mi">0</span><span class="p">]])[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">titles</span> <span class="o">=</span> <span class="p">[</span>
    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">MSE=</span><span class="si">{</span><span class="n">mse_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">, NLPD=</span><span class="si">{</span><span class="n">nlpd_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="p">]</span>
<span class="n">po</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_distorted</span><span class="p">,</span> <span class="n">vrange</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">titles</span><span class="p">,</span> <span class="n">col_wrap</span><span class="o">=</span><span class="mi">3</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/0a7861963a6e341b0f4446b03316e72a1404d9879bd4ae329d72d7de66d1572e.png" src="../../_images/0a7861963a6e341b0f4446b03316e72a1404d9879bd4ae329d72d7de66d1572e.png" />
</div>
</div>
<p>Note that, unlike SSIM and MS-SSIM, NLPD is a <em>distance</em> and so smaller numbers mean that a pair of image are more similar. Thus, the above images are ranked from most to least similar to the original image.</p>
</section>
<section id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Link to this heading"></a></h2>
<p>The basic usage of <a class="reference internal" href="../../api/plenoptic.metric.html#plenoptic.metric.perceptual_distance.ssim" title="plenoptic.metric.perceptual_distance.ssim"><code class="xref py py-func docutils literal notranslate"><span class="pre">ssim</span></code></a>, <a class="reference internal" href="../../api/plenoptic.metric.html#plenoptic.metric.perceptual_distance.ms_ssim" title="plenoptic.metric.perceptual_distance.ms_ssim"><code class="xref py py-func docutils literal notranslate"><span class="pre">ms_ssim</span></code></a> and <a class="reference internal" href="../../api/plenoptic.metric.html#plenoptic.metric.perceptual_distance.nlpd" title="plenoptic.metric.perceptual_distance.nlpd"><code class="xref py py-func docutils literal notranslate"><span class="pre">nlpd</span></code></a> are the same: they take two arguments, the images to be compared, whose shapes should be in the format <code class="docutils literal notranslate"><span class="pre">(batch,</span> <span class="pre">channel,</span> <span class="pre">height,</span> <span class="pre">width)</span></code>. All these functions are designed for grayscale images, so the channel dimension is treated as another batch dimension. The height and width of the two arguments should be the same, and the batch and channel sizes of the two arguments should be broadcastable. The broadcasting is already demonstrated in the examples of SSIM, MS-SSIM and NLPD that use the Einstein image.</p>
<p>SSIM, MS-SSIM and NLPD are not scale-invariant. The input images should have values between 0 and 1. Otherwise, the result may be inaccurate, and we will raise a warning (but will still compute it).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Take SSIM as an example here. The images in img_demo have a range of [0, 1].</span>
<span class="n">val1</span> <span class="o">=</span> <span class="n">po</span><span class="o">.</span><span class="n">metric</span><span class="o">.</span><span class="n">ssim</span><span class="p">(</span><span class="n">img_demo</span><span class="p">[[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">img_demo</span><span class="p">[[</span><span class="mi">1</span><span class="p">]])</span>
<span class="n">val2</span> <span class="o">=</span> <span class="n">po</span><span class="o">.</span><span class="n">metric</span><span class="o">.</span><span class="n">ssim</span><span class="p">(</span><span class="n">img_demo</span><span class="p">[[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="mi">255</span><span class="p">,</span> <span class="n">img_demo</span><span class="p">[[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span>
<span class="c1"># This produces a wrong result and triggers a warning: Image range falls</span>
<span class="c1"># outside [0, 1].</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;True SSIM: </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">val1</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, rescaled image SSIM: </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">val2</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True SSIM: 0.7703, rescaled image SSIM: 0.4048
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/agent/workspace/neurorse_plenoptic_PR-374@3/lib/python3.11/site-packages/plenoptic/metric/perceptual_distance.py:87: UserWarning: Image range falls outside [0, 1]. SSIM output may not make sense.
  warnings.warn(
</pre></div>
</div>
</div>
</div>
</section>
<section id="comparison-of-performance">
<h2>Comparison of performance<a class="headerlink" href="#comparison-of-performance" title="Link to this heading"></a></h2>
<p>The performance of these perceptual distance metrics can be measured by the correlation with human psychophysics data: the TID2013 dataset consists of 3000 different distorted images (25 clean images x 24 types of distortions x 5 levels of distortions), each with its own mean opinion score (the perceived quality of the distorted image). Higher mean opinion score means a smaller distance from its corresponding clean image. The TID2013 dataset is described in the following paper:</p>
<p><a class="reference external" href="https://www.sciencedirect.com/science/article/pii/S0923596514001490">Ponomarenko, N., Jin, L., Ieremeiev, O., Lukin, V., Egiazarian, K., Astola, J., … &amp; Kuo, C. C. J. (2015). Image database TID2013: Peculiarities, results and perspectives. <em>Signal processing: Image communication</em>, 30, 57-77.</a></p>
<p>Since both SSIM and MS-SSIM have higher values for less different image pairs, and are maximized at 1 for identical images, we need to convert them to distances as 1-SSIM and 1-(MS-SSIM). Then we will plot mean opinion score against the three metrics: 1-SSIM, 1-(MS-SSIM) and NLPD, as well as the baseline RMSE (square root of mean square error). We will also measure the correlation.</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>To execute this part of the notebook, the TID2013 dataset needs to be downloaded. In order to do so, we use an optional dependency, <code class="docutils literal notranslate"><span class="pre">pooch</span></code>. If the following raises an <code class="docutils literal notranslate"><span class="pre">ImportError</span></code> or <code class="docutils literal notranslate"><span class="pre">ModuleNotFoundError</span></code> then install <code class="docutils literal notranslate"><span class="pre">pooch</span></code> in your plenoptic environment and restart your kernel. Note that the dataset is fairly large, about 1GB.</p>
</div>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">plenoptic.data.fetch</span><span class="w"> </span><span class="kn">import</span> <span class="n">fetch_data</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_tid2013_data</span><span class="p">():</span>
    <span class="n">folder</span> <span class="o">=</span> <span class="n">fetch_data</span><span class="p">(</span><span class="s2">&quot;tid2013.tar.gz&quot;</span><span class="p">)</span>
    <span class="n">reference_images</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">((</span><span class="n">folder</span> <span class="o">/</span> <span class="s2">&quot;reference_images&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">iterdir</span><span class="p">())</span>
    <span class="n">reference_images</span> <span class="o">=</span> <span class="n">po</span><span class="o">.</span><span class="n">load_images</span><span class="p">(</span><span class="n">reference_images</span><span class="p">)</span>
    <span class="c1"># disorted_images file names are of the form &quot;i##_##_#.bmp&quot; (and both the i and</span>
    <span class="c1"># the bmp can be either upper or lower case). the following sorts them by the</span>
    <span class="c1"># numbers in the order they appear</span>
    <span class="n">distorted_images</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
        <span class="p">(</span><span class="n">folder</span> <span class="o">/</span> <span class="s2">&quot;distorted_images&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">iterdir</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">stem</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">distorted_images</span> <span class="o">=</span> <span class="n">po</span><span class="o">.</span><span class="n">load_images</span><span class="p">(</span><span class="n">distorted_images</span><span class="p">)</span>
    <span class="c1"># reshape the tensor so that the first dimension corresponds to the reference image,</span>
    <span class="c1"># the second the distortion type, and the third the sample</span>
    <span class="n">distorted_images</span> <span class="o">=</span> <span class="n">distorted_images</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">25</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">384</span><span class="p">,</span> <span class="mi">512</span><span class="p">))</span>

    <span class="c1"># Remove color distortions</span>
    <span class="n">non_color_distorts</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">17</span><span class="p">))</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">24</span><span class="p">))</span>
    <span class="n">distorted_images</span> <span class="o">=</span> <span class="n">distorted_images</span><span class="p">[:,</span> <span class="n">non_color_distorts</span><span class="p">]</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">folder</span> <span class="o">/</span> <span class="s2">&quot;mos.txt&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">g</span><span class="p">:</span>
        <span class="n">mos_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">readlines</span><span class="p">()))</span>
    <span class="n">mos_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mos_values</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">25</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
    <span class="c1"># Remove color distortions</span>
    <span class="n">mos_values</span> <span class="o">=</span> <span class="n">mos_values</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">17</span><span class="p">))</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">24</span><span class="p">))]</span>
    <span class="k">return</span> <span class="n">reference_images</span><span class="p">,</span> <span class="n">distorted_images</span><span class="p">,</span> <span class="n">mos_values</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">correlate_with_tid</span><span class="p">(</span><span class="n">func_list</span><span class="p">,</span> <span class="n">name_list</span><span class="p">):</span>
    <span class="n">reference_images</span><span class="p">,</span> <span class="n">distorted_images</span><span class="p">,</span> <span class="n">mos_values</span> <span class="o">=</span> <span class="n">get_tid2013_data</span><span class="p">()</span>
    <span class="n">distance</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">func_list</span><span class="p">),</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">func_list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">):</span>
            <span class="n">distance</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span>
                <span class="n">reference_images</span><span class="p">[[</span><span class="n">j</span><span class="p">]],</span> <span class="n">distorted_images</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

    <span class="n">plot_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">func_list</span><span class="p">))))</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
        <span class="n">plot_size</span><span class="p">,</span>
        <span class="n">plot_size</span><span class="p">,</span>
        <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">plot_size</span> <span class="o">*</span> <span class="mi">6</span><span class="p">,</span> <span class="n">plot_size</span> <span class="o">*</span> <span class="mi">6</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">axs</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">edgecolor_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">]</span>
    <span class="n">facecolor_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">]</span>
    <span class="n">shape_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;^&quot;</span><span class="p">]</span>
    <span class="n">distortion_names</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;Additive Gaussian noise&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Spatially correlated noise&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Masked noise&quot;</span><span class="p">,</span>
        <span class="s2">&quot;High frequency noise&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Impulse noise&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Quantization noise&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Gaussian blur&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Image denoising&quot;</span><span class="p">,</span>
        <span class="s2">&quot;JPEG compression&quot;</span><span class="p">,</span>
        <span class="s2">&quot;JPEG2000 compression&quot;</span><span class="p">,</span>
        <span class="s2">&quot;JPEG transmission errors&quot;</span><span class="p">,</span>
        <span class="s2">&quot;JPEG2000 transmission errors&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Non eccentricity pattern noise&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Local block-wise distortions of different intensity&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Mean shift (intensity shift)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Contrast change&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Multiplicative Gaussian noise&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Comfort noise&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Lossy compression of noisy images&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Image color quantization with dither&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Chromatic aberrations&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Sparse sampling and reconstruction&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">name_list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">22</span><span class="p">):</span>
            <span class="n">edgecolor</span> <span class="o">=</span> <span class="n">edgecolor_list</span><span class="p">[</span><span class="n">j</span> <span class="o">%</span> <span class="mi">5</span><span class="p">]</span>
            <span class="n">facecolor</span> <span class="o">=</span> <span class="n">facecolor_list</span><span class="p">[</span><span class="n">j</span> <span class="o">//</span> <span class="mi">5</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">facecolor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">facecolor</span> <span class="o">=</span> <span class="n">edgecolor</span>
                <span class="n">edgecolor</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                <span class="n">distance</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                <span class="n">mos_values</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                <span class="n">edgecolors</span><span class="o">=</span><span class="n">edgecolor</span><span class="p">,</span>
                <span class="n">facecolors</span><span class="o">=</span><span class="n">facecolor</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="n">shape_list</span><span class="p">[</span><span class="n">j</span> <span class="o">//</span> <span class="mi">5</span><span class="p">],</span>
                <span class="n">label</span><span class="o">=</span><span class="n">distortion_names</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="n">pearsonr_value</span> <span class="o">=</span> <span class="n">pearsonr</span><span class="p">(</span><span class="o">-</span><span class="n">mos_values</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">distance</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">spearmanr_value</span> <span class="o">=</span> <span class="n">spearmanr</span><span class="p">(</span><span class="o">-</span><span class="n">mos_values</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">distance</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;pearson </span><span class="si">{</span><span class="n">pearsonr_value</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, spearman </span><span class="si">{</span><span class="n">spearmanr_value</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Mean Opinion Score&quot;</span><span class="p">)</span>
    <span class="n">lines</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower center&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">rmse</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">img2</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">img1</span> <span class="o">-</span> <span class="n">img2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">one_minus_ssim</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">img2</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">po</span><span class="o">.</span><span class="n">metric</span><span class="o">.</span><span class="n">ssim</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">img2</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">one_minus_msssim</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">img2</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">po</span><span class="o">.</span><span class="n">metric</span><span class="o">.</span><span class="n">ms_ssim</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">img2</span><span class="p">)</span>


<span class="c1"># This takes some minutes to run</span>
<span class="n">correlate_with_tid</span><span class="p">(</span>
    <span class="n">func_list</span><span class="o">=</span><span class="p">[</span><span class="n">rmse</span><span class="p">,</span> <span class="n">one_minus_ssim</span><span class="p">,</span> <span class="n">one_minus_msssim</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">metric</span><span class="o">.</span><span class="n">nlpd</span><span class="p">],</span>
    <span class="n">name_list</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;RMSE&quot;</span><span class="p">,</span> <span class="s2">&quot;1 - SSIM&quot;</span><span class="p">,</span> <span class="s2">&quot;1 - (MS-SSIM)&quot;</span><span class="p">,</span> <span class="s2">&quot;NLPD&quot;</span><span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "4a702a312ba540f48beab204e7117535"}</script><img alt="../../_images/f2d10091f7a2273f34e7a1f404fe71c3cb351c79b34fd4eb4183b863de794d99.png" src="../../_images/f2d10091f7a2273f34e7a1f404fe71c3cb351c79b34fd4eb4183b863de794d99.png" />
</div>
</div>
<p>Each point in the figures is a distorted image, and the color/shape indicates the distortion type. The goodness of the perceptual distance metrics can be qualitatively assessed by looking at how well the points follow a monotonic function, and how straight this monotonic function is. We can see that points for RMSE and 1-SSIM are more scattered than 1-(MS-SSIM) and NLPD. The points for NLPD follows a much straighter line than other methods. The points for RMSE have outliers belonging to certain distortion types, notably mean shift and contrast change, while all three perceptual distance metrics are able to handle them better.</p>
<p>For a quantitative comparison, we calculate the Pearson’s and Spearman’s correlation coefficient between mean opinion score and each perceptual distance metric (shown above the figures). Pearson’s correlation measures linear relationship, while Spearman’s correlation allows a nonlinear relationship since it only depends on ranking. We can see that the performance of the metrics, as measured by the correlation coefficients, is: NLPD &gt; MS-SSIM &gt; SSIM &gt; RMSE.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../intro/Metamer.html" class="btn btn-neutral float-left" title="Metamers" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Portilla_Simoncelli.html" class="btn btn-neutral float-right" title="Portilla-Simoncelli Texture Metamer" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019-2025, Plenoptic authors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>